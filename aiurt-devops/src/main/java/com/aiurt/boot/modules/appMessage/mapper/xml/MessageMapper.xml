<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.modules.appMessage.mapper.MessageMapper">
	<select id="selectMessagePage" resultType="com.aiurt.boot.modules.appMessage.vo.MessageStatusVO">
		select distinct m.*,
		                r.read_flag as readFlag
		from t_message m
				     left join t_message_read r on r.message_id = m.id
		where r.staff_id =  #{param.userId}
		  and m.create_time between #{param.startTime} and #{param.endTime}
		order by m.id desc, r.read_flag asc
	</select>

	<select id="selectMessageList" resultType="com.aiurt.boot.modules.appMessage.entity.Message">
		select distinct m.*
		from t_message m
				     left join t_message_read r on r.message_id = m.id
		where r.staff_id = #{param.userId}
		  and m.create_time between #{param.startTime} and #{param.endTime}
		  and r.read_flag = 0
		order by m.id desc
				limit #{param.listSize}
	</select>

	<select id="selectMessageUnReadCount" resultType="java.lang.Integer">
		select distinct count(m.id)
		from t_message m
				     left join t_message_read r on r.message_id = m.id
		where r.staff_id = #{param.userId}
		  and m.create_time between #{param.startTime} and #{param.endTime}
		  and r.read_flag = 0
		order by m.id desc
	</select>

	<select id="selectMessageReadCount" resultType="java.lang.Integer">
		select distinct count(m.id)
		from t_message m
				     left join t_message_read r on r.message_id = m.id
		where r.staff_id = #{param.userId}
		  and m.create_time between #{param.startTime} and #{param.endTime}
		  and r.read_flag = 1
		order by m.id desc
	</select>

	<select id="selectUserMessagePage" resultType="com.aiurt.boot.modules.appMessage.vo.MessageUserVO">
		select m.*,
		       group_concat(r.staff_id)   as staffIds,
		       group_concat(r.staff_name) as staffNames
		from t_message m
				     left join t_message_read r on m.id = r.message_id
		where m.del_flag = 0
		  and r.del_flag = 0
		group by m.id
		order by m.id
	</select>
</mapper>
