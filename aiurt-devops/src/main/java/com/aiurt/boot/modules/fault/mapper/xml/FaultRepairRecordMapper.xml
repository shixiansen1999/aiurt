<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.modules.fault.mapper.FaultRepairRecordMapper">


    <select id="queryDetail" resultType="com.aiurt.boot.common.result.FaultRepairRecordResult">
        select * from fault_repair_record where fault_code = #{code}
    </select>

    <select id="queryLastDetail" resultType="com.aiurt.boot.common.result.FaultRepairRecordResult">
        SELECT
	        *
        FROM
	        fault_repair_record
        WHERE
	        fault_code = #{code}
	        AND del_flag = 0
            ORDER BY
	        create_time DESC
	        LIMIT 1
    </select>

    <select id="getWaitMessage" resultType="com.aiurt.boot.common.result.FaultRepairRecordResult">
        select * from fault_repair_record
        where del_flag = 0
        and participate_ids like concat('%', #{userId}, '%')
        and create_time between #{startTime} and #{endTime}
    </select>

    <select id="selectLastRecord" resultType="com.aiurt.boot.common.result.FaultRepairRecordResult">
        select * from fault_repair_record
        where
        appoint_user_id = #{id}
        and fault_code = #{code}
        and del_flag = 0
        order by create_time DESC
        limit 1
    </select>

    <select id="selectDetailById" resultType="com.aiurt.boot.modules.fault.entity.FaultRepairRecord">
        select * from fault_repair_record where id = #{id} and del_flag = '0'
    </select>

    <select id="selectFaultNum" resultType="com.aiurt.boot.modules.statistical.vo.UserAndAmountVO">
        select
        su.realname as userName,count(*) as amount
        from fault_repair_record fr
        left join sys_user su on su.id = fr.create_by
        where
        fr.create_time &gt;= #{startTime}
        and fr.create_time &lt;= #{entTime}
        and fr.del_flag = 0
        <choose>
            <when test="userName != null and userName != ''">
                and su.realname like concat('%',#{userName},'%')
            </when>
            <otherwise>
                <if test='userNameList !=null and userNameList.size > 0'>
                    and fr.create_by IN
                    <foreach collection="userNameList" item="name" index="index" open="(" close=")" separator=",">
                        #{name}
                    </foreach>
                </if>
            </otherwise>
        </choose>
        group by fr.create_by
    </select>

    <select id="getFaultDate" resultType="com.aiurt.boot.common.result.FaultPersonResult">
        SELECT
            fr.fault_time AS startDate,
            fr.create_time AS endDate
        FROM
            fault_repair_record fr
        left join sys_user su on su.id = fr.create_by
        WHERE
        fr.fault_time IS NOT NULL
        and fr.create_time &gt;= #{startTime}
        and fr.create_time &lt;= #{entTime}
        and fr.del_flag = 0
        <if test="userName!=null">
          and su.realname = #{userName}
        </if>
    </select>
</mapper>
