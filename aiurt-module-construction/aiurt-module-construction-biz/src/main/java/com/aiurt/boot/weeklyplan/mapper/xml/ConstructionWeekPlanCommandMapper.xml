<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.weeklyplan.mapper.ConstructionWeekPlanCommandMapper">
    <select id="queryPageList" resultType="com.aiurt.boot.weeklyplan.vo.ConstructionWeekPlanCommandVO">
        select cwpc.*,
               ahp.PROC_INST_ID_ as process_instance_id,
               ara.ID_           as task_id,
               ara.NAME_         as task_name,
               arp.KEY_          as model_key
        from construction_week_plan_command cwpc
                 Left JOIN act_hi_procinst ahp ON ahp.BUSINESS_KEY_ = cwpc.id
                 LEFT join act_ru_task ara ON ara.PROC_INST_ID_ = ahp.PROC_INST_ID_
                 LEFT JOIN act_re_procdef arp on ahp.PROC_DEF_ID_ = arp.ID_
        where cwpc.del_flag = 0
        <if test="condition.lineCode != null and condition.lineCode != ''">
            and ahp.ID_ is not null
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            and cwpc.line_code = #{condition.lineCode}
        </if>
        <if test="condition.starDate != null and condition.endDate != null">
            and DATE_FORMAT(cwpc.task_date, '%Y-%m-%d')
                between DATE_FORMAT(#{condition.starDate}, '%Y-%m-%d')
                and DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.planChange != null">
            and cwpc.plan_change = #{condition.planChange}
        </if>
        <if test="condition.formStatus != null">
            and cwpc.form_status = #{condition.formStatus}
        </if>
        <if test="condition.formStatusList != null and condition.formStatusList.size() != 0">
            and cwpc.form_status in
            <foreach collection="condition.formStatusList" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.planChangeList != null and condition.planChangeList.size() != 0">
            and cwpc.plan_change in
            <foreach collection="condition.planChangeList" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        order by cwpc.create_time desc
    </select>

    <select id="queryById" resultType="com.aiurt.boot.weeklyplan.vo.ConstructionWeekPlanCommandVO">
        select cwpc.*,
        ahp.PROC_INST_ID_ as process_instance_id,
        ara.ID_           as task_id,
        ara.NAME_         as task_name,
        arp.KEY_          as model_key
        from construction_week_plan_command cwpc
        Left JOIN act_hi_procinst ahp ON ahp.BUSINESS_KEY_ = cwpc.id
        LEFT join act_ru_task ara ON ara.PROC_INST_ID_ = ahp.PROC_INST_ID_
        LEFT JOIN act_re_procdef arp on ahp.PROC_DEF_ID_ = arp.ID_
        where cwpc.del_flag = 0
        <!--and ahp.ID_ is not null-->
        <if test="id != null and id != ''">
            and cwpc.id = #{id}
        </if>
    </select>

    <select id="queryWorkToDo" resultType="com.aiurt.boot.weeklyplan.vo.ConstructionWeekPlanCommandVO">
        select cwpc.*,
               ahp.PROC_INST_ID_ as process_instance_id,
               ara.ID_           as task_id,
               ara.NAME_         as task_name,
               arp.KEY_          as model_key
        from construction_week_plan_command cwpc
                 Left JOIN act_hi_procinst ahp ON ahp.BUSINESS_KEY_ = cwpc.id
                 LEFT join act_ru_task ara ON ara.PROC_INST_ID_ = ahp.PROC_INST_ID_
                 LEFT JOIN act_re_procdef arp on ahp.PROC_DEF_ID_ = arp.ID_
        where cwpc.del_flag = 0
          and ahp.ID_ is not null
          and (ara.ASSIGNEE_ = #{userName} OR ara.ID_ in (
            SELECT TASK_ID_
            FROM act_ru_identitylink ari
            WHERE ari.TYPE_ = 'candidate'
              AND ari.USER_ID_ = #{userName}
              AND ari.TASK_ID_ = ara.ID_
              AND (ara.assignee_ = '' or ara.assignee_ is null)
        ))
        <if test="condition.lineCode != null and condition.lineCode != ''">
            and cwpc.line_code = #{condition.lineCode}
        </if>
        <if test="condition.starDate != null and condition.endDate != null">
            and DATE_FORMAT(cwpc.task_date, '%Y-%m-%d')
                between DATE_FORMAT(#{condition.starDate}, '%Y-%m-%d')
                and DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.planChange != null">
            and cwpc.plan_change = #{condition.planChange}
        </if>
        <if test="condition.formStatus != null">
            and cwpc.form_status = #{condition.formStatus}
        </if>
        <if test="condition.formStatusList != null and condition.formStatusList.size() != 0">
            and cwpc.form_status in
            <foreach collection="condition.formStatusList" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        order by cwpc.create_time desc
    </select>
    <select id="selectUserId" resultType="java.lang.String">
        select id from sys_user where del_flag = 0
        and realname = #{name} and phone = #{phone}
    </select>
    <select id="selectUserIdByPermitCode" resultType="java.lang.String">
        select id from sys_user where del_flag = 0
                                  and realname = #{name} and permit_code = #{permitCode}
    </select>

    <select id="getExportData" resultType="com.aiurt.boot.weeklyplan.dto.ConstructionWeekPlanExportDTO">
        select cwpc.*,
               if(cwpc.task_start_time > cwpc.task_end_time,
                  concat_ws('-次日', date_format(cwpc.task_start_time, '%H:%i'),
                            date_format(cwpc.task_end_time, '%H:%i')),
                  concat_ws('-', date_format(cwpc.task_start_time, '%H:%i'),
                            date_format(cwpc.task_end_time, '%H:%i'))) as formatTime,
               group_concat(cca.station_code)                          as assistStationCode
        from construction_week_plan_command cwpc
                 left join construction_command_assist cca on cwpc.id = cca.plan_id
        where del_flag = 0
        <if test="lineCode != null and lineCode != ''">
            and cwpc.line_code = #{lineCode}
        </if>
        <if test="formStatus != null">
            and cwpc.form_status = #{formStatus}
        </if>
        <if test="startDate != null and endDate != null">
            and date_format(cwpc.task_date, '%Y-%m-%d')
                between date_format(#{startDate}, '%Y-%m-%d')
                and date_format(#{endDate}, '%Y-%m-%d')
        </if>
        group by cwpc.id
    </select>

    <select id="selectLineName" resultType="org.jeecg.common.system.vo.DictModel">
        select line.line_name as "value",line.line_code as "text" from construction_week_plan_line line where
            del_flag=0
    </select>
    <select id="selectStationName" resultType="org.jeecg.common.system.vo.DictModel">
        select station.station_code as "value",station.station_name as "text" from construction_week_plan_station station where
            del_flag=0
    </select>
    <select id="selectOrgName" resultType="org.jeecg.common.system.vo.DictModel">
        select org.id as "value",org.depart_name as "text" from construction_week_plan_org org
        where del_flag=0
    </select>

    <insert id="batchInsert" parameterType="com.aiurt.boot.weeklyplan.vo.ConstructionWeekPlanCommandVO">
        insert INTO construction_week_plan_command cwpc
        (weekday,taskDate,taskStaffNum,taskStartTime,taskEndTime,protectiveMeasure,type,orgCode,taskRange,taskContent,largeAppliances,remark,
        assistStationCode,planChange,nature,powerSupplyRequirementContent,firstStationCode,secondStationCode,substationCode,formStatus,applyFormStatus,
        lineFormStatus,dispatchFormStatus,plantype,code)
        VALUES
        <foreach collection="list" item="command" separator=";">
            (
            #{command.weekday},
            #{command.taskDate},
            #{command.taskStaffNum},
            #{command.taskStartTime},
            #{command.taskEndTime},
            #{command.protectiveMeasure},
            #{command.type},
            #{command.orgCode},
            #{command.taskRange},
            #{command.taskContent},
            #{command.largeAppliances},
            #{command.remark},
            #{command.assistStationCode},
            #{command.planChange},
            #{command.nature},
            #{command.powerSupplyRequirementContent},
            #{command.firstStationCode},
            #{command.secondStationCode},
            #{command.substationCode},
            #{command.formStatus},
            #{command.applyFormStatus},
            #{command.lineFormStatus},
            #{command.dispatchFormStatus},
            #{command.plantype},
            #{command.Code})
        </foreach>
    </insert>
</mapper>
