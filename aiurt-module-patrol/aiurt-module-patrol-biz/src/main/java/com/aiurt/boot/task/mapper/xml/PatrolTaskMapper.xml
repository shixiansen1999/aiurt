<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.PatrolTaskMapper">
    <select id="getPatrolTaskPoolList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        select t1.*,(select realname from sys_user where id= t1.end_user_id) as
        endUserName,concat(DATE_FORMAT(t1.start_time,'%H:%i'),"-",DATE_FORMAT(t1.end_time,'%H:%i'))as startEndTime
        from patrol_task t1
        where t1.status not in (6,7,8) and t1.del_flag = 0 and t1.omit_status=0
        and t1.discard_status = 0
        and t1.id not in(select id from patrol_task where source=3 and (`status` =0 or `status`=3))
        <if test="patrolTaskDTO.dateScope !=null and patrolTaskDTO.dateScope !=''">
            and DATE_FORMAT(t1.patrol_date, '%Y-%m-%d' )
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTaskDTO.loginOrgId != null and patrolTaskDTO.loginOrgId != ''">
            and t1.CODE IN ( SELECT t2.task_code FROM patrol_task_organization t2 WHERE t2.task_code = t1.CODE AND
            t2.org_code = #{patrolTaskDTO.loginOrgId})
        </if>
        <if test="patrolTaskDTO.status!=null">
            and t1.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.orgCode!=null and patrolTaskDTO.orgCode!=''">
            AND t1.CODE IN ( SELECT t2.task_code FROM patrol_task_organization t2 WHERE t2.task_code = t1.CODE AND
            t2.org_code = #{patrolTaskDTO.orgCode})
        </if>
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0 AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0 and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        order by t1.create_time desc
    </select>
    <select id="getPatrolTaskList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        select t1.*,(select realname from sys_user where id= t1.end_user_id) as
        endUserName,concat(DATE_FORMAT(t1.start_time,'%H:%i'),"-",DATE_FORMAT(t1.end_time,'%H:%i'))as startEndTime
        from patrol_task t1
        where t1.status in (6,7) and t1.del_flag = 0 and t1.omit_status=0
        and t1.discard_status = 0
        <if test="patrolTaskDTO.loginOrgId != null and patrolTaskDTO.loginOrgId != ''">
            and t1.CODE IN ( SELECT t2.task_code FROM patrol_task_organization t2 WHERE t2.task_code = t1.CODE AND
            t2.org_code = #{patrolTaskDTO.loginOrgId})
        </if>
        <if test="patrolTaskDTO.dateScope !=null and patrolTaskDTO.dateScope !=''">
            and DATE_FORMAT(t1.patrol_date, '%Y-%m-%d' )
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTaskDTO.status!=null">
            and t1.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0 AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0 and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        ORDER BY t1.`status` asc, t1.create_time desc
    </select>
    <select id="getOrganizationName" resultType="java.lang.String">
        SELECT t2.depart_name
        FROM patrol_task_organization t1
                 LEFT JOIN sys_depart t2 ON t1.org_code = t2.org_code and t2.del_flag = 0
        where t1.task_code = #{taskCode}
    </select>
    <select id="getStationName" resultType="com.aiurt.boot.standard.dto.StationDTO">
        SELECT t2.line_code, t1.station_code
        FROM patrol_task_station t1
                 LEFT JOIN cs_station t2 ON t1.station_code = t2.station_code and t2.del_flag = 0
        WHERE t1.task_code = #{code}
    </select>
    <select id="getTaskList" resultType="com.aiurt.boot.task.param.PatrolTaskParam">
        SELECT
        pt.*
        FROM
        patrol_task pt
        WHERE
        pt.del_flag = 0
        <if test='patrolTask.identify != null and patrolTask.identify == "1" '>
            and pt.id not in(select id from patrol_task where source=3 and (`status` =0 or `status`=3))
        </if>
        <if test="patrolTask.name != null and patrolTask.name != ''">
            and pt.name like concat('%',#{patrolTask.name},'%')
        </if>
        <if test="patrolTask.code != null and patrolTask.code != ''">
            and pt.code like concat('%',#{patrolTask.code},'%')
        </if>
        <if test="patrolTask.statusArray != null">
            and pt.status in
            <foreach collection="patrolTask.statusArray" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="patrolTask.status != null">
            and pt.status = #{patrolTask.status}
        </if>
        <if test="patrolTask.omitStatus != null">
            and pt.omit_status = #{patrolTask.omitStatus}
        </if>
        <if test="patrolTask.source != null">
            and pt.source = #{patrolTask.source}
        </if>
        <if test="patrolTask.discardStatus != null">
            and pt.discard_status = #{patrolTask.discardStatus}
        </if>
        <if test="patrolTask.organizationCode != null and patrolTask.organizationCode != ''">
            and pt.code in (
            SELECT ppo.task_code
            FROM patrol_task_organization ppo
            WHERE ppo.del_flag = 0 and ppo.org_code = #{patrolTask.organizationCode}
            )
        </if>
        <if test="patrolTask.stationCode != null and patrolTask.stationCode != ''">
            <choose>
                <when test="patrolTask.level != null and patrolTask.level == 1 ">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0 AND cs.line_code = #{patrolTask.stationCode}
                    )
                </when>
                <when test="patrolTask.level != null and patrolTask.level == 2 ">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0 and pps.station_code = #{patrolTask.stationCode}
                    )
                </when>
            </choose>
        </if>
        <if test="patrolTask.dateHead != null and patrolTask.dateEnd != null">
            AND DATE_FORMAT( pt.patrol_date, '%Y-%m-%d' )
            BETWEEN DATE_FORMAT( #{patrolTask.dateHead}, '%Y-%m-%d' )
            AND DATE_FORMAT( #{patrolTask.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTask.submitDateHead != null and patrolTask.submitDateEnd != null">
            AND DATE_FORMAT( pt.submit_time, '%Y-%m-%d' )
            BETWEEN DATE_FORMAT( #{patrolTask.submitDateHead}, '%Y-%m-%d' )
            AND DATE_FORMAT( #{patrolTask.submitDateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTask.patrolDate != null and patrolTask.patrolDate != null">
            AND DATE_FORMAT( pt.patrol_date, '%Y-%m-%d' ) = DATE_FORMAT(#{patrolTask.patrolDate}, '%Y-%m-%d' )
        </if>
        order by pt.create_time desc
    </select>
    <select id="getUserName" resultType="java.lang.String">
        select realname
        from sys_user
        where id = #{patrolReturnUserId}
    </select>
    <select id="getOrgCode" resultType="java.lang.String">
        SELECT t1.org_code
        FROM patrol_task_organization t1
        WHERE t1.task_code = #{taskCode}
    </select>
    <select id="getUser" resultType="com.aiurt.boot.task.dto.PatrolTaskUserContentDTO">
        select t1.realname as realname,
               t1.id,
               t1.org_code
        from sys_user t1
        where t1.org_code = #{code}
          and t1.del_flag = 0
    </select>
    <select id="getOrgName" resultType="java.lang.String">
        select t2.depart_name
        from sys_depart t2
        where t2.org_code = #{code}
    </select>
    <select id="selectBasicInfo" resultType="com.aiurt.boot.task.param.PatrolTaskParam">
        SELECT *
        FROM patrol_task pt
        WHERE pt.del_flag = 0
        <if test="patrolTaskParam.id != null and patrolTaskParam.id != ''">
            and pt.id = #{patrolTaskParam.id}
        </if>
    </select>
    <select id="getPatrolTaskManualList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        SELECT
        t1.*
        FROM
        patrol_task t1
        where t1.source = 3 and t1.status in (0,3) and t1.discard_status = 0 and t1.omit_status=0
        <!--        and t1.CODE IN ( SELECT t2.task_code FROM patrol_task_organization t2 WHERE t2.task_code = t1.CODE AND-->
        <!--            t2.org_code = #{patrolTaskDTO.loginOrgId})-->
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0 AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2 ">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0 and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        <if test="patrolTaskDTO.orgCode != null and patrolTaskDTO.orgCode!=''">
            and t1.code in (SELECT t2.task_code FROM patrol_task_organization t2 where t2.org_code =
            #{patrolTaskDTO.orgCode})
        </if>
        <if test="patrolTaskDTO.name!=null and patrolTaskDTO.name!=''">
            and t1.name like concat('%',#{patrolTaskDTO.name},'%')
        </if>
        <if test="patrolTaskDTO.code!=null and patrolTaskDTO.code!=''">
            and t1.code like concat('%',#{patrolTaskDTO.code},'%')
        </if>
        <if test="patrolTaskDTO.status !=null">
            and t1.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.dateScope !=null">
            and DATE_FORMAT(t1.patrol_date, '%Y-%m-%d' )
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
        order by t1.create_time desc
    </select>
    <select id="getMajorNameByMajorCode" resultType="java.lang.String">
        SELECT
        cm.major_name
        FROM
        cs_major cm
        WHERE
        cm.del_flag = 0
        <if test="code !=null and code !=''">
            AND cm.major_code = #{code}
        </if>
    </select>
    <select id="getSubsystemNameBySystemCode" resultType="java.lang.String">
        SELECT
        cs.system_name
        FROM
        cs_subsystem cs
        WHERE
        cs.del_flag = 0
        <if test="code !=null and code !=''">
            AND cs.system_code = #{code}
        </if>
    </select>
    <select id="getUsername" resultType="java.lang.String">
        SELECT su.realname
        FROM sys_user su
        WHERE su.del_flag = 0
          AND su.id = #{userId}
    </select>
    <select id="getMajorSubsystemGanged" resultType="com.aiurt.boot.task.dto.SubsystemDTO">
        SELECT
        cs.system_code subsystemCode,
        cs.system_name subsystemName
        FROM cs_subsystem cs
        WHERE
        <if test="majorCode !=null and majorCode !=''">
            cs.major_code = #{majorCode}
        </if>
        <if test="subsystemList !=null and subsystemList.size()>0">
            AND cs.system_code IN
            <foreach collection="subsystemList" item="item" open="(" separator="," close=")">
                #{item.subsystemCode}
            </foreach>
        </if>
    </select>
    <select id="getStationCode" resultType="java.lang.String">
        select station_code
        from patrol_task_station
        where task_code = #{code}
    </select>
    <select id="getLineCode" resultType="java.lang.String">
        SELECT
        line_code
        FROM
        cs_station
        WHERE
        del_flag = 0
        <if test="stationCode !=null and stationCode !=''">
            AND station_code = #{stationCode}
        </if>
    </select>
    <select id="getIndexPatrolList" resultType="com.aiurt.boot.statistics.model.PatrolIndexTask">
        SELECT sub.*
        FROM
        ( SELECT
        pts.station_code,
        cs.station_name,
        cs.line_code,
        cs.line_name,
        GROUP_CONCAT( pt.`code` ) taskCode,
        MAX( pt.submit_time ) submitTime
        <if test="regexp !=null and regexp !=''">
            ,IF(GROUP_CONCAT(DISTINCT pt.`status`) REGEXP #{regexp}, 1, 0) `status`
        </if>
        FROM patrol_task pt
        JOIN patrol_task_station pts ON pt.`code` = pts.task_code
        JOIN cs_station cs ON pts.station_code = cs.station_code
        WHERE pt.del_flag = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT( pt.patrol_date, '%Y-%m-%d' )
            BETWEEN DATE_FORMAT( #{condition.startDate}, '%Y-%m-%d' )
            AND DATE_FORMAT( #{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.status != null and condition.status.length>0">
            AND pt.`status` IN
            <foreach collection="condition.status" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="departList != null and departList.size>0">
            AND pt.`code` in (
            SELECT task_code FROM patrol_task_organization WHERE del_flag = 0
            AND org_code IN
            <foreach collection="departList" item="item" open="(" separator="," close=")">
                #{item.orgCode}
            </foreach>
            )
        </if>
        <if test="condition.omitStatus != null">
            AND pt.omit_status = #{condition.omitStatus}
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND pts.station_code = #{condition.stationCode}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND cs.line_code = #{condition.lineCode}
        </if>
        GROUP BY
        pts.station_code
        ) sub
        <if test="condition.finishStatus != null">
            where sub.`status` = #{condition.finishStatus}
        </if>

    </select>
    <select id="getIndexTaskList" resultType="com.aiurt.boot.statistics.model.IndexTaskInfo">
        SELECT pt.`name`, pt.abnormal_state, pt.`code`, pt.`status`, pt.submit_time
        FROM patrol_task pt
        WHERE pt.del_flag = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT( pt.patrol_date, '%Y-%m-%d' )
            BETWEEN DATE_FORMAT( #{condition.startDate}, '%Y-%m-%d' )
            AND DATE_FORMAT( #{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.state != null">
            AND pt.abnormal_state = #{condition.state}
        </if>
        <!--        <if test="condition.taskCode != null and condition.taskCode.size>0">-->
        <!--            AND pt.`code` IN-->
        <!--            <foreach collection="condition.taskCode" item="item" open="(" separator="," close=")">-->
        <!--                #{item}-->
        <!--            </foreach>-->
        <!--        </if>-->
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND pt.`code` IN ( SELECT task_code FROM patrol_task_station WHERE station_code = #{condition.stationCode})
        </if>
        <if test="condition.status != null and condition.status.length>0">
            AND pt.`status` IN
            <foreach collection="condition.status" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.omitStatus != null">
            AND pt.omit_status = #{condition.omitStatus}
        </if>
        <if test="condition.username != null and condition.username != ''">
            AND pt.`code` IN ( SELECT task_code FROM patrol_task_user WHERE user_name
            LIKE CONCAT('%',#{condition.username},'%'))
        </if>
        <if test="condition.orgCode != null and condition.orgCode != ''">
            AND pt.`code` IN ( SELECT task_code FROM patrol_task_organization WHERE org_code = #{condition.orgCode})
        </if>
        <if test="departList != null and departList.size>0">
            AND pt.`code` in (
            SELECT task_code FROM patrol_task_organization WHERE del_flag = 0
            AND org_code IN
            <foreach collection="departList" item="item" open="(" separator="," close=")">
                #{item.orgCode}
            </foreach>
            )
        </if>
    </select>
    <select id="getScheduleList" resultType="com.aiurt.boot.statistics.model.ScheduleTask">
        SELECT
        pt.`name`,
        pt.`code`,
        pt.`status`,
        pt.patrol_date,
        IF( 1 = pt.auditor, pt.auditor_time, pt.submit_time ) submitTime,
        GROUP_CONCAT( DISTINCT ptu.user_name ) userInfo,
        GROUP_CONCAT( DISTINCT cs.station_name ) stationInfo,
        GROUP_CONCAT( DISTINCT sd.depart_name ) orgInfo
        FROM
        patrol_task pt
        LEFT JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code
        AND ptu.del_flag = 0
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code
        AND pts.del_flag = 0
        LEFT JOIN cs_station cs ON pts.station_code = cs.station_code
        AND cs.del_flag = 0
        LEFT JOIN patrol_task_organization pto ON pt.`code` = pto.task_code
        AND pto.del_flag = 0
        LEFT JOIN sys_depart sd ON pto.org_code = sd.org_code
        AND sd.del_flag = 0
        WHERE
        pt.del_flag = 0
        <if test="condition.date != null">
            AND DATE_FORMAT( pt.patrol_date, '%Y-%m-%d' ) = DATE_FORMAT(#{condition.date} , '%Y-%m-%d' )
        </if>
        <if test="condition.source != null">
            and pt.source = #{condition.source}
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            and pt.`code` in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            WHERE pps.del_flag = 0 and pps.station_code = #{condition.stationCode}
            )
        </if>
        <if test="departList != null and departList.size>0">
            AND pt.`code` in (
            SELECT task_code FROM patrol_task_organization WHERE del_flag = 0
            AND org_code IN
            <foreach collection="departList" item="item" open="(" separator="," close=")">
                #{item.orgCode}
            </foreach>
            )
        </if>
        GROUP BY pt.`code`
    </select>
    <select id="getOverviewInfo" resultType="com.aiurt.boot.task.entity.PatrolTask">
        SELECT pt.*
        FROM patrol_task pt
        WHERE pt.del_flag = 0
        <if test="startDate != null and endDate != null">
            AND pt.patrol_date BETWEEN #{condition.startDate} AND #{condition.endDate}
        </if>
        <if test="departList != null and departList.size>0">
            AND pt.`code` in (
            SELECT task_code FROM patrol_task_organization WHERE del_flag = 0
            AND org_code IN
            <foreach collection="departList" item="item" open="(" separator="," close=")">
                #{item.orgCode}
            </foreach>
            )
        </if>
    </select>
    <select id="getUserTask" resultType="com.aiurt.boot.task.entity.PatrolTask">
    SELECT
	pt.id,pt.`code`,pt.`name`
FROM
	patrol_task_user ptu
	LEFT JOIN patrol_task pt on ptu.task_code = pt.`code`
WHERE
	DATE_FORMAT( ptu.create_time, '%Y-%m-%d' ) = DATE_FORMAT(#{date} ,'%Y-%m-%d' )
	and ptu.user_id = #{userId}
</select>
</mapper>
