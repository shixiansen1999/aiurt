<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.PatrolTaskMapper">
    <select id="getPatrolTaskPoolList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        SELECT
        DISTINCT
        t1.*
        FROM
        (
        SELECT
        t1.*,
        date_format( t1.create_time, '%Y-%m-%d' ) AS creatTime,
        GROUP_CONCAT( DISTINCT cl.sort ) AS lineSort,
        SUBSTRING_INDEX( GROUP_CONCAT( DISTINCT cs.sort ), ',', 1 ) * 1 AS stationSort,
        concat(
        DATE_FORMAT( t1.start_time, '%H:%i' ),
        "-",
        DATE_FORMAT( t1.end_time, '%H:%i' )) AS startEndTime
        FROM
        patrol_task t1
        LEFT JOIN patrol_task_station pts ON t1.`code` = pts.task_code
        LEFT JOIN cs_station cs ON (pts.station_code = cs.station_code AND cs.del_flag = 0 )
        LEFT JOIN cs_line cl ON( cs.line_code = cl.line_code AND cl.del_flag = 0 )
        WHERE
        t1.STATUS NOT IN ( 6, 7, 8 )
        AND t1.del_flag = 0
        AND t1.omit_status = 0
        AND t1.discard_status = 0
        <if test="patrolTaskDTO.lineCode != null and patrolTaskDTO.lineCode !=''">
            AND cl.line_code = #{patrolTaskDTO.lineCode}
        </if>
        AND t1.id NOT IN (
        SELECT
        id
        FROM
        patrol_task
        WHERE
        source = 3
        AND ( `status` = 0 OR `status` = 3 ))
        GROUP BY
        t1.id
        ) AS t1
        LEFT JOIN patrol_task_organization pto ON t1.`code` = pto.task_code AND pto.del_flag = 0
        where 1=1
        <if test="patrolTaskDTO.dateScope != null and patrolTaskDTO.dateScope != ''">
            and DATE_FORMAT(t1.patrol_date, '%Y-%m-%d')
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTaskDTO.userHaveOrgCodeList != null and patrolTaskDTO.userHaveOrgCodeList.size() > 0">
            and t1.CODE IN
            (
            SELECT t2.task_code
            FROM patrol_task_organization t2
            WHERE t2.task_code = t1.CODE
            AND t2.org_code in
            <foreach collection="patrolTaskDTO.userHaveOrgCodeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
            )
        </if>
        <if test="patrolTaskDTO.taskCodes != null and patrolTaskDTO.taskCodes.size() > 0">
            AND t1.code IN
            <foreach collection="patrolTaskDTO.taskCodes" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
        <if test="patrolTaskDTO.status != null">
            and t1.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.orgCode != null and patrolTaskDTO.orgCode != ''">
            AND t1.CODE IN (SELECT t2.task_code
            FROM patrol_task_organization t2
            WHERE t2.task_code = t1.CODE
            AND t2.org_code = #{patrolTaskDTO.orgCode})
        </if>
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0
                    AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0
                    and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        ORDER BY
        t1.creatTime DESC,
        t1.lineSort ASC,
        t1.stationSort ASC;
    </select>
    <select id="getPatrolTaskList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        select DISTINCT t1.id,
        t1.code,
        t1.name,
        t1.patrol_date,
        t1.start_time,
        t1.end_time,
        t1.type,
        t1.status,
        t1.end_user_id,
        t1.submit_time,
        t1.source,
        t1.period,
        t1.sign_url,
<!--        (select realname from sys_user where id = t1.end_user_id) as-->
<!--        endUserName,-->
        concat(DATE_FORMAT(t1.start_time, '%H:%i'), "-", DATE_FORMAT(t1.end_time, '%H:%i')) as startEndTime
        from patrol_task t1
        LEFT JOIN patrol_task_organization pto ON t1.`code` = pto.task_code AND pto.del_flag = 0
        where t1.status in (6, 7)
        and t1.del_flag = 0
        and t1.omit_status = 0
        and t1.discard_status = 0
        <if test="patrolTaskDTO.userHaveOrgCodeList != null and patrolTaskDTO.userHaveOrgCodeList.size() > 0">
            and t1.CODE IN
            (
            SELECT t2.task_code
            FROM patrol_task_organization t2
            WHERE t2.task_code = t1.CODE
            AND t2.org_code in
            <foreach collection="patrolTaskDTO.userHaveOrgCodeList" separator="," open="(" close=")" item="item">
                #{item}
            </foreach>
            )
        </if>
        <if test="patrolTaskDTO.dateScope != null and patrolTaskDTO.dateScope != ''">
            and DATE_FORMAT(t1.patrol_date, '%Y-%m-%d')
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTaskDTO.status != null">
            and t1.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0
                    AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2">
                    and t1.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0
                    and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        <if test="patrolTaskDTO.taskCodes != null and patrolTaskDTO.taskCodes.size() > 0">
            and t1.code in
            <foreach collection="patrolTaskDTO.taskCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ORDER BY t1.`status` asc, t1.create_time desc
    </select>
    <select id="getOrganizationName" resultType="java.lang.String">
        SELECT t2.depart_name
        FROM patrol_task_organization t1
                 LEFT JOIN sys_depart t2 ON t1.org_code = t2.org_code and t2.del_flag = 0
        where t1.task_code = #{taskCode}
    </select>
    <select id="getStationName" resultType="com.aiurt.boot.standard.dto.StationDTO">
        SELECT t2.line_code,
               t1.station_code,
               t2.sort as stationSort,
               t3.sort AS lineSort
        FROM patrol_task_station t1
                 LEFT JOIN cs_station t2 ON t1.station_code = t2.station_code
                 LEFT JOIN cs_line t3 ON t3.line_code = t2.line_code
            AND t2.del_flag = 0
            AND t3.del_flag = 0
        WHERE t1.task_code = #{code}
        ORDER BY t3.sort asc,
                 t2.sort ASC;
    </select>
    <select id="getTaskList" resultType="com.aiurt.boot.task.param.PatrolTaskParam">
        select pt.id,
        pt.`code`,
        <!--pt.plan_code,-->
        pt.`name`,
        <!--pt.type,-->
        <!--pt.outsource,-->
        <!--pt.plan_order_code,-->
        <!--pt.plan_order_code_url,-->
        <!--pt.period,-->
        pt.patrol_date,
        pt.start_time,
        pt.end_time,
        pt.source,
        <!--pt.begin_time,-->
        pt.submit_time,
        <!--pt.end_user_id,-->
        <!--pt.sign_url,-->
        pt.`status`,
        <!--pt.reject_reason,-->
        <!--pt.auditor,-->
        <!--pt.auditor_id,-->
        pt.auditor_time,
        <!--pt.auditor_remark,-->
        <!--pt.abnormal_state,-->
        pt.dispose_status,
        pt.dispose_time,
        pt.dispose_id,
        pt.omit_status,
        <!--pt.omit_explain,-->
        <!--pt.back_id,-->
        <!--pt.back_reason,-->
        <!--pt.assign_id,-->
        pt.discard_status,
        <!--pt.discard_reason,-->
        pt.`rebuild`,
        pt.remark,
        pt.spot_check_status
        from patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and pts.del_flag = 0
        where pt.del_flag = 0
        <if test='patrolTask.identify != null and patrolTask.identify == "1"'>
            and pt.id not in (select id from patrol_task where source = 3 and (`status` = 0 or `status` = 3))
        </if>
        <if test="patrolTask.name != null and patrolTask.name != ''">
            and pt.name like concat('%', #{patrolTask.name}, '%')
        </if>
        <if test="patrolTask.code != null and patrolTask.code != ''">
            and pt.code like concat('%', #{patrolTask.code}, '%')
        </if>
        <if test="patrolTask.codeList != null">
            and pt.code in
            <foreach collection="patrolTask.codeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="patrolTask.statusArray != null">
            and pt.status in
            <foreach collection="patrolTask.statusArray" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="patrolTask.status != null">
            and pt.status = #{patrolTask.status}
        </if>
        <if test="patrolTask.omitStatus != null">
            and pt.omit_status = #{patrolTask.omitStatus}
        </if>
        <if test="patrolTask.source != null">
            and pt.source = #{patrolTask.source}
        </if>
        <if test="patrolTask.discardStatus != null">
            and pt.discard_status = #{patrolTask.discardStatus}
        </if>
        <if test="patrolTask.organizationCode != null and patrolTask.organizationCode != ''">
            and pt.code in (
            SELECT ppo.task_code
            FROM patrol_task_organization ppo
            WHERE ppo.del_flag = 0
            and ppo.org_code = #{patrolTask.organizationCode}
            )
        </if>
        <if test="patrolTask.stationCode != null and patrolTask.stationCode != ''">
            <choose>
                <when test="patrolTask.level != null and patrolTask.level == 1">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0
                    AND cs.line_code = #{patrolTask.stationCode}
                    )
                </when>
                <when test="patrolTask.level != null and patrolTask.level == 2">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0
                    and pps.station_code = #{patrolTask.stationCode}
                    )
                </when>
            </choose>
        </if>
        <if test="patrolTask.dateHead != null and patrolTask.dateEnd != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')
            BETWEEN DATE_FORMAT(#{patrolTask.dateHead}, '%Y-%m-%d')
            AND DATE_FORMAT(#{patrolTask.dateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTask.submitDateHead != null and patrolTask.submitDateEnd != null">
            AND DATE_FORMAT(pt.submit_time, '%Y-%m-%d')
            BETWEEN DATE_FORMAT(#{patrolTask.submitDateHead}, '%Y-%m-%d')
            AND DATE_FORMAT(#{patrolTask.submitDateEnd}, '%Y-%m-%d')
        </if>
        <if test="patrolTask.patrolDate != null and patrolTask.patrolDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') = DATE_FORMAT(#{patrolTask.patrolDate}, '%Y-%m-%d')
        </if>
        GROUP BY pt.id
        order by
        <if test='patrolTask.identify != null and patrolTask.identify == "2"'>
            pt.`status` asc,
        </if>
        pt.create_time desc
    </select>
    <select id="getUserName" resultType="java.lang.String">
        select realname
        from sys_user
        where id = #{patrolReturnUserId}
    </select>
    <select id="getOrgCode" resultType="java.lang.String">
        SELECT t1.org_code
        FROM patrol_task_organization t1
        WHERE t1.task_code = #{taskCode}
    </select>
    <select id="getUser" resultType="com.aiurt.boot.task.dto.PatrolTaskUserContentDTO">
        select t1.realname as realname,
               t1.id,
               t1.org_code
        from sys_user t1
        where t1.org_code = #{code}
          and t1.del_flag = 0
    </select>
    <select id="getOrgName" resultType="java.lang.String">
        select t2.depart_name
        from sys_depart t2
        where t2.org_code = #{code}
    </select>
    <select id="selectBasicInfo" resultType="com.aiurt.boot.task.param.PatrolTaskParam">
        SELECT *
        FROM patrol_task pt
        WHERE pt.del_flag = 0
        <if test="patrolTaskParam.id != null and patrolTaskParam.id != ''">
            and pt.id = #{patrolTaskParam.id}
        </if>
    </select>
    <select id="getPatrolTaskManualList" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        select pt.id,
        pt.`code`,
        <!--pt.plan_code,-->
        pt.`name`,
        pt.type,
        <!--pt.outsource,-->
        <!--pt.plan_order_code,-->
        <!--pt.plan_order_code_url,-->
        <!--pt.period,-->
        pt.patrol_date,
        pt.start_time,
        pt.end_time,
        <!--pt.source,-->
        <!--pt.begin_time,-->
        <!--pt.submit_time,-->
        <!--pt.end_user_id,-->
        <!--pt.sign_url,-->
        pt.`status`,
        <!--pt.reject_reason,-->
        pt.auditor,
        <!--pt.auditor_id,-->
        <!--pt.auditor_time,-->
        <!--pt.auditor_remark,-->
        <!--pt.abnormal_state,-->
        <!--pt.dispose_status,-->
        <!--pt.dispose_time,-->
        <!--pt.dispose_id,-->
        <!--pt.omit_status,-->
        <!--pt.omit_explain,-->
        <!--pt.back_id,-->
        <!--pt.back_reason,-->
        <!--pt.assign_id,-->
        <!--pt.discard_status,-->
        <!--pt.discard_reason,-->
        <!--pt.`rebuild`,-->
        pt.remark,
        pt.standard_duration
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and pts.del_flag = 0
        where pt.source = 3
        and pt.status in (0, 3)
        and pt.discard_status = 0
        and pt.omit_status = 0
        and pt.del_flag = 0
        <!--        and t1.CODE IN ( SELECT t2.task_code FROM patrol_task_organization t2 WHERE t2.task_code = t1.CODE AND-->
        <!--            t2.org_code = #{patrolTaskDTO.loginOrgId})-->
        <if test="patrolTaskDTO.stationCode != null and patrolTaskDTO.stationCode != ''">
            <choose>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 1">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    JOIN cs_station cs ON pps.station_code = cs.station_code
                    AND cs.del_flag = 0
                    WHERE pps.del_flag = 0
                    AND cs.line_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
                <when test="patrolTaskDTO.level != null and patrolTaskDTO.level == 2">
                    and pt.code in (
                    SELECT pps.task_code
                    FROM patrol_task_station pps
                    WHERE pps.del_flag = 0
                    and pps.station_code = #{patrolTaskDTO.stationCode}
                    )
                </when>
            </choose>
        </if>
        <if test="patrolTaskDTO.orgCode != null and patrolTaskDTO.orgCode != ''">
            and pt.code in (SELECT t2.task_code
            FROM patrol_task_organization t2
            where t2.org_code =
            #{patrolTaskDTO.orgCode})
        </if>
        <if test="patrolTaskDTO.name != null and patrolTaskDTO.name != ''">
            and pt.name like concat('%', #{patrolTaskDTO.name}, '%')
        </if>
        <if test="patrolTaskDTO.code != null and patrolTaskDTO.code != ''">
            and pt.code like concat('%', #{patrolTaskDTO.code}, '%')
        </if>
        <if test="patrolTaskDTO.status != null">
            and pt.status = #{patrolTaskDTO.status}
        </if>
        <if test="patrolTaskDTO.dateScope != null">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')
            between DATE_FORMAT(#{patrolTaskDTO.dateHead}, '%Y-%m-%d')
            and DATE_FORMAT(#{patrolTaskDTO.dateEnd}, '%Y-%m-%d')
        </if>
<!--        <if test="patrolTaskDTO.taskCodes != null and patrolTaskDTO.taskCodes.size() > 0">-->
<!--            and pt.code in-->
<!--            <foreach collection="patrolTaskDTO.taskCodes" item="item" separator="," open="(" close=")">-->
<!--                #{item}-->
<!--            </foreach>-->
<!--        </if>-->
        GROUP BY pt.id
        order by pt.create_time desc
    </select>
    <select id="getMajorNameByMajorCode" resultType="java.lang.String">
        SELECT cm.major_name
        FROM cs_major cm
        WHERE
        cm.del_flag = 0
        <if test="code != null and code != ''">
            AND cm.major_code = #{code}
        </if>
    </select>
    <select id="getSubsystemNameBySystemCode" resultType="java.lang.String">
        SELECT cs.system_name
        FROM cs_subsystem cs
        WHERE
        cs.del_flag = 0
        <if test="code != null and code != ''">
            AND cs.system_code = #{code}
        </if>
    </select>
    <select id="getUsername" resultType="java.lang.String">
        SELECT su.realname
        FROM sys_user su
        WHERE su.del_flag = 0
          AND su.id = #{userId}
    </select>
    <select id="getMajorSubsystemGanged" resultType="com.aiurt.boot.task.dto.SubsystemDTO">
        SELECT cs.system_code subsystemCode,
        cs.system_name subsystemName
        FROM cs_subsystem cs
        WHERE
        <if test="majorCode != null and majorCode != ''">
            cs.major_code = #{majorCode}
        </if>
        <if test="subsystemList != null and subsystemList.size() > 0">
            AND cs.system_code IN
            <foreach collection="subsystemList" item="item" open="(" separator="," close=")">
                #{item.subsystemCode}
            </foreach>
        </if>
    </select>
    <select id="getStationCode" resultType="java.lang.String">
        select station_code
        from patrol_task_station
        where task_code = #{code}
    </select>
    <select id="getLineCode" resultType="java.lang.String">
        SELECT line_code
        FROM cs_station
        WHERE
        del_flag = 0
        <if test="stationCode != null and stationCode != ''">
            AND station_code = #{stationCode}
        </if>
    </select>
    <select id="getIndexPatrolList" resultType="com.aiurt.boot.statistics.model.PatrolIndexTask">
        SELECT sub.*
        FROM
        ( SELECT
        pts.station_code,
        cs.station_name,
        cs.line_code,
        cs.line_name,
        GROUP_CONCAT(DISTINCT pt.`code`) taskCode,
        IF(MIN(pt.`status`) = 7, '已完成', '未完成') statusName,
        MAX(pt.submit_time) submitTime
        <if test="regexp != null and regexp != ''">
            ,IF(GROUP_CONCAT(DISTINCT pt.`status`) REGEXP #{regexp}, 1, 0) `status`
        </if>
        FROM patrol_task pt
        JOIN patrol_task_station pts ON pt.`code` = pts.task_code and pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code and cs.del_flag = 0
        left join patrol_task_organization pto on pt.`code` = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        WHERE pt.del_flag = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')
                    BETWEEN DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
                    AND DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.omitStatus != null">
            AND pt.omit_status = #{condition.omitStatus}
            AND pt.discard_status != #{condition.discardStatus}
        </if>
        <if test="condition.jointSQL != null and condition.jointSQL != ''">
             and ${condition.jointSQL}
        </if>
        GROUP BY pts.station_code
        <if test="condition.type != null and condition.type == 1">
            HAVING MAX(pt.`status`) = 7
        </if>
        <if test="condition.type != null and condition.type == 2">
            HAVING MIN( pt.`status` ) &lt;&gt; 7
        </if>
        ) sub
        <where>
            1=1
            <if test="condition.finishStatus != null">
                AND sub.`status` = #{condition.finishStatus}
            </if>
            <if test="condition.stationCode != null and condition.stationCode != ''">
                AND sub.station_code = #{condition.stationCode}
            </if>
            <if test="condition.lineCode != null and condition.lineCode != ''">
                AND sub.line_code = #{condition.lineCode}
            </if>
        </where>

    </select>
    <select id="getIndexTaskList" resultType="com.aiurt.boot.statistics.model.IndexTaskInfo">
        SELECT pt.id,pt.`name`, pt.abnormal_state, pt.`code`, pt.`status`, pt.submit_time,pt.mac_status
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        WHERE pt.del_flag = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')
            BETWEEN DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.state != null">
            AND pt.abnormal_state = #{condition.state}
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND pts.station_code = #{condition.stationCode}
        </if>
        <if test="condition.status != null and condition.status.length > 0">
            AND pt.`status` IN
            <foreach collection="condition.status" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.taskStatus != null">
            AND pt.`status` = #{condition.taskStatus}
        </if>
        <if test="condition.omitStatus != null">
            AND pt.omit_status = #{condition.omitStatus}
        </if>
        <if test="condition.username != null and condition.username != ''">
            AND pt.`code` IN (SELECT task_code
            FROM patrol_task_user
            WHERE user_name
            LIKE CONCAT('%', #{condition.username}, '%'))
        </if>
        <if test="condition.orgCode != null and condition.orgCode != ''">
            AND pt.`code` IN (SELECT task_code FROM patrol_task_organization WHERE org_code = #{condition.orgCode})
        </if>
<!--        <if test="condition.jointSQL != null and condition.jointSQL != ''">-->
<!--            and ${condition.jointSQL}-->
<!--        </if>-->
        GROUP BY pt.`code`
    </select>
    <select id="getScheduleList" resultType="com.aiurt.boot.statistics.model.ScheduleTask">
        SELECT
        pt.`name`,
        pt.`code`,
        pt.`status`,
        pt.patrol_date,
        IF(1 = pt.auditor, pt.auditor_time, pt.submit_time) submitTime,
        GROUP_CONCAT(DISTINCT ptu.user_name SEPARATOR '；' ) userInfo,
        GROUP_CONCAT(DISTINCT cs.station_name SEPARATOR '；' ) stationInfo,
        GROUP_CONCAT(DISTINCT sd.depart_name SEPARATOR '；' ) orgInfo
        FROM patrol_task pt
        LEFT JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code AND ptu.del_flag = 0
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        LEFT JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        LEFT JOIN patrol_task_organization pto ON pt.`code` = pto.task_code AND pto.del_flag = 0
        LEFT JOIN sys_depart sd ON pto.org_code = sd.org_code AND sd.del_flag = 0
        LEFT JOIN patrol_task_standard ptsd ON pt.id = ptsd.task_id AND ptsd.del_flag = 0
        WHERE pt.del_flag = 0
        <if test="condition.date != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') = DATE_FORMAT(#{condition.date}, '%Y-%m-%d')
        </if>
        <if test="condition.source != null">
            and pt.source = #{condition.source}
        </if>
        <if test="condition.status != null">
            and pt.`status` = #{condition.status}
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            and pt.`code` in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            WHERE pps.del_flag = 0
            and pps.station_code = #{condition.stationCode}
            )
        </if>
        <!--        <if test="patrolTaskOrganizations != null and patrolTaskOrganizations.size > 0">-->
        <!--            AND pt.`code` in (-->
        <!--                    SELECT task_code-->
        <!--                    FROM patrol_task_organization WHERE del_flag = 0-->
        <!--                                                    AND org_code IN-->
        <!--            <foreach collection="patrolTaskOrganizations" item="item" open="(" separator="," close=")">-->
        <!--                #{item.orgCode}-->
        <!--            </foreach>-->
        <!--            )-->
        <!--        </if>-->
<!--        <if test="condition.jointSQL != null and condition.jointSQL != ''">-->
<!--            ${condition.jointSQL}-->
<!--        </if>-->
        GROUP BY pt.`code`
    </select>
    <select id="getOverviewInfo" resultType="com.aiurt.boot.task.entity.PatrolTask">
        SELECT
        <!--pt.*-->
        pt.id,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        WHERE pt.del_flag = 0
        <if test="startDate != null and endDate != null">
            AND pt.patrol_date BETWEEN #{startDate} AND #{endDate}
        </if>
<!--        <if test="jointSQL != null and jointSQL != ''">-->
<!--            and ${jointSQL}-->
<!--        </if>-->
        GROUP BY pt.`code`
    </select>
    <select id="getUserTask" resultType="com.aiurt.boot.task.entity.PatrolTask">
        SELECT pt.id,
               pt.`code`,
               pt.`name`
        FROM patrol_task_user ptu
                 LEFT JOIN patrol_task pt on ptu.task_code = pt.`code`
        WHERE DATE_FORMAT(ptu.create_time, '%Y-%m-%d') = DATE_FORMAT(#{date}, '%Y-%m-%d')
          and ptu.user_id = #{userId}
    </select>
    <select id="getScreenTask" resultType="com.aiurt.boot.screen.model.ScreenStatisticsTask">
        SELECT
        pt.`id`as taskId,
        pt.`code`,
        pt.`name`,
        pt.submit_time,
        pt.auditor,
        pt.auditor_time,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status,
        GROUP_CONCAT(DISTINCT CONCAT_WS( '/', cs.line_name, cs.station_name ) SEPARATOR '；' ) stationInfo,
        GROUP_CONCAT(DISTINCT ptu.user_name SEPARATOR '；' ) userInfo
        FROM patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        LEFT JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code AND ptu.del_flag = 0
        join patrol_task_organization pto on pt.`code` = pto.task_code and pto.del_flag = 0
        WHERE
        pt.del_flag = 0
        <if test="condition.startTime != null and condition.endTime != null">
            AND pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.discardStatus != null">
            AND pt.discard_status = #{condition.discardStatus}
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            AND pt.`code` IN(
            select distinct task_code
            from patrol_task_organization where del_flag = 0
            and org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND  cs.line_code = #{condition.lineCode}
        </if>
        GROUP BY pt.`code`
    </select>
    <select id="getScreenGraph" resultType="com.aiurt.boot.screen.model.ScreenStatisticsGraph">
        select sd.depart_name orgName,
        count(pt.`code`) total,
        sum(pt.`status` = 7) finish,
        sum(pt.`status` != 7) unfinish
        from patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        join patrol_task_organization pto on pt.`code` = pto.task_code and pto.del_flag = 0
        join sys_depart sd on pto.org_code = sd.org_code
        where pt.del_flag = 0
        <if test="condition.startTime != null and condition.endTime != null">
            AND pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.discardStatus != null">
            AND pt.discard_status = #{condition.discardStatus}
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            and pto.org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND  cs.line_code = #{condition.lineCode}
        </if>
        group by pto.org_code
    </select>
    <select id="getStatisticsDataList" resultType="com.aiurt.boot.screen.model.ScreenStatisticsTask">
        SELECT
        pt.`id`as taskId,
        pt.`code`,
        pt.`name`,
        pt.submit_time,
        pt.auditor,
        pt.auditor_time,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status,
        GROUP_CONCAT(DISTINCT CONCAT_WS( '/', cs.line_name, cs.station_name ) SEPARATOR '；' ) stationInfo,
        GROUP_CONCAT(DISTINCT ptu.user_name SEPARATOR '；' ) userInfo
        FROM patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        LEFT JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code AND ptu.del_flag = 0
        WHERE
        pt.del_flag = 0
        <if test="condition.startTime != null and condition.endTime != null">
            AND pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.status != null">
            AND pt.`status` = #{condition.status}
        </if>
        <if test="condition.omit != null">
            AND pt.omit_status = #{condition.omit}
        </if>
        <if test="condition.abnormal != null">
            AND pt.abnormal_state = #{condition.abnormal}
        </if>
        <if test="condition.discardStatus != null">
            AND pt.discard_status = #{condition.discardStatus}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND  cs.line_code = #{condition.lineCode}
        </if>
        <if test="condition.today != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') = DATE_FORMAT(#{condition.today}, '%Y-%m-%d')
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            AND pt.`code` IN(
            select distinct task_code
            from patrol_task_organization where del_flag = 0
            and org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        GROUP BY pt.`code`
    </select>
    <select id="getScreenDataCount" resultType="com.aiurt.boot.task.entity.PatrolTask">
        select pt.*
        from patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        where  pt.del_flag = 0
        <if test="condition.startTime != null and condition.endTime != null">
            AND  pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.omit != null">
            AND  pt.omit_status = #{condition.omit}
        </if>
        <if test="condition.discardStatus != null">
            AND  pt.discard_status = #{condition.discardStatus}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND  cs.line_code = #{condition.lineCode}
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            AND  pt.`code` IN(
            select distinct task_code
            from patrol_task_organization where del_flag = 0
            and org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        group by pt.code
    </select>
    <select id="getFailureReport" resultType="com.aiurt.boot.report.model.FailureReport">
        SELECT
        a.id,
        a.system_name,
        a.system_code as code,
        count(c.id) AS failureNum,
        count(c.id AND c.fault_mode_code = 1 OR NOT NULL) AS repairNum,
        count(c.id AND c.fault_mode_code = 0 OR NOT NULL) AS selfInspectionNum,
        count(c.id AND c.end_time is NOT NULL and c.status = 12 OR not null) AS resolvedNum,
        count(c.id AND c.status &lt;> 12 OR not NULL) AS unResolvedNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.system_code = sub_system_code
        and `status` > 2
        AND DATE_FORMAT(happen_time, '%Y-%m') = DATE_FORMAT(#{endTime}, '%Y-%m')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as monthNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.system_code = sub_system_code
        and `status` > 2
        AND
        DATE_FORMAT(happen_time, '%Y-%m') = DATE_FORMAT(date_sub(#{endTime}, interval 1 month), '%Y-%m')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as lastMonthNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.system_code = sub_system_code
        and `status` > 2
        AND DATE_FORMAT(happen_time, '%Y') = DATE_FORMAT(curdate(), '%Y')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as yearNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.system_code = sub_system_code
        and `status` > 2
        AND
        DATE_FORMAT(happen_time, '%Y') = DATE_FORMAT(date_sub(curdate(), interval 1 year), '%Y')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as lastYearNum
        FROM cs_subsystem a
        LEFT JOIN fault c ON a.system_code = c.sub_system_code and c.`status` > 2
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT(c.happen_time, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d')
            AND DATE_FORMAT(#{endTime}, '%Y-%m-%d')
        </if>
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        where a.del_flag = 0
        <if test="id != null">
            AND a.id in (select system_id from cs_user_subsystem where user_id = #{id})
        </if>
        group by a.id
    </select>
    <select id="getReportTaskList" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT sd.depart_name AS orgName,
        sd.id AS orgId,
        sd.org_code AS orgCode
        FROM sys_depart sd
        WHERE
        <if test="orgIdList != null and orgIdList.size > 0">
            sd.id IN
            <foreach collection="orgIdList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        GROUP BY sd.depart_name, sd.org_code
    </select>
    <select id="getTasks" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT count(pt.id) AS taskTotal,
        GROUP_CONCAT(pt.id) as taskId
        FROM patrol_task pt
        JOIN patrol_task_organization pto ON pt.`code` = pto.task_code and pto.del_flag = 0
        and pt.discard_status = 0
		and pt.del_flag = 0
        <if test="orgCode != null and orgCode != ''">
            AND pto.org_code = #{orgCode}
        </if>
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.lineCode != null and condition.stationCode != null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where pps.station_code = #{condition.stationCode}
            and cs.line_code = #{condition.lineCode}
            )
        </if>
        <if test="condition.lineCode != null and condition.stationCode == null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where cs.line_code = #{condition.lineCode}
            )
        </if>
        <if test="condition.stationCode != null and condition.lineCode == null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where pps.station_code = #{condition.stationCode}
            )
        </if>
        <if test="condition.subsystemCode != null and condition.subsystemCode != ''">
            and pt.id in (
            SELECT pts.task_id
            FROM patrol_task_standard pts
            where pts.subsystem_code = #{condition.subsystemCode}
            )
        </if>
        GROUP BY pto.org_code
    </select>
    <select id="getReportOmitList" resultType="com.aiurt.boot.report.model.PatrolReport">
        select count(pt.omit_status = 1 OR NULL) AS missInspectedNumber,
        GROUP_CONCAT(pt.id) as taskId,
        pto.org_code
        FROM
        patrol_task pt
        JOIN patrol_task_organization pto ON pt.`code` = pto.task_code
        <if test="condition.orgCodeList != null and condition.orgCodeList.size > 0">
            AND pto.org_code IN
            <foreach collection="condition.orgCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.lineCode != null and condition.stationCode != null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where pps.station_code = #{condition.stationCode}
            and cs.line_code = #{condition.lineCode}
            )
        </if>
        <if test="condition.lineCode != null and condition.stationCode == null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where cs.station_code in
            <foreach collection="param1.stationCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        <if test="condition.stationCode != null and condition.lineCode == null">
            and pt.code in (
            SELECT pps.task_code
            FROM patrol_task_station pps
            LEFT JOIN cs_station cs on pps.station_code = cs.station_code and cs.del_flag = 0
            and pps.del_flag= 0
            where pps.station_code = #{condition.stationCode}
            )
        </if>
        <if test="condition.subsystemCode != null and condition.subsystemCode != ''">
            and pt.id in (
            SELECT pts.task_id
            FROM patrol_task_standard pts
            where pts.subsystem_code = #{condition.subsystemCode}
            )
        </if>
        <if test="condition.orgCode != null and condition.orgCode != ''">
            and pto.org_code = #{condition.orgCode}
        </if>
        GROUP BY pto.org_code
    </select>
    <select id="selectNum" resultType="java.lang.Integer">
        select ifnull((TIME_TO_SEC(a.time) / 60), 0) as times from
        (SELECT timediff(c.arrive_time, IFNULL(c.recevice_time, c.assign_time)) as time
        FROM
        fault a
        LEFT JOIN fault_repair_record c
        ON a.`code` = c.fault_code
        WHERE
        a.`status`
        >0
        <if test="code != null">
            and a.sub_system_code = #{code}
        </if>
        <if test="orgCode != null">
            and a.sys_org_code = #{orgCode}
        </if>
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT( a.happen_time
            , '%Y-%m-%d' ) BETWEEN DATE_FORMAT( #{startTime}
            , '%Y-%m-%d' )
            AND DATE_FORMAT( #{endTime}
            , '%Y-%m-%d' )
        </if>
        <if test="lineCode != null">
            AND a.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND a.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and (a.end_time
        or not NULL) ) as a
        where 1 = 1
    </select>
    <select id="selectNum1" resultType="java.lang.Integer">
        select ifnull((TIME_TO_SEC(abc.time) / 60), 0) as times from
        (SELECT timediff(c.end_time, IFNULL(c.recevice_time, c.assign_time)) as time
        FROM
        fault a
        LEFT JOIN fault_repair_record c
        ON a.`code` = c.fault_code
        WHERE
        a.`status`
        >0
        <if test="code != null">
            and a.sub_system_code = #{code}
        </if>
        <if test="orgCode != null">
            and a.sys_org_code = #{orgCode}
        </if>
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT( a.happen_time
            , '%Y-%m-%d' ) BETWEEN DATE_FORMAT( #{startTime}
            , '%Y-%m-%d' )
            AND DATE_FORMAT( #{endTime}
            , '%Y-%m-%d' )
        </if>
        <if test="lineCode != null">
            AND a.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND a.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and (a.end_time
        or not NULL) ) as abc
        where 1 = 1
    </select>
    <select id="selectMonth" resultType="com.aiurt.boot.report.model.dto.MonthDTO">
        select a.system_name,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '01' or not NULL) as january,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '02' or not NULL) as february,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '03' or not NULL) as march,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '04' or not NULL) as april,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '05' or not NULL) as may,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '06' or not NULL) as june,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '07' or not NULL) as july,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '08' or not NULL) as august,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '09' or not NULL) as september,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '10' or not NULL) as october,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '11' or not NULL) as november,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '12' or not NULL) as december
        FROM cs_subsystem a
        LEFT JOIN fault c ON a.system_code = c.sub_system_code
        and c.`status` > 2 AND DATE_ADD(c.happen_time, INTERVAL 1 YEAR) > NOW()
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        WHERE a.del_flag = 0
        AND a.id in (select system_id from cs_user_subsystem where user_id = #{id})
        GROUP BY a.system_name
    </select>
    <select id="getOrgReport" resultType="com.aiurt.boot.report.model.FailureOrgReport">
        SELECT
        a.id,
        a.depart_name as orgName,
        a.org_code,
        count(c.id) AS failureNum,
        count(c.id AND c.fault_mode_code = 1 OR NOT NULL) AS repairNum,
        count(c.id AND c.fault_mode_code = 0 OR NOT NULL) AS selfInspectionNum,
        count(c.id AND c.end_time is NOT NULL and c.status = 12 OR not null) AS resolvedNum,
        count(c.id AND c.status &lt;> 12 OR not NULL) AS unResolvedNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.org_code = sys_org_code
        and `status` > 2
        AND DATE_FORMAT(happen_time, '%Y-%m') = DATE_FORMAT(#{startTime}, '%Y-%m')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as monthNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.org_code = sys_org_code
        and `status` > 2
        AND
        DATE_FORMAT(happen_time, '%Y-%m') = DATE_FORMAT(date_sub(#{endTime}, interval 1 month), '%Y-%m')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as lastMonthNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.org_code = sys_org_code
        and `status` > 2
        AND DATE_FORMAT(happen_time, '%Y') = DATE_FORMAT(curdate(), '%Y')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as yearNum,
        (SELECT COUNT(id)
        FROM fault WHERE a.org_code = sys_org_code
        and `status` > 2
        AND
        DATE_FORMAT(happen_time, '%Y') = DATE_FORMAT(date_sub(curdate(), interval 1 year), '%Y')
        <if test="lineCode != null">
            AND line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        ) as lastYearNum
        FROM sys_depart a
        LEFT JOIN fault c ON a.org_code = c.sys_org_code and c.`status` > 2
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT(c.happen_time, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d')
            AND DATE_FORMAT(#{endTime}, '%Y-%m-%d')
        </if>
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND c.sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        WHERE a.del_flag = 0
        <if test="ids != null and ids.size > 0">
            AND a.id IN
            <foreach collection="ids" item="ids" open="(" separator="," close=")">
                #{ids}
            </foreach>
        </if>
        GROUP BY a.depart_name, a.org_code
    </select>
    <select id="selectMonthOrg" resultType="com.aiurt.boot.report.model.dto.MonthDTO">
        select a.depart_name as orgName,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '01' or not NULL) as january,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '02' or not NULL) as february,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '03' or not NULL) as march,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '04' or not NULL) as april,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '05' or not NULL) as may,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '06' or not NULL) as june,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '07' or not NULL) as july,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '08' or not NULL) as august,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '09' or not NULL) as september,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '10' or not NULL) as october,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '11' or not NULL) as november,
        COUNT(c.id and DATE_FORMAT(c.happen_time, '%m') = '12' or not NULL) as december
        FROM sys_depart a
        LEFT JOIN fault c ON a.org_code = c.sys_org_code
        and c.`status` > 2 AND DATE_ADD(c.happen_time, INTERVAL 1 YEAR) > NOW()
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND c.sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        WHERE a.del_flag = 0
        <if test="orgCodes != null and orgCodes.size > 0">
            AND a.org_code in
            <foreach collection="orgCodes" item="orgCodes" open="(" separator="," close=")">
                #{orgCodes}
            </foreach>
        </if>
        GROUP BY a.depart_name
    </select>
    <select id="selectLine" resultType="com.aiurt.boot.report.model.dto.LineOrStationDTO">
        select a.line_name as name, a.line_code as code
        from cs_station a
                 left join cs_user_station c on c.station_id = a.id
        where c.user_id = #{id}
    </select>
    <select id="selectStation" resultType="com.aiurt.boot.report.model.dto.LineOrStationDTO">
        select a.station_name as name, a.station_code as code
        from cs_station a
        left join cs_user_station c on c.station_id = a.id
        where c.user_id = #{id}
        <if test="lineCode != null">
            AND a.line_code = #{lineCode}
        </if>
    </select>
    <select id="selectSystem" resultType="com.aiurt.boot.report.model.dto.LineOrStationDTO">
        select a.system_name as name, a.system_code as code
        from cs_subsystem a
                 left join cs_user_subsystem c on c.system_id = a.id
        where c.user_id = #{id}
    </select>
    <select id="selectDepart" resultType="com.aiurt.boot.report.model.dto.LineOrStationDTO">
        select a.id           as id,
               a.org_code     as code,
               a.depart_name  as name,
               a.org_category as orgCategory
        from sys_depart a
        where a.manager_id = #{id}
    </select>
    <select id="getUserOrgCategory" resultType="com.aiurt.boot.report.model.dto.LineOrStationDTO">
        select a.id           as id,
               a.org_code     as code,
               a.depart_name  as name,
               a.org_category as orgCategory
        from sys_depart a
        where org_code_cc LIKE CONCAT('%', #{orgCode}, '%')
          and a.org_category in (3, 4, 5)
    </select>
    <select id="getUserPlanNumber" resultType="com.aiurt.boot.dto.UserTeamPatrolDTO">
        SELECT COUNt(pt.id) as planTaskNumber,
        sd.id AS orgId,
        pt.id AS taskId
        FROM
        patrol_task pt
        JOIN patrol_task_organization pto ON pt.`code` = pto.task_code
        JOIN sys_depart sd ON sd.org_code = pto.org_code
        <if test="orgId != null and orgId != ''">
            AND sd.id = #{orgId}
        </if>
        <if test="startDate != null and startDate != ''">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') and
            DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
    </select>
    <select id="getUserNowNumber" resultType="com.aiurt.boot.dto.UserTeamPatrolDTO">
        SELECT SUM(IFNULL(pt.duration,'0') * 60) as workHours,
        sd.id as orgId,
        pt.id AS taskId
        FROM
        patrol_task pt
        JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code
        JOIN sys_user su ON su.id = ptu.user_id
        JOIN sys_depart sd ON sd.id = su.org_id
        <if test="useIds != null and useIds.size() != 0">
            and ptu.user_id in
            <foreach collection="useIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null and startDate != ''">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') and
            DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        and pt.`status` = 7
        GROUP BY pt.id
    </select>
    <select id="getPeopleNowNumber" resultType="com.aiurt.boot.dto.UserTeamPatrolDTO">
        SELECT SUM(IFNULL(pt.duration,'0') * 60) as workHours,
        sd.id as orgId,
        pt.id AS taskId
        FROM
        patrol_task pt
        JOIN patrol_task_device ptd ON pt.id = ptd.task_id
        JOIN patrol_accompany pa ON ptd.patrol_number = pa.task_device_code
        JOIN sys_user su ON su.id = pa.user_id
        JOIN sys_depart sd ON sd.id = su.org_id
        <if test="useIds != null and useIds.size() != 0">
            AND pa.user_id IN
            <foreach collection="useIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null and startDate != ''">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') and
            DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        and pt.`status` = 7
        GROUP BY pt.id
    </select>
    <select id="getUserOmitTasksNumber" resultType="com.aiurt.boot.dto.UserTeamPatrolDTO">
        SELECT sd.id as orgId,
        pt.id AS taskId
        FROM
        patrol_task pt
        JOIN patrol_task_user ptu ON pt.`code` = ptu.task_code
        JOIN sys_user su ON su.id = ptu.user_id
        JOIN sys_depart sd ON sd.id = su.org_id
        <if test="useIds != null and useIds.size() != 0">
            and ptu.user_id in
            <foreach collection="useIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null and startDate != ''">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') and
            DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        and pt.abnormal_state = 1
        GROUP BY pt.id
    </select>
    <select id="getPeopleOmitTasksNumber" resultType="com.aiurt.boot.dto.UserTeamPatrolDTO">
        SELECT sd.id as orgId,
        pt.id AS taskId
        FROM
        patrol_task pt
        JOIN patrol_task_device ptd ON pt.id = ptd.task_id
        JOIN patrol_accompany pa ON ptd.patrol_number = pa.task_device_code
        JOIN sys_user su ON su.id = pa.user_id
        JOIN sys_depart sd ON sd.id = su.org_id
        <if test="useIds != null and useIds.size() != 0">
            AND pa.user_id IN
            <foreach collection="useIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="startDate != null and startDate != ''">
            and DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startDate}, '%Y-%m-%d') and
            DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        </if>
        and pt.abnormal_state = 1
        GROUP BY pt.id
    </select>
    <select id="getDetail" resultType="com.aiurt.boot.task.dto.PatrolTaskDTO">
        select t1.*,
        (select realname from sys_user where id = t1.end_user_id) as
        endUserName,
        concat(DATE_FORMAT(t1.start_time, '%H:%i'), "-", DATE_FORMAT(t1.end_time, '%H:%i')) as startEndTime
        from patrol_task t1
        where t1.del_flag = 0
        <if test="id != null and id != ''">
            and t1.id = #{id}
        </if>
    </select>
    <select id="getOrgCodeName" resultType="com.aiurt.boot.task.dto.GeneralReturn">
        select org_code as value,
        depart_name as label
        from sys_depart
        <if test="orgCodes != null and orgCodes.size() != 0">
            where org_code in
            <foreach collection="orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>
    <select id="getTemAndHum" resultType="com.aiurt.boot.task.dto.TemperatureHumidityDTO">
        SELECT t.*, s.line_code, s.line_name, s.station_code, s.station_name
        from `temperature_humidity` t
        left join sensor_information s on t.ip = s.station_ip
        where s.del_flag = 0
            AND s.line_code = #{condition.lineCode}
            AND s.station_code = #{condition.stationCode}
            <if test="condition.mode != null and condition.mode == 0">
                AND DATE_FORMAT(t.create_time, '%Y-%m-%d %H') = DATE_FORMAT(#{condition.date}, '%Y-%m-%d %H')
            </if>
            <if test="condition.mode != null and condition.mode == 1">
                AND DATE_FORMAT(t.create_time, '%Y-%m-%d') = DATE_FORMAT(#{condition.date}, '%Y-%m-%d')
            </if>
            <if test="condition.mode != null and condition.mode == 2">
                AND t.create_time > DATE_SUB(#{condition.date}, INTERVAL #{condition.interval} DAY) AND t.create_time <![CDATA[<=]]> #{condition.date}
                AND DATE_FORMAT(t.create_time, '%H') = #{condition.hour}
            </if>
            <if test="condition.mode != null and condition.mode == 3">
                AND t.create_time > DATE_SUB(#{condition.date}, INTERVAL #{condition.interval} DAY) AND t.create_time <![CDATA[<=]]> #{condition.date}
                AND DATE_FORMAT(t.create_time, '%H') = #{condition.hour}
            </if>
        order by create_time desc
    </select>

    <select id="selectpatrolTaskList" resultType="com.aiurt.boot.task.entity.PatrolTask">
        select distinct t1.*
        from patrol_task t1
                 left join patrol_task_organization t2 on t1.code = t2.task_code
                 left join patrol_task_standard t3 on t1.id = t3.task_id
                 left join patrol_task_station t4 on t1.code = t4.task_code
        where t1.del_flag = 0
          and t1.status = #{status}
          and date_format(t1.patrol_date, '%Y-%m-%d') &gt;= date_format(#{firstDay}, '%Y-%m-%d')
          and date_format(t1.patrol_date, '%Y-%m-%d') &lt;= date_format(#{lastDay}, '%Y-%m-%d')
    </select>

    <sql id="OverviewInfo">
        SELECT
        pt.id,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status,
        date_format(pt.patrol_date, '%Y-%m-%d') as patrolDate
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        WHERE pt.del_flag = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND pt.patrol_date BETWEEN #{condition.startDate} AND #{condition.endDate}
        </if>
        <if test="condition.discardStatus != null">
            AND pt.discard_status != #{condition.discardStatus}
        </if>
        <if test="condition.jointSQL != null and condition.jointSQL != ''">
            and ${condition.jointSQL}
        </if>
        GROUP BY pt.`code`
    </sql>

    <select id="getOverviewInfoCount" resultType="com.aiurt.boot.statistics.model.PatrolSituation">
        SELECT
        IFNULL(COUNT( 1 ), 0) `sum`,
        IFNULL(SUM( #{condition.status} = statistics.`status` ) , 0) `finish`,
        IFNULL(SUM( #{condition.status} != statistics.`status` ) , 0)`unfinish`,
        IFNULL(SUM( #{condition.abnormal} = statistics.abnormal_state ), 0) `abnormal`,
        IFNULL(SUM( #{condition.omitStatus} = statistics.omit_status ), 0) omit
        FROM
        (
        <include refid="OverviewInfo"/>
        ) statistics
    </select>

    <select id="getTaskDeviceOverviewInfoCount" resultType="com.aiurt.boot.statistics.model.PatrolSituation">
        SELECT
        IFNULL(COUNT( 1 ), 0) `sum`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `finish`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`unfinish`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormal`,
        IFNULL(SUM( #{condition.omitStatus} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) omit
        FROM
        (
        <include refid="OverviewInfo"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
    </select>

    <select id="getCountONMonth" resultType="com.aiurt.boot.statistics.model.PatrolSituation">
        SELECT
        IFNULL(COUNT( 1 ), 0) `sum`,
        IFNULL(SUM( #{condition.status} = statistics.`status` ) , 0) `finish`,
        IFNULL(SUM( #{condition.status} != statistics.`status` ) , 0)`unfinish`,
        IFNULL(SUM( #{condition.abnormal} = statistics.abnormal_state ), 0) `abnormal`,
        IFNULL(SUM( #{condition.omitStatus} = statistics.omit_status ), 0) omit,
        statistics.patrolDate
        FROM
        (
        <include refid="OverviewInfo"/>
        ) statistics
        group by statistics.patrolDate
    </select>

    <select id="getTaskDeviceCountONMonth" resultType="com.aiurt.boot.statistics.model.PatrolSituation">
        SELECT
        IFNULL(COUNT( 1 ), 0) `sum`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `finish`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`unfinish`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormal`,
        IFNULL(SUM( #{condition.omitStatus} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) omit,
        statistics.patrolDate
        FROM
        (
        <include refid="OverviewInfo"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        group by statistics.patrolDate
    </select>


    <sql id="ImportantData">
        select
        pt.id,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status,
        date_format(pt.patrol_date, '%Y-%m-%d') as patrolDate
        from patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        where  pt.del_flag = 0
        <if test="condition.startTime != null and condition.endTime != null">
            AND  pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.discardStatus != null">
            AND  pt.discard_status = #{condition.discardStatus}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND  cs.line_code = #{condition.lineCode}
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            AND  pt.`code` IN(
            select distinct task_code
            from patrol_task_organization where del_flag = 0
            and org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
            )
        </if>
        group by pt.code
    </sql>

    <select id="getTaskDeviceCount" resultType="com.aiurt.boot.statistics.model.PatrolSituation">
        SELECT
        IFNULL(COUNT( 1 ), 0) `sum`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `finish`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`unfinish`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormal`,
        IFNULL(SUM( #{condition.omit} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) omit,
        statistics.patrolDate
        FROM
        (
        <include refid="ImportantData"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
    </select>

    <sql id="ReportTaskDeviceData">
        select
        pt.id,
        pt.code,
        pt.`status`,
        pt.abnormal_state,
        pt.omit_status,
        pto.org_code,
        IFNULL(pt.duration,'0') * 60 workHours
        from patrol_task pt
        LEFT JOIN patrol_task_station pts ON pt.`code` = pts.task_code AND pts.del_flag = 0
        JOIN cs_station cs ON pts.station_code = cs.station_code AND cs.del_flag = 0
        LEFT JOIN patrol_task_organization pto on pto.task_code = pt.code and pto.del_flag =0
        LEFT JOIN patrol_task_standard ptsd on ptsd.task_id = pt.id and ptsd.del_flag = 0
        where pt.del_flag = 0 AND pt.discard_status = 0
        <if test="condition.startDate != null and condition.endDate != null">
            AND pt.patrol_date BETWEEN #{condition.startDate} AND #{condition.endDate}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND cs.line_code = #{condition.lineCode}
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND cs.station_code = #{condition.stationCode}
        </if>
        <if test="condition.orgCodeList != null and condition.orgCodeList.size > 0">
            and pto.org_code in
            <foreach collection="condition.orgCodeList" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.subsystemCode != null and condition.subsystemCode != ''">
            and  ptsd.subsystem_code = #{condition.subsystemCode}
        </if>
        group by pt.code
    </sql>

    <select id="getReportTaskDeviceCount" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT
        IFNULL(COUNT( 1 ), 0) `taskTotal`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `inspectedNumber`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`notInspectedNumber`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormalNumber`,
        IFNULL(SUM( #{condition.omit} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) missInspectedNumber,
        statistics.org_code
        FROM
        (
        <include refid="ReportTaskDeviceData"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        group by statistics.org_code
    </select>

    <select id="getFaultList" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT
        IFNULL(COUNT( ptf.patrol_number ), 0) `faultNumber`,
        statistics.org_code
        FROM
        (
        <include refid="ReportTaskDeviceData"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_task_fault ptf on ptd.patrol_number = ptf.patrol_number and ptf.del_flag = 0
        LEFT JOIN fault f on ptf.fault_code = f.`code` and f.`status` = 12
        group by statistics.org_code
    </select>
    <select id="getFilterFailureReport" resultType="com.aiurt.boot.report.model.FailureReport">
      SELECT
        a.id,
        a.system_name,
        a.system_code as code,
        count(c.id AND c.end_time is NOT NULL and c.status = 12 OR not null) AS resolvedNum
        FROM cs_subsystem a
        LEFT JOIN fault c ON a.system_code = c.sub_system_code and c.`status` > 2
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT(c.happen_time, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d')
            AND DATE_FORMAT(#{endTime}, '%Y-%m-%d')
        </if>
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        where a.del_flag = 0
         and not EXISTS (select 1 from operation_process where fault_code = c.code and  process_code = 10)
        <if test="id != null">
            AND a.id in (select system_id from cs_user_subsystem where user_id = #{id})
        </if>
        group by a.id
</select>
<select id="selectFaultWorkTime" resultType="java.lang.Integer">
 select ifnull((TIME_TO_SEC(abc.time) / 60), 0) as times from
        (SELECT timediff(c.end_time,IFNULL( IFNULL( c.recevice_time, c.assign_time ),c.start_time)) AS time
        FROM
        fault a
        LEFT JOIN fault_repair_record c
        ON a.`code` = c.fault_code
        WHERE
        a.`status`
        >0
        and not EXISTS (select 1 from operation_process where fault_code = a.code and  process_code = 10)
        <if test="code != null">
            and a.sub_system_code = #{code}
        </if>
        <if test="orgCode != null">
            and a.sys_org_code = #{orgCode}
        </if>
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT( a.happen_time
            , '%Y-%m-%d' ) BETWEEN DATE_FORMAT( #{startTime}
            , '%Y-%m-%d' )
            AND DATE_FORMAT( #{endTime}
            , '%Y-%m-%d' )
        </if>
        <if test="lineCode != null">
            AND a.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND a.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        and (a.end_time
        or not NULL) ) as abc
        where 1 = 1
</select>
<select id="getFilterOrgReport" resultType="com.aiurt.boot.report.model.FailureOrgReport">
  SELECT
        a.id,
        a.depart_name as orgName,
        a.org_code,
        count(c.id AND c.end_time is NOT NULL and c.status = 12 OR not null) AS resolvedNum
        FROM sys_depart a
        LEFT JOIN fault c ON a.org_code = c.sys_org_code and c.`status` > 2
        <if test="startTime != null and endTime != null">
            and DATE_FORMAT(c.happen_time, '%Y-%m-%d') BETWEEN DATE_FORMAT(#{startTime}, '%Y-%m-%d')
            AND DATE_FORMAT(#{endTime}, '%Y-%m-%d')
        </if>
        <if test="lineCode != null">
            AND c.line_code = #{lineCode}
        </if>
        <if test="stationCode != null and stationCode.size > 0">
            AND c.station_code IN
            <foreach collection="stationCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="systemCode != null and systemCode.size > 0">
            AND c.sub_system_code IN
            <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        WHERE a.del_flag = 0
        and not EXISTS (select 1 from operation_process where fault_code = c.code and  process_code = 10)
        <if test="ids != null and ids.size > 0">
            AND a.id IN
            <foreach collection="ids" item="ids" open="(" separator="," close=")">
                #{ids}
            </foreach>
        </if>
        GROUP BY a.depart_name, a.org_code
</select>

    <select id="getReportTaskUserCount" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT
        IFNULL(COUNT( 1 ), 0) `taskTotal`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `inspectedNumber`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`notInspectedNumber`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormalNumber`,
        IFNULL(SUM( #{condition.omit} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) missInspectedNumber,
        ptu.user_id,
        SUM(statistics.workHours) as workHours
        FROM
        (
        <include refid="ReportTaskDeviceData"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_task_user ptu on ptu.task_code = statistics.code and ptu.del_flag = 0
        group by ptu.user_id
    </select>

    <select id="getReportTaskAccompanyCount" resultType="com.aiurt.boot.report.model.PatrolReport">
        SELECT
        IFNULL(COUNT( 1 ), 0) `taskTotal`,
        IFNULL(SUM( #{condition.checkStatus} = ptd.`status` ), 0) `inspectedNumber`,
        IFNULL(SUM( #{condition.checkStatus} != ptd.`status` ) , 0)`notInspectedNumber`,
        IFNULL(SUM( #{condition.checkResult} = ptd.check_result or #{condition.macStatus} = ptd.mac_status ), 0) `abnormalNumber`,
        IFNULL(SUM( #{condition.omit} = statistics.omit_status and #{condition.checkStatus} != ptd.`status`), 0) missInspectedNumber,
        pa.user_id,
        SUM(statistics.workHours) as workHours
        FROM
        (
        <include refid="ReportTaskDeviceData"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_accompany pa on pa.task_device_code = ptd.patrol_number and pa.del_flag = 0
        group by pa.user_id
    </select>

    <sql id="IndexTaskDevice">
        SELECT
        pt.id,
        pt.`code`,
        pt.patrol_date,
        IF(1 = pt.auditor, pt.auditor_time, pt.submit_time) submitTime
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        left join patrol_task_user ptu on pt.code = ptu.task_code and ptu.del_flag = 0
        WHERE pt.del_flag = 0 AND pt.discard_status != 1
        <if test="condition.jointSQL != null and condition.jointSQL != ''">
            and ${condition.jointSQL}
        </if>
        <if test="condition.startDate != null and condition.endDate != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')
            BETWEEN DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
            AND DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
<!--        <if test="condition.status != null and condition.status.length > 0">-->
<!--            AND pt.`status` IN-->
<!--            <foreach collection="condition.status" item="item" open="(" separator="," close=")">-->
<!--                #{item}-->
<!--            </foreach>-->
<!--        </if>-->
        <if test="condition.omitStatus != null">
            AND pt.omit_status = #{condition.omitStatus}
        </if>
        <if test="condition.username != null and condition.username != ''">
            and  ptu.user_name
            LIKE CONCAT('%', #{condition.username}, '%')
        </if>
        <if test="condition.orgCode != null and condition.orgCode != ''">
            AND pto.org_code = #{condition.orgCode}
        </if>
        GROUP BY pt.`code`
    </sql>

    <select id="getIndexTaskDeviceList" resultType="com.aiurt.boot.statistics.model.IndexTaskInfo">
        SELECT
        ptd.id,
        ps.`name`,
        ptd.check_result as abnormalState ,
        statistics.`code`,
        ptd.`status`,
        ptd.check_time as submitTime,
        ptd.mac_status
        FROM
        (
        <include refid="IndexTaskDevice"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_accompany pa on pa.task_device_code = ptd.patrol_number and pa.del_flag = 0
        left join patrol_task_standard ptss on ptd.task_standard_id = ptss.id and ptss.del_flag = 0
        left join patrol_standard ps on ps.id = ptss.standard_id and ps.del_flag = 0
        where 1=1
        <if test="condition.taskStatus != null">
            AND ptd.`status` = #{condition.taskStatus}
        </if>
        <if test="condition.taskDeviceStatus != null">
            AND ptd.`status` in
            <foreach collection="condition.taskDeviceStatus" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.state != null">
            AND (ptd.check_result = #{condition.state} or ptd.mac_status = #{condition.state})
        </if>
        <if test="condition.exceptionType != null and condition.exceptionType == 0">
            and ptd.check_result = 0
        </if>
        <if test="condition.exceptionType != null and condition.exceptionType == 1">
            and ptd.mac_status = 0
        </if>
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND ptd.station_code = #{condition.stationCode}
        </if>
        GROUP BY ptd.id
    </select>

    <sql id="ScheduleDeviceList">
        SELECT
        pt.id,
        pt.`code`,
        pt.patrol_date,
        IF(1 = pt.auditor, pt.auditor_time, pt.submit_time) submitTime
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        left join patrol_task_user ptu on pt.code = ptu.task_code and ptu.del_flag = 0
        WHERE pt.del_flag = 0 AND pt.discard_status != 1
        <if test="condition.jointSQL != null and condition.jointSQL != ''">
            and ${condition.jointSQL}
        </if>
        <if test="condition.date != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d')= DATE_FORMAT(#{condition.date}, '%Y-%m-%d')
        </if>
        <if test="condition.source != null">
            AND pt.source = #{condition.source}
        </if>
        GROUP BY pt.`code`
    </sql>

    <select id="getScheduleDeviceList" resultType="com.aiurt.boot.statistics.model.ScheduleTask">
        SELECT
        ptd.id,
        ps.`name`,
        statistics.`code`,
        ptd.`status`,
        statistics.patrol_date,
        statistics.submitTime,
        ptd.station_code
        FROM
        (
        <include refid="ScheduleDeviceList"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_accompany pa on pa.task_device_code = ptd.patrol_number and pa.del_flag = 0
        left join patrol_task_standard ptss on ptd.task_standard_id = ptss.id and ptss.del_flag = 0
        left join patrol_standard ps on ps.id = ptss.standard_id and ps.del_flag = 0
        where 1=1
        AND ptd.`status` = 2
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND ptd.station_code = #{condition.stationCode}
        </if>
        GROUP BY ptd.id
    </select>

    <sql id="StatisticsDataDeviceList">
        SELECT
        pt.id,
        pt.`code`,
        pt.patrol_date,
        pt.omit_status,
        IF(1 = pt.auditor, pt.auditor_time, pt.submit_time) submitTime
        FROM patrol_task pt
        left join patrol_task_organization pto on pt.code = pto.task_code and pto.del_flag = 0
        left join patrol_task_standard ptsd on pt.id = ptsd.task_id and ptsd.del_flag = 0
        left join patrol_task_station pts on pt.code = pts.task_code and pts.del_flag = 0
        <!--        left join patrol_task_user ptu on pt.code = ptu.task_code and ptu.del_flag = 0-->
        WHERE pt.del_flag = 0 AND pt.discard_status != 1
        <if test="condition.startTime != null and condition.endTime != null">
            AND pt.patrol_date BETWEEN #{condition.startTime} AND #{condition.endTime}
        </if>
        <if test="condition.omit != null">
            AND pt.omit_status = #{condition.omit}
        </if>
        <if test="condition.orgCodes != null and condition.orgCodes.size > 0">
            and pto.org_code in
            <foreach collection="condition.orgCodes" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.today != null">
            AND DATE_FORMAT(pt.patrol_date, '%Y-%m-%d') = DATE_FORMAT(#{condition.today}, '%Y-%m-%d')
        </if>
        GROUP BY pt.`code`
    </sql>


    <select id="getStatisticsDataDeviceList" resultType="com.aiurt.boot.screen.model.ScreenStatisticsTask">
        SELECT
        ptd.id as taskId,
        ps.`name`,
        statistics.`code`,
        ptd.`status`,
        ptd.check_time as submitTime,
        statistics.omit_status,
        GROUP_CONCAT(DISTINCT CONCAT_WS( '/', cs.line_name, cs.station_name ) SEPARATOR '；' ) stationInfo
        FROM
        (
        <include refid="StatisticsDataDeviceList"/>
        ) statistics
        left join  patrol_task_device ptd on ptd.task_id = statistics.id and ptd.del_flag = 0
        left join patrol_accompany pa on pa.task_device_code = ptd.patrol_number and pa.del_flag = 0
        left join patrol_task_standard ptss on ptd.task_standard_id = ptss.id and ptss.del_flag = 0
        left join patrol_standard ps on ps.id = ptss.standard_id and ps.del_flag = 0
        JOIN cs_station cs ON ptd.station_code = cs.station_code AND cs.del_flag = 0
        where 1=1
        <if test="condition.stationCode != null and condition.stationCode != ''">
            AND ptd.station_code = #{condition.stationCode}
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            AND ptd.line_code = #{condition.lineCode}
        </if>
        <if test="condition.taskDeviceStatus != null">
            AND ptd.`status` in
            <foreach collection="condition.taskDeviceStatus" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="condition.state != null">
            AND (ptd.check_result = #{condition.state} or ptd.mac_status = #{condition.state})
        </if>
        GROUP BY ptd.id
    </select>
</mapper>
