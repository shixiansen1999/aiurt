<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.PatrolTaskDeviceMapper">

    <select id="selectBillInfo" resultType="com.aiurt.boot.task.param.PatrolTaskDeviceParam">
        SELECT pts.profession_code majorCode,
        cm.major_name majorName,
        pts.subsystem_code,
        cs.system_name subsystemName,
        pts.device_type_code,
        dt.`name` deviceTypeName,
        ps.`name` standardName,
        device.`name` deviceName,
        su.realname username,
        ptd.*
        FROM patrol_task_device ptd
        JOIN patrol_task_standard pts ON ptd.task_standard_id = pts.id
        LEFT JOIN patrol_standard ps ON pts.standard_id = ps.id
        LEFT JOIN device ON ptd.device_code = device.`code`
        LEFT JOIN cs_major cm ON pts.profession_code = cm.major_code
        LEFT JOIN cs_subsystem cs ON pts.subsystem_code = cs.system_code
        LEFT JOIN device_type dt ON pts.device_type_code = dt.`code`
        LEFT JOIN sys_user su ON ptd.user_id = su.id
        WHERE ptd.del_flag = 0
        <if test="taskDevice.taskId != null and taskDevice.taskId !=''">
            and ptd.task_id = #{taskDevice.taskId}
        </if>
        <if test="taskDevice.deviceName != null and taskDevice.deviceName !=''">
            and device.`name` like concat('%',#{taskDevice.deviceName},'%')
        </if>
        <if test="taskDevice.checkResult != null and taskDevice.checkResult !=''">
            and ptd.check_result = #{taskDevice.checkResult}
        </if>
        <if test="taskDevice.patrolNumber != null and taskDevice.patrolNumber !=''">
            and ptd.patrol_number like concat('%',#{taskDevice.patrolNumber},'%')
        </if>
        <if test="taskDevice.username != null and taskDevice.username !=''">
            and su.realname like concat('%',#{taskDevice.username},'%')
        </if>
        <if test="taskDevice.majorCode != null and taskDevice.majorCode !=''">
            and pts.profession_code = #{taskDevice.majorCode}
        </if>
        <if test="taskDevice.subsystemCode != null and taskDevice.subsystemCode !=''">
            and pts.subsystem_code = #{taskDevice.subsystemCode}
        </if>
    </select>
    <select id="selectBillInfoForDevice" resultType="com.aiurt.boot.task.param.PatrolTaskDeviceParam">
        SELECT pts.profession_code majorCode,
        cm.major_name majorName,
        pts.subsystem_code,
        cs.system_name subsystemName,
        pts.device_type_code,
        dt.`name` deviceTypeName,
        ps.`name` standardName,
        device.`name` deviceName,
        su.realname username,
        ptd.*
        FROM patrol_task_device ptd
        JOIN patrol_task_standard pts ON ptd.task_standard_id = pts.id
        LEFT JOIN patrol_standard ps ON pts.standard_id = ps.id
        LEFT JOIN device ON ptd.device_code = device.`code`
        LEFT JOIN cs_major cm ON pts.profession_code = cm.major_code
        LEFT JOIN cs_subsystem cs ON pts.subsystem_code = cs.system_code
        LEFT JOIN device_type dt ON pts.device_type_code = dt.`code`
        LEFT JOIN sys_user su ON ptd.user_id = su.id
        WHERE ptd.del_flag = 0 and ptd.status = 2
        <if test="taskDevice.taskId != null and taskDevice.taskId !=''">
            and ptd.task_id = #{taskDevice.taskId}
        </if>
        <if test="taskDevice.deviceCode != null and taskDevice.deviceCode !=''">
            and ptd.device_code = #{taskDevice.deviceCode}
        </if>
        <if test="taskDevice.deviceName != null and taskDevice.deviceName !=''">
            and device.`name` like concat('%',#{taskDevice.deviceName},'%')
        </if>
        <if test="taskDevice.checkResult != null and taskDevice.checkResult !=''">
            and ptd.check_result = #{taskDevice.checkResult}
        </if>
        <if test="taskDevice.patrolNumber != null and taskDevice.patrolNumber !=''">
            and ptd.patrol_number like concat('%',#{taskDevice.patrolNumber},'%')
        </if>
        <if test="taskDevice.username != null and taskDevice.username !=''">
            and su.realname like concat('%',#{taskDevice.username},'%')
        </if>
        <if test="taskDevice.standardName != null and taskDevice.standardName !=''">
            and ps.`name` like concat('%',#{taskDevice.standardName},'%')
        </if>
        <if test="taskDevice.startTimeBegin!=null and taskDevice.startTimeEnd!=null ">
            and DATE_FORMAT(ptd.start_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{taskDevice.startTimeBegin}, '%Y-%m-%d')
            and DATE_FORMAT(ptd.start_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{taskDevice.startTimeEnd}, '%Y-%m-%d')
        </if>
    </select>
    <select id="selectBillInfoByNumber" resultType="com.aiurt.boot.task.param.PatrolTaskDeviceParam">
        SELECT
        pts.device_type_code,
        dt.`name` deviceTypeName,
        d.`name` deviceName,
        su.realname username,
        cl.line_name,
        cs.station_name,
        csp.position_name,
        ptd.*
        FROM
        patrol_task_device ptd
        JOIN patrol_task_standard pts ON ptd.task_standard_id = pts.id
        LEFT JOIN cs_line cl ON ptd.line_code = cl.line_code
        LEFT JOIN cs_station cs ON ptd.station_code = cs.station_code
        LEFT JOIN cs_station_position csp ON ptd.position_code = csp.position_code
        LEFT JOIN device_type dt ON pts.device_type_code = dt.`code`
        LEFT JOIN sys_user su ON ptd.user_id = su.id
        LEFT JOIN device d ON ptd.device_code = d.`code`
        WHERE
        ptd.del_flag = 0
        <if test="patrolNumber != null and patrolNumber !=''">
            and ptd.patrol_number = #{patrolNumber}
        </if>
    </select>
    <select id="getPatrolTaskDeviceList" resultType="com.aiurt.boot.task.dto.PatrolTaskDeviceDTO">
        SELECT concat((SELECT line_name FROM cs_line AS csl WHERE csl.line_code = ptd.line_code), "-",
                      (SELECT station_name FROM cs_station AS css WHERE css.station_code = ptd.station_code),
                      IFNULL((SELECT CONCAT("-", position_name)
                              FROM cs_station_position AS cssp
                              WHERE cssp.position_code = ptd.position_code), '')) AS devicePosition,
               dv.name                                                            as deviceName,
               ptd.*
        FROM patrol_task_device ptd
                 LEFT JOIN device dv on ptd.device_code = dv.code
        WHERE ptd.del_flag = 0
          AND ptd.task_id = #{id}
          <if test="search != null and search != ''">
        and CONCAT_WS(',',ptd.patrol_number,ptd.device_code,dv.name) like concat('%',#{search},'%')
          </if>
    </select>
    <select id="getSubmitName" resultType="java.lang.String">
        select realname
        from sys_user
        where id = #{userId}
    </select>
    <select id="getPosition" resultType="java.lang.String">
        select (select CONCAT(t2.line_name, "/", t2.station_name)
                from cs_station t2
                where t1.station_code = t2.station_code) as station
        from patrol_task_station t1
        where t1.task_code = #{code}
    </select>
    <select id="getDeviceInfoByCode" resultType="com.aiurt.modules.device.entity.Device">
        SELECT *
        FROM device
        WHERE device.del_flag = 0
          AND device.`code` = #{deviceCode}
	</select>
<select id="getDevice" resultType="com.aiurt.modules.device.entity.Device">
select  t1.*
from device t1
where t1.code = #{code}
</select>
<select id="getTaskStandardDevice" resultType="com.aiurt.boot.task.dto.DeviceDTO">
    SELECT
	concat( t2.line_name, "/", t2.station_name ) AS positionCodeName,t3.name as deviceType,t1.*
    FROM device t1
	LEFT JOIN cs_station t2 ON t1.station_code = t2.station_code
	LEFT JOIN device_type t3 on t1.device_type_code = t3.code
    where t1.code = #{code}
</select>
<select id="getDevicePosition" resultType="java.lang.String">
select t1.position_name
from cs_station_position t1
where t1.position_code = #{positionCode}
</select>
<select id="getStandardName" resultType="com.aiurt.boot.standard.entity.PatrolStandard">
   SELECT t3.name,t3.device_type
        FROM patrol_task_standard t1
                 LEFT JOIN patrol_task_device t2 on t1.id = t2.task_standard_id and t1.task_id = t2.task_id
                 LEFT JOIN patrol_standard t3 on t3.code = t1.standard_code
        WHERE t2.id = #{deviceId}
 </select>
</mapper>
