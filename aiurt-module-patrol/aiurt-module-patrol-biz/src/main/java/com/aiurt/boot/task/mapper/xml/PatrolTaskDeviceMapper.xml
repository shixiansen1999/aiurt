<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.PatrolTaskDeviceMapper">

    <select id="selectBillInfo" resultType="com.aiurt.boot.task.param.PatrolTaskDeviceParam">
        SELECT pts.profession_code majorCode,
        cm.major_name majorName,
        pts.subsystem_code,
        cs.system_name subsystemName,
        pts.device_type_code,
        dt.`name` deviceTypeName,
        ps.`name` standardName,
        device.`name` deviceName,
        su.realname username,
        ptd.*
        FROM patrol_task_device ptd
        JOIN patrol_task_standard pts ON ptd.task_standard_id = pts.id
        LEFT JOIN patrol_standard ps ON pts.standard_id = ps.id
        LEFT JOIN device ON ptd.device_code = device.`code`
        LEFT JOIN cs_major cm ON pts.profession_code = cm.major_code
        LEFT JOIN cs_subsystem cs ON pts.subsystem_code = cs.system_code
        LEFT JOIN device_type dt ON pts.device_type_code = dt.`code`
        LEFT JOIN sys_user su ON ptd.user_id = su.id
        WHERE ptd.del_flag = 0
        <if test="taskDevice.taskId != null and taskDevice.taskId !=''">
            and ptd.task_id = #{taskDevice.taskId}
        </if>
        <if test="taskDevice.deviceName != null and taskDevice.deviceName !=''">
            and device.`name` like concat('%',#{taskDevice.deviceName},'%')
        </if>
        <if test="taskDevice.checkResult != null and taskDevice.checkResult !=''">
            and ptd.check_result = #{taskDevice.checkResult}
        </if>
        <if test="taskDevice.patrolNumber != null and taskDevice.patrolNumber !=''">
            and ptd.patrol_number like concat('%',#{taskDevice.patrolNumber},'%')
        </if>
        <if test="taskDevice.username != null and taskDevice.username !=''">
            and su.realname like concat('%',#{taskDevice.username},'%')
        </if>
    </select>
    <select id="selectBillInfoByNumber" resultType="com.aiurt.boot.task.param.PatrolTaskDeviceParam">
        SELECT
        pts.device_type_code,
        dt.`name` deviceTypeName,
        d.`name` deviceName,
        su.realname username,
        cl.line_name,
        cs.station_name,
        csp.position_name,
        ptd.*
        FROM
        patrol_task_device ptd
        JOIN patrol_task_standard pts ON ptd.task_standard_id = pts.id
        LEFT JOIN cs_line cl ON ptd.line_code = cl.line_code
        LEFT JOIN cs_station cs ON ptd.station_code = cs.station_code
        LEFT JOIN cs_station_position csp ON ptd.position_code = csp.position_code
        LEFT JOIN device_type dt ON pts.device_type_code = dt.`code`
        LEFT JOIN sys_user su ON ptd.user_id = su.id
        LEFT JOIN device d ON ptd.device_code = d.`code`
        WHERE
        ptd.del_flag = 0
        <if test="patrolNumber != null and patrolNumber !=''">
            and ptd.patrol_number = #{patrolNumber}
        </if>
    </select>
    <select id="getPatrolTaskDeviceList" resultType="com.aiurt.boot.task.dto.PatrolTaskDeviceDTO">
        SELECT ptd.*, ps.name as taskStandardName, ps.id as standardId
        FROM patrol_task_device ptd
                 left join patrol_task_standard pts on pts.id = ptd.task_standard_id
                 left join patrol_standard ps on ps.id = pts.standard_id
        WHERE ptd.del_flag = 0
          AND ptd.task_id = #{id}
    </select>
</mapper>
