<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.rehearsal.mapper.EmergencyImplementationRecordMapper">
    <select id="queryPageList" resultType="com.aiurt.boot.rehearsal.vo.EmergencyImplementationRecordVO">
        select eir.*,
               erm.code               as planCode,
               erm.subject            as subject,
               erm.rehearsal_time     as planRehearsalTime,
               erm.org_code           as deptCode,
               ep.emergency_plan_name as schemeName
        from emergency_implementation_record eir
                 left join emergency_rehearsal_month erm on eir.plan_id = erm.id
                 left join emergency_plan ep on erm.scheme_id = ep.id
        where eir.del_flag = 0
        <if test="condition.subject != null and condition.subject != ''">
            and erm.subject like concat('%', #{condition.subject}, '%')
        </if>
        <if test="condition.startDate != null and condition.endDate != null">
            and DATE_FORMAT(eir.rehearsal_time, '%Y-%m-%d' )
            between DATE_FORMAT(#{condition.startDate}, '%Y-%m-%d')
            and DATE_FORMAT(#{condition.endDate}, '%Y-%m-%d')
        </if>
        <if test="condition.type != null">
            and erm.type = #{condition.type}
        </if>
        <if test="condition.orgCode != null and condition.orgCode != ''">
            and erm.org_code = #{condition.orgCode}
        </if>
        <if test="condition.joinOrgCode != null and condition.joinOrgCode != ''">
            and eir.id in (
            select distinct record_id
            from emergency_record_dept
            where org_code = #{condition.joinOrgCode} )
        </if>
        <if test="orgCodes != null and orgCodes.size() > 0">
            and (
                erm.org_code in
            <foreach collection="orgCodes" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
            or
                eir.id in ( select record_id from emergency_record_dept where org_code in
            <foreach collection="orgCodes" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
            ) )
        </if>
        order by eir.create_time desc
    </select>
    <select id="queryLedger" resultType="com.aiurt.boot.rehearsal.dto.EmergencyLedgerDTO">
        SELECT eir.rehearsal_time, erm.`subject`,erq.description,erq.process_mode
        FROM emergency_implementation_record eir
        INNER JOIN emergency_rehearsal_month erm ON erm.id = eir.plan_id
        LEFT JOIN emergency_record_question erq ON erq.record_id = eir.id
        WHERE
        erq.description IS NOT NULL AND erq.description != ''
        <if test="recodeIdList != null and recodeIdList.size() != 0">
            AND eir.id in
            <foreach collection="recodeIdList" item="item" separator="," open="(" close=")">
                #{item}
            </foreach>
        </if>
    </select>
</mapper>
