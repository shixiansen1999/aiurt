<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.system.mapper.SysUserUsageMapper">
    <select id="queryList" resultType="com.aiurt.modules.system.dto.SysUserUsageRespDTO">
        select
            t2.id as user_id,
            t2.username as value,
            t2.username as user_name,
            t2.realname as title,
            t2.realname as label,
            t2.avatar,
            t3.depart_name as org_name,
            GROUP_CONCAT(t5.role_name) as role_name,
            t1.usage_count
        from sys_user_usage t1
        inner join sys_user t2 ON  (t1.personnel_user_name = t2.username)
        left join sys_depart t3 ON (t2.org_id = t2.org_name)
        Left join sys_user_role t4 ON t4.user_id = t2.id
        Left join sys_role  t5 on t4.role_id = t5.id
        where t2.id is not null and t1.user_id = #{id}
        <if test="search != null and search != ''">
            and (t2.realname like concat('%',#{search},'%') or t3.depart_name like concat('%',#{search},'%') or  t5.role_name like concat('%',#{search},'%'))
        </if>
        group by t1.personnel_user_name,t1.user_id
        order by t1.usage_count
        limit 50


    </select>

    <select id="globalSearch" resultType="com.aiurt.modules.system.dto.SysUserUsageRespDTO">
        select
        t2.id as user_id,
        t2.username as value,
        t2.username as user_name,
        t2.realname as title,
        t2.realname as label,
        t2.avatar,
        t3.depart_name as org_name,
        GROUP_CONCAT(t5.role_name) as role_name
        from sys_user t2
        left join sys_depart t3 ON t2.org_id = t3.id
        Left join sys_user_role t4 ON t4.user_id = t2.id
        Left join sys_role  t5 on t4.role_id = t5.id
        where t2.del_flag =  0
        and (t2.realname like concat('%',#{name},'%') or t3.depart_name like concat('%',#{name},'%') or  t5.role_name like concat('%',#{name},'%'))
        group by t2.username
    </select>
</mapper>
