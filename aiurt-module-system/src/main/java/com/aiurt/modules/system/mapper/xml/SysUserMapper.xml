<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.system.mapper.SysUserMapper">

	<!-- 根据用户名查询 -->
	<select id="getUserByName" resultType="com.aiurt.modules.system.entity.SysUser">
		select * from  sys_user  where username = #{username} and del_flag = 0
	</select>

	<!-- 根据部门Id查询 -->
	<select id="getUserByDepId" resultType="com.aiurt.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0 and id in (select user_id from sys_user_depart where dep_id=#{departId})
		<if test="username!=null and username!=''">
			and username = #{username}
		</if>
	</select>

	<!-- 查询用户的所属部门名称信息 -->
	<select id="getDepNamesByUserIds" resultType="com.aiurt.modules.system.vo.SysUserDepVo">
		select d.depart_name,ud.user_id from sys_user_depart ud,sys_depart d where d.id = ud.dep_id and ud.user_id in
		<foreach collection="userIds" index="index" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</select>

	<!-- 通过多个部门IDS，查询部门下的用户信息 -->
	<select id="getUserByDepIds" resultType="com.aiurt.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0
		<if test="departIds!=null  and departIds.size()>0">
			and id in (select user_id from sys_user_depart where dep_id in
			<foreach collection="departIds" index="index" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			)
		</if>
		<if test="username!=null and username!=''">
			and username = #{username}
		</if>
	</select>

	<!-- 根据角色Id查询 -->
	<select id="getUserByRoleId" resultType="com.aiurt.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0 and id in (select user_id from sys_user_role where role_id=#{roleId})
		<if test="username!=null and username!=''">
			and username like concat('%',#{username},'%')
		</if>
	</select>

	<!--  修改用户部门code -->
	<update id="updateUserDepart">
		UPDATE sys_user SET org_code = #{orgCode} where username = #{username}
	</update>

	<!-- 根据手机号查询 -->
	<select id="getUserByPhone"  resultType="com.aiurt.modules.system.entity.SysUser">
		select * from  sys_user  where phone = #{phone} and del_flag = 0
	</select>

	<!-- 根据邮箱查询用户信息 -->
	<select id="getUserByEmail" resultType="com.aiurt.modules.system.entity.SysUser">
	select * from  sys_user  where email = #{email} and del_flag = 0
	</select>

	<!-- SQL片段：getUserByOrgCode 的 FROM 和 WHERE 部分 -->
	<sql id="getUserByOrgCodeFromSql">
		FROM
		sys_depart
		INNER JOIN sys_user_depart ON sys_user_depart.dep_id = sys_depart.id
		INNER JOIN sys_user ON sys_user.id = sys_user_depart.user_id
		WHERE
		<if test="orgCode == null">
			<bind name="bindOrgCode" value="'%'"/>
		</if>
		<if test="orgCode != null">
			<bind name="bindOrgCode" value="orgCode+'%'"/>
		</if>
		sys_user.del_flag = 0 AND sys_depart.org_code LIKE #{bindOrgCode}

		<if test="userParams != null">
			<if test="userParams.realname != null and userParams.realname != ''">
				AND sys_user.realname LIKE concat(concat('%',#{userParams.realname}),'%')
			</if>
			<if test="userParams.workNo != null and userParams.workNo != ''">
				AND sys_user.work_no LIKE concat(concat('%',#{userParams.workNo}),'%')
			</if>
		</if>
	</sql>

	<!-- 根据 orgCode 查询用户，包括子部门下的用户 -->
	<select id="getUserByOrgCode" resultType="com.aiurt.modules.system.model.SysUserSysDepartModel">
		SELECT
			sys_user.id AS id,
			sys_user.realname AS realname,
			sys_user.avatar AS avatar,
			sys_user.work_no AS workNo,
			sys_user.post AS post,
			sys_user.telephone AS telephone,
			sys_user.email AS email,
			sys_user.phone AS phone,
			sys_depart.id AS departId,
			sys_depart.depart_name AS departName
		<include refid="getUserByOrgCodeFromSql"/>
		ORDER BY
			sys_depart.org_code ASC
	</select>

	<!-- 查询 getUserByOrgCode 的总数-->
	<select id="getUserByOrgCodeTotal" resultType="java.lang.Integer">
		SELECT COUNT(1) <include refid="getUserByOrgCodeFromSql"/>
	</select>

	<!-- 批量删除角色的与用户关系-->
	<update id="deleteBathRoleUserRelation">
		delete from sys_user_role
		where role_id in
		<foreach item="id" collection="roleIdArray" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>
	<!-- 批量删除角色的与权限关系-->
	<update id="deleteBathRolePermissionRelation">
		delete from sys_role_permission
		where role_id in
		<foreach item="id" collection="roleIdArray" open="(" separator="," close=")">
			#{id}
		</foreach>
	</update>

	<!-- 查询被逻辑删除的用户 -->
	<select id="selectLogicDeleted" resultType="com.aiurt.modules.system.entity.SysUser">
		SELECT * FROM sys_user ${ew.customSqlSegment}
	</select>

	<!-- 更新被逻辑删除的用户 -->
	<update id="revertLogicDeleted">
		UPDATE
			sys_user
		SET
			del_flag = 0,
			update_by = #{entity.updateBy},
			update_time = #{entity.updateTime}
		WHERE
			del_flag = 1
			AND id IN (${userIds})
	</update>

	<!-- 彻底删除被逻辑删除的用户 -->
	<delete id="deleteLogicDeleted">
		DELETE FROM sys_user WHERE del_flag = 1 AND id IN (${userIds})
	</delete>

    <!-- 更新空字符串为null -->
    <update id="updateNullByEmptyString">
        UPDATE sys_user SET ${fieldName} = NULL WHERE ${fieldName} = ''
    </update>

	<!-- 通过多个部门IDS，查询部门下的用户信息 -->
	<select id="queryByDepIds" resultType="com.aiurt.modules.system.entity.SysUser">
		select * from sys_user where del_flag = 0
		<if test="departIds!=null  and departIds.size()>0">
			and id in (select user_id from sys_user_depart where dep_id in
			<foreach collection="departIds" index="index" item="id" open="(" separator="," close=")">
				#{id}
			</foreach>
			)
		</if>
		<if test="username!=null and username!=''">
			and username != #{username}
		</if>
	</select>

	<select id="getUserListByName" resultType="java.lang.String">
		select username from  sys_user  where realname LIKE concat('%',#{realName},'%')
	</select>
	<select id="queryByOrgCode" resultType="java.lang.String">
		SELECT id  FROM sys_depart
		WHERE del_flag =0
		  and org_code_cc LIKE CONCAT('%' #{code} '%')
	</select>
	<select id="queryByorgIds" resultType="com.aiurt.modules.system.entity.SysUser">
		select distinct sys_user.* from sys_user
		left join sys_user_role sur  on sur.user_id = sys_user.id
		left join sys_role sr  on sr.id = sur.role_id
		where del_flag = 0
		<if test="orgId.size()>0 and orgId!=null">
			AND org_id in
			<foreach item="orgId" collection="orgId" separator="," open="(" close=")" index="">
				#{orgId}
			</foreach>
		</if>
		<if test="status !=null ">
			AND status =#{status}
		</if>
		<if test="username !=null ">
			AND username LIKE CONCAT ('%', #{username}, '%')
		</if>
		<if test="realname !=null ">
		AND realname LIKE CONCAT ('%', #{realname}, '%')
		</if>
		<if test="phone !=null ">
			AND phone LIKE CONCAT ('%', #{phone}, '%')
		</if>
		<if test="roleCode != null and roleCode != '' ">
			AND sr.role_code =#{roleCode}
		</if>
	</select>
	<select id="getDepartIds" resultType="java.lang.String">
		select depart_name from sys_depart where   del_flag = 0
		<if test="asList.size()>0">
			AND id in
			<foreach item="asList" collection="asList" separator="," open="(" close=")" index="">
				#{asList}
			</foreach>
		</if>
	</select>

	<select id="querySysUserForWorkTicket" resultType="com.aiurt.modules.system.entity.SysUser">
		select distinct a.* from sys_user a
		Left join sys_user_role b On a.id = b.user_id
		left join sys_role sr on b.role_id = sr.id
		where a.del_flag = 0 and a.status = 1
		<if test="list != null and list.size() != 0">
			and sr.role_code in
			<foreach collection="list" item="item" close=")" open="(" separator=",">
				#{item}
			</foreach>
		</if>
    </select>

	<select id="queryUserListByName" resultType="com.aiurt.modules.system.entity.SysUser" parameterType="list">
		select distinct * from  sys_user  where del_flag = 0
		<if test="usernameList != null and usernameList.size() != 0">
			and  (username  in
			<foreach collection="usernameList" separator="," open="(" item="item" close=")">
				#{item}
			</foreach>
			or realname in
			<foreach collection="usernameList" separator="," open="(" item="item" close=")">
				#{item}
			</foreach>
			or id in
			<foreach collection="usernameList" separator="," open="(" item="item" close=")">
				#{item}
			</foreach>
			)
		</if>
	</select>

	<select id="getUserName" resultType="java.lang.String">
		select username from sys_user where del_flag = 0 and realname =#{realName}
	</select>
	<select id="getUserLikeName" resultType="java.lang.String">
		select username from sys_user where del_flag = 0 and realname LIKE CONCAT ('%', #{realName}, '%')
	</select>
    <select id="getSysRole" resultType="java.lang.String">
		select id from sys_role where
		<if test="list != null and list.size() != 0">
			role_name in
			<foreach collection="list" item="item" close=")" open="(" separator=",">
				#{item}
			</foreach>
		</if>
	</select>

	<select id="getUserByRealName" resultType="org.jeecg.common.system.vo.LoginUser">
		select * from  sys_user  where  del_flag = 0
		<if test="realName != null and realName != ''">
			and realname = #{realName}
		</if>
		<if test="workNo != null and workNo != ''">
			and work_no = #{workNo}
		</if>
    </select>
    <select id="getUserNameByOrgCodeAndRoleCode" resultType="java.lang.String">
		SELECT DISTINCT su.username
		FROM sys_user_role sur
		JOIN sys_user su ON sur.user_id = su.id AND su.del_flag = 0
		JOIN sys_role sr ON sur.role_id = sr.id
	    <where>
	    <if test="orgCode !=null and orgCode.size()>0">
			su.org_code in
			<foreach collection="orgCode" open="(" close=")" separator="," item="code">
             #{code}
			</foreach>
		</if>
		<if test="roleCode !=null and roleCode.size()>0 ">
			and sr.role_code in
			<foreach collection="roleCode" open="(" close=")" separator="," item="code">
				#{code}
			</foreach>
			</if>
		</where>
	</select>

	<select id="getUserNameByDeptAuthCodeAndRoleCode" resultType="java.lang.String">
		SELECT DISTINCT su.username
		FROM sys_user_role sur
				 JOIN sys_user su ON sur.user_id = su.id AND su.del_flag = 0
				 JOIN sys_role sr ON sur.role_id = sr.id
				 JOIN cs_user_depart cud ON sur.user_id = cud.user_id
				 JOIN sys_depart sd ON cud.depart_id = sd.id AND sd.del_flag = 0
		<where>
			<if test="orgCodes != null and orgCodes.size() > 0">
				sd.org_code in
				<foreach collection="orgCodes" open="(" close=")" separator="," item="code">
					#{code}
				</foreach>
			</if>
			<if test="roleCodes != null and roleCodes.size() > 0">
				and sr.role_code in
				<foreach collection="roleCodes" open="(" close=")" separator="," item="code">
					#{code}
				</foreach>
			</if>
		</where>
	</select>

	<select id="selectTableName" resultType="java.lang.String">
		SELECT
	     table_name as tableName
       FROM
	     information_schema.TABLES
	   WHERE
	    table_schema = #{dbName}
	    AND table_name = #{tableName}
	</select>
	<select id="getUserByCodes" resultType="org.jeecg.common.system.vo.LoginUser">
	select *
	from sys_user
	where  del_flag = 0
	<if test="orgCodes != null and orgCodes.size() != 0">
	and org_code in
	<foreach collection="orgCodes" open="(" separator="," close=")" item="item">
	#{item}
    </foreach>
	</if>
</select>


	<select id="getRealNameMap" resultType="java.util.Map">
		SELECT
			su.id as "userId",su.realname as "realname"
		FROM
			sys_user su
        WHERE
			su.del_flag=0
        AND
			su.org_id like #{orgId}
	</select>

	<select id="getRealNameByOrgCodeAndRoleCode" resultType="java.lang.String">
		SELECT DISTINCT su.realname
		FROM sys_user_role sur
		JOIN sys_user su ON sur.user_id = su.id AND su.del_flag = 0
		JOIN sys_role sr ON sur.role_id = sr.id
		<where>
			<if test="orgCode !=null and orgCode.size()>0">
				su.org_code in
				<foreach collection="orgCode" open="(" close=")" separator="," item="code">
					#{code}
				</foreach>
			</if>
			<if test="roleCode !=null and roleCode.size()>0 ">
				and sr.role_code in
				<foreach collection="roleCode" open="(" close=")" separator="," item="code">
					#{code}
				</foreach>
			</if>
		</where>
	</select>

	<select id="getSeniorityNumber" resultType="org.jeecg.common.system.vo.LoginUser">
		select su.id, su.username, su.working_time
		from sys_user su
		where su.del_flag = 0
		  and su.org_code = #{orgCode}
		group by su.id
	</select>

	<select id="getRoleNamesByUserIds" resultType="java.util.Map">
		SELECT
			su.id AS userId,
			group_concat(sr.role_name) AS roleName
		FROM sys_user su
		INNER JOIN sys_user_role sur on su.id=sur.user_id
		INNER JOIN sys_role sr ON sr.id=sur.role_id
		<where>
			<if test="userIds != null and userIds.size() != 0">
				su.id IN
				<foreach collection="userIds" item="item" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
		</where>
		GROUP BY su.id
	</select>
	<select id="getUserNameByParams" resultType="java.lang.String">
		<if test="posts!=null and posts.size()>0">
			select username from sys_user where status =1 and del_flag=0 and
			<foreach collection="posts" separator="or" open="(" close=")" item="post">
				find_in_set(#{post}, job_name) > 0
			</foreach>
		</if>
		<if test="orgIds!=null and orgIds.size()>0">
			<if test="posts!=null and posts.size()>0">
				union
			</if>
			select distinct
			su.username username
			from
			sys_user su
			where
			su.STATUS = 1
			and su.del_flag = 0
			and su.org_id in
			<foreach collection="orgIds" separator="," open="(" close=")" item="orgId">
				#{orgId}
			</foreach>
		</if>
		<if test="roleCodes!=null and roleCodes.size()>0">
			<if test="orgIds!=null and orgIds.size()>0">
				union
			</if>
			select distinct
			su.username username
			from
			sys_user su
			left join sys_user_role sur on sur.user_id = su.id
			left join sys_role sr on sr.id = sur.role_id
			where
			su.status = 1
			and su.del_flag = 0
			and sr.role_code in
			<foreach collection="roleCodes" separator="," open="(" close=")" item="roleCode">
				#{roleCode}
			</foreach>
		</if>
	</select>
</mapper>
