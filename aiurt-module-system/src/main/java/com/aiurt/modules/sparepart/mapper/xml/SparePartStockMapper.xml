<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.sparepart.mapper.SparePartStockMapper">
    <select id="readAll" resultType="com.aiurt.modules.sparepart.entity.SparePartStock">
        SELECT
        distinct
        spare_part_stock.id,
        t1.warehouse_code,
        t1.organization_id as orgId,
        t1.warehouse_name warehouseName,
        spare_part_stock.material_code materialCode,
        t2.NAME,
        spare_part_stock.num,
        cs_major.major_name majorName,
        cs_subsystem.system_name systemName,
        t5.base_type_name baseTypeCodeName,
        d1.item_text typeName,
        sys_depart.depart_name orgName,
        t2.specifications,
        t7.`name` manufactorCodeName,
        d3.item_text unit,
        t2.price,
        t2.consumables_type,
        spare_part_stock.minimum_stock
        FROM
        spare_part_stock spare_part_stock
        LEFT JOIN spare_part_stock_info t1 ON ( spare_part_stock.warehouse_code = t1.warehouse_code AND t1.del_flag = 0  )
        LEFT JOIN material_base t2 ON ( spare_part_stock.material_code = t2.CODE AND t2.del_flag = 0 )
        LEFT JOIN cs_major cs_major ON ( t2.major_code = cs_major.major_code AND cs_major.del_flag = 0 )
        LEFT JOIN cs_subsystem cs_subsystem ON ( t2.system_code = cs_subsystem.system_code AND cs_subsystem.del_flag = 0 )
        LEFT JOIN material_base_type t5 ON ( t2.base_type_code = t5.base_type_code AND t5.del_flag = 0 )
        LEFT JOIN sys_depart sys_depart ON ( sys_depart.id = spare_part_stock.org_id AND sys_depart.del_flag = 0 )
        LEFT JOIN sys_dict AS dict1 ON dict1.dict_code = 'material_type'
        LEFT JOIN sys_dict_item AS d1 ON ( d1.item_value = t2.type AND dict1.id = d1.dict_id )
        LEFT JOIN cs_manufactor t7 ON t7.id = t2.manufactor_code
        LEFT JOIN sys_dict AS dict3 ON dict3.dict_code = 'materian_unit'
        LEFT JOIN sys_dict_item AS d3 ON (
        d3.item_value = t2.unit
        AND dict3.id = d3.dict_id)
        WHERE
        spare_part_stock.del_flag =0
        and spare_part_stock.num>0
        <if test="stock.materialCode!=null and stock.materialCode!=''">
            and spare_part_stock.material_code like concat('%',  #{stock.materialCode}, '%')
        </if>
        <if test="stock.name!=null and stock.name!=''">
            and t2.`name` like concat('%', #{stock.name}, '%')
        </if>
        <if test="stock.type!=null and stock.type!=''">
            and t2.type = #{stock.type}
        </if>
        <if test="stock.majorCode!=null and stock.majorCode!=''">
            and cs_major.major_code like concat('%', #{stock.majorCode}, '%')
        </if>
        <if test="stock.systemCode!=null and stock.systemCode!=''">
            and cs_subsystem.system_code like concat('%', #{stock.systemCode}, '%')
        </if>
        <if test="stock.baseTypeCode!=null and stock.baseTypeCode!=''">
            and t5.base_type_code like concat('%', #{stock.baseTypeCode}, '%')
        </if>
        <if test="stock.orgId!=null and stock.orgId!=''">
            and spare_part_stock.org_id not in (#{stock.orgId})
        </if>
        <if test="stock.num != null and stock.num != ''">
            and spare_part_stock.num <![CDATA[ <> ]]> 0
        </if>
        <if test="stock.warehouseCode!=null and stock.warehouseCode!=''">
            and t1.warehouse_code = #{stock.warehouseCode}
        </if>
        <if test="stock.warehouseName!=null and stock.warehouseName!=''">
            and t1.warehouse_name = #{stock.warehouseName}
        </if>
        <if test="stock.num!=null and stock.num!=''">
            and spare_part_stock.num <![CDATA[ <> ]]>  0
        </if>
        <if test="stock.minimumStock != null and stock.minimumStock == 0">
            and spare_part_stock.num &lt; spare_part_stock.minimum_stock
        </if>
        <if test="stock.minimumStock != null and stock.minimumStock == 1">
            and spare_part_stock.num > spare_part_stock.minimum_stock
        </if>
        <if test="stock.consumablesType != null and stock.consumablesType == 0">
             and t2.consumables_type = 0
        </if>
        <if test="stock.consumablesType != null and stock.consumablesType == 1">
             and t2.consumables_type = 1
        </if>
        order by spare_part_stock.create_time desc
    </select>

    <select id="stockCount" resultType="java.lang.Long">
        SELECT
        ifnull (SUM( stock_level2.num ),0) AS sum
        FROM
        stock_level2 stock_level2
        LEFT JOIN material_base mb ON stock_level2.material_code = mb.
        CODE LEFT JOIN stock_level2_info stock_level2i ON stock_level2.warehouse_code = stock_level2i.warehouse_code
        AND stock_level2i.del_flag = 0
        LEFT JOIN cs_major cm ON mb.major_code = cm.major_code
        AND cm.del_flag = 0
        LEFT JOIN cs_subsystem cs ON mb.system_code = cs.system_code
        AND cs.del_flag = 0
        <where>
            stock_level2.del_flag = 0
            <if test="systemCode != null and systemCode.size()!=0">
                and stock_level2.system_code in
                <foreach collection="systemCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="baseTypeCode != null and baseTypeCode.size()!=0">
                and mb.base_type_code in
                <foreach collection="baseTypeCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="sparePartCount" resultType="java.lang.Long">
        SELECT
        ifnull (SUM( spare_part_stock.num ),0) AS sum
        FROM
        spare_part_stock spare_part_stock
        LEFT JOIN spare_part_stock_info t1 ON spare_part_stock.warehouse_code = t1.warehouse_code
        LEFT JOIN material_base t2 ON spare_part_stock.material_code = t2.
        CODE LEFT JOIN cs_major cs_major ON t2.major_code = cs_major.major_code
        LEFT JOIN cs_subsystem cs_subsystem ON t2.system_code = cs_subsystem.system_code
        LEFT JOIN material_base_type t5 ON t2.base_type_code = t5.base_type_code
        LEFT JOIN sys_depart sys_depart ON sys_depart.id = spare_part_stock.org_id
        LEFT JOIN sys_dict AS dict1 ON dict1.dict_code = 'material_type'
        LEFT JOIN sys_dict_item AS d1 ON d1.item_value = t2.type
        AND dict1.id = d1.dict_id
        LEFT JOIN cs_manufactor t7 ON t7.id = t2.manufactor_code
        LEFT JOIN sys_dict AS dict3 ON dict3.dict_code = 'materian_unit'
        LEFT JOIN sys_dict_item AS d3 ON d3.item_value = t2.unit
        AND dict3.id = d3.dict_id
        <where>
            spare_part_stock.del_flag = 0
            <if test="systemCode != null and systemCode.size()!=0">
                and cs_subsystem.system_code in
                <foreach collection="systemCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="baseTypeCode != null and baseTypeCode.size()!=0">
                and t5.base_type_code in
                <foreach collection="baseTypeCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getSubsystemByUserId" resultType="com.aiurt.modules.sparepart.entity.dto.SparePartStatistics">
        select cs.system_code as systemCode,cs.system_name as systemName,cs.id as id
        from cs_user_subsystem cus
        left join cs_subsystem cs on cs.id = cus.system_id
        where cs.del_flag = 0
        <if test="id != null and id != ''">
            and cus.user_id = #{id}
        </if>
        <if test="systemCode != null and systemCode.size()!=0">
            and cs.system_code in
            <foreach collection="systemCode" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="timeCount" resultType="java.lang.Long">
        SELECT
        ifnull (SUM(t6.new_spare_part_num),0) as sum
        FROM
        spare_part_out_order spare_part_out_order
        LEFT JOIN material_base t1 ON ( spare_part_out_order.material_code = t1.CODE AND t1.del_flag = 0 )
        LEFT JOIN cs_major cs_major ON ( t1.major_code = cs_major.major_code AND cs_major.del_flag = 0 )
        LEFT JOIN cs_subsystem cs_subsystem ON ( t1.system_code = cs_subsystem.system_code AND cs_subsystem.del_flag = 0 )
        LEFT JOIN material_base_type t4 ON (t1.base_type_code = t4.base_type_code AND t4.del_flag = 0)
        LEFT JOIN device_change_spare_part t6 ON(t6.lend_out_order_id = spare_part_out_order.id or t6.borrowing_out_order_id = spare_part_out_order.id  )
        <where>
                spare_part_out_order.del_flag =0
            <if test="systemCode != null and systemCode.size()!=0">
                and t4.system_code in
                <foreach collection="systemCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="baseTypeCode != null and baseTypeCode.size()!=0">
                and t4.base_type_code in
                <foreach collection="baseTypeCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="year != null">
                and YEAR(t6.create_time) = #{year}
            </if>
            <if test="month != null">
                and MONTH(t6.create_time) = #{month}
            </if>
        </where>
    </select>

    <select id="getTimeCount" resultType="java.lang.Long">
        SELECT
        ifnull (SUM(t6.new_spare_part_num),0) as sum
        FROM
        spare_part_out_order spare_part_out_order
        LEFT JOIN material_base_type t4 ON spare_part_out_order.material_code = t4.base_type_code
        LEFT JOIN device_change_spare_part t6 ON t6.out_order_id = spare_part_out_order.id
        <where>
            spare_part_out_order.del_flag =0
            <if test="systemCode != null and systemCode.size()!=0">
                and t4.system_code in
                <foreach collection="systemCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="baseTypeCode != null and baseTypeCode.size()!=0">
                and t4.base_type_code in
                <foreach collection="baseTypeCode" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="startDate != null and endDate != null">
                and DATE_FORMAT(t6.create_time ,'%Y-%m') &gt;= DATE_FORMAT(#{startDate} ,'%Y-%m')
                and DATE_FORMAT(t6.create_time ,'%Y-%m') &lt;= DATE_FORMAT(#{endDate} ,'%Y-%m')
            </if>
        </where>
    </select>
    <select id="selectAppList" resultType="com.aiurt.modules.sparepart.entity.SparePartStock">
        SELECT
        spare_part_stock.id,
        t1.warehouse_code,
        t1.warehouse_name warehouseName,
        spare_part_stock.material_code materialCode,
        t2.NAME,
        spare_part_stock.num,
        cs_major.major_name majorName,
        cs_subsystem.system_name systemName,
        t5.base_type_name baseTypeCodeName,
        d1.item_text typeName,
        sys_depart.depart_name orgName,
        t2.specifications,
        t7.`name` manufactorCodeName,
        d3.item_text unit,
        t2.price
        FROM
        spare_part_stock spare_part_stock
       	LEFT JOIN spare_part_stock_info t1 ON ( spare_part_stock.warehouse_code = t1.warehouse_code AND t1.del_flag = 0 )
	    LEFT JOIN material_base t2 ON ( spare_part_stock.material_code = t2.CODE AND t2.del_flag = 0 )
	    LEFT JOIN cs_major cs_major ON ( t2.major_code = cs_major.major_code AND cs_major.del_flag = 0 )
	    LEFT JOIN cs_subsystem cs_subsystem ON ( t2.system_code = cs_subsystem.system_code AND cs_subsystem.del_flag = 0 )
	    LEFT JOIN material_base_type t5 ON ( t2.base_type_code = t5.base_type_code AND t5.del_flag = 0 )
	    LEFT JOIN sys_depart sys_depart ON ( sys_depart.id = spare_part_stock.org_id AND sys_depart.del_flag = 0 )
	    LEFT JOIN sys_dict AS dict1 ON dict1.dict_code = 'material_type'
	    LEFT JOIN sys_dict_item AS d1 ON ( d1.item_value = t2.type AND dict1.id = d1.dict_id )
	    LEFT JOIN cs_manufactor t7 ON t7.id = t2.manufactor_code
	    LEFT JOIN sys_dict AS dict3 ON dict3.dict_code = 'materian_unit'
	    LEFT JOIN sys_dict_item AS d3 ON (
	d3.item_value = t2.unit
	AND dict3.id = d3.dict_id)
        WHERE
        spare_part_stock.del_flag =0
        and spare_part_stock.num>0
        <if test="text!=null and text!=''">
            and (spare_part_stock.material_code like concat('%',  #{text}, '%')  or t2.`name` like concat('%', #{text}, '%')
            or t1.warehouse_name like concat('%',  #{text}, '%'))
        </if>
        <if test="orgId!=null and orgId!=''">
            and spare_part_stock.org_id = #{orgId}
        </if>
        order by spare_part_stock.create_time desc
    </select>
</mapper>
