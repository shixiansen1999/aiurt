<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.usageconfig.mapper.UsageConfigMapper">
    <select id="getList" resultType="com.aiurt.modules.usageconfig.dto.UsageConfigDTO">
    select *
    from sys_usage_config
</select>
    <select id="getAllList" resultType="com.aiurt.modules.usageconfig.dto.UsageConfigDTO">
        select *,
               rank() over ( partition by pid order by sequence)
        from sys_usage_config
    </select>
    <select id="getTotal" resultType="java.lang.Long">
        select
        count(*)
        from
        ${tableName}
        <where>
            <if test="staCondition != null">
                ${staCondition}
            </if>
        </where>
    </select>
    <select id="getNewNumber" resultType="java.lang.Long">
        select
        count(*)
        from ${tableName}
        <where>
        <if test="startTime != null and endTime != null">
             create_time between  #{startTime} and  #{endTime}
        </if>
        <if test="staCondition != null and staCondition != ''">
           and ${staCondition}
        </if>
        </where>


    </select>

    <select id="getChildrenList" resultType="com.aiurt.modules.usageconfig.entity.UsageConfig">
        SELECT *,
               rank() over ( partition by pid order by sequence)
        FROM
                ( SELECT * FROM sys_usage_config WHERE pid > 0 ORDER BY pid, id DESC ) realname_sorted,
                ( SELECT @pv := #{id} ) initialisation
        WHERE
                (
                        FIND_IN_SET( pid, @pv COLLATE utf8mb4_general_ci )> 0
                                AND @pv := concat( @pv, ',', id ));
    </select>

    <select id="selectByPage" resultType="com.aiurt.modules.usageconfig.dto.UsageStatDTO">
        SELECT id,
               pid,
               `name` as tile_name,
               table_name,
               sta_condition,
               rank()    over ( partition by pid order by sequence)
        FROM
            sys_usage_config
        WHERE
            pid IN (SELECT id from sys_usage_config where `code` = #{code})
          AND state = 1
    </select>


    <select id="selectByPages" resultType="com.aiurt.modules.usageconfig.entity.UsageConfig">
        SELECT id,
               pid,
               `name` as name,
               table_name,
               sta_condition,
               rank()    over ( partition by pid order by sequence)
        FROM
        sys_usage_config
        WHERE
        pid IN (SELECT id from sys_usage_config where `code` = #{code})
        AND state = 1
    </select>
</mapper>
