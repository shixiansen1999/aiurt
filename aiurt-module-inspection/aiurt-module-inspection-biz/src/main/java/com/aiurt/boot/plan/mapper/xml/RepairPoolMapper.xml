<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.plan.mapper.RepairPoolMapper">
    <resultMap id="query_major_map" type="com.aiurt.boot.manager.dto.MajorDTO">
        <result column="major_code" property="majorCode"></result>
        <result column="major_name" property="majorName"></result>
        <collection property="subsystemDTOList" javaType="list" ofType="com.aiurt.boot.manager.dto.SubsystemDTO">
            <result column="system_code" property="systemCode"></result>
            <result column="system_name" property="systemName"></result>
        </collection>
    </resultMap>
    <resultMap id="codemap" type="com.aiurt.boot.plan.dto.CodeManageDTO">
        <result column="code" property="code"/>
        <collection property="list" ofType="string"/>
    </resultMap>
    <resultMap id="stacode" type="com.aiurt.boot.plan.dto.CodeManageDTO">
        <result column="code" property="code"/>
        <collection property="stationDTOS" ofType="com.aiurt.boot.plan.dto.StationDTO">
            <result property="stationCode" column="stationCode"/>
            <result property="lineCode" column="lineCode"/>
            <result property="positionCode" column="positionCode"/>
        </collection>

    </resultMap>
    <select id="queryList" resultType="com.aiurt.boot.plan.entity.RepairPool">

    </select>
    <select id="queryMajorList" resultMap="query_major_map">
        SELECT cm.major_code,cm.major_name,cs.system_code,cs.system_name FROM cs_major cm
        LEFT JOIN cs_subsystem cs ON cs.major_code = cm.major_code
        <where>
            cm.del_flag = 0 and cs.del_flag=0
            <if test="majorCode.size()>0">
                and cm.major_code in
                <foreach collection="majorCode" item="code" separator="," open="(" close=")">
                    #{code}
                </foreach>
            </if>
            <if test="subSystemCode.size()>0">
                and cs.system_code in
                <foreach collection="subSystemCode" item="code" separator="," open="(" close=")">
                    #{code}
                </foreach>
            </if>
        </where>
    </select>
    <select id="queryStandardByCode" resultType="com.aiurt.boot.plan.entity.RepairPoolCode">
        select major_code,subsystem_code from repair_pool_code rpc
        left join repair_pool_rel rpr on rpr.repair_pool_sta_id = rpc.id
        left join repair_pool rp on rp.code = rpr.repair_pool_code
        where  rp.code = #{planCode} and rpc.del_flag =0 and rpr.del_flag= 0 and rp.del_flag = 0
    </select>
    <select id="selectOrgByCode" resultType="java.lang.String">
        select org_code from  repair_pool_org_rel where del_flag = 0 and repair_pool_code = #{planCode}
    </select>
    <select id="getCodeByMajor" resultType="java.lang.String">
        SELECT DISTINCT repair_pool_code FROM repair_pool_rel rpr
        LEFT JOIN repair_pool_code rpc ON rpc.id = rpr.repair_pool_sta_id
        <where>
            rpr.del_flag =0
            <if test="majorList.size()>0">
                and rpc.major_code in
                <foreach collection="majorList" separator="," open="(" close=")" item="majorcode">
                    #{majorcode}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getInspectionData" resultType="com.aiurt.boot.index.dto.InspectionDTO">
        select distinct rp.`code`,rp.weeks,rp.`status`,ifnull(rt.id,rp.id) as taskId from repair_pool rp
        left join repair_pool_org_rel rpor on rpor.repair_pool_code = rp.code
        LEFT JOIN repair_pool_station_rel rr ON rr.repair_pool_code = rp.`code`
        LEFT JOIN repair_task AS rt ON rt.repair_pool_id = rp.id
        <where>
            rp.del_flag = 0
            <if test="beginDate!=null and endDate!=null">
                and date_format(rp.start_time ,'%Y-%m-%d') &gt;= date_format(#{beginDate} ,'%Y-%m-%d')
                and date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{endDate} ,'%Y-%m-%d')
            </if>
            <if test="orgCodes.size()>0">
                and rpor.org_code in
                <foreach collection="orgCodes" separator="," open="(" close=")" item="code">
                    #{code}
                </foreach>
            </if>
            <if test="item!=null and item==2">
                and rp.`status` = 8
            </if>
            <if test="lineCode != null and lineCode != ''">
                and rr.line_code = #{lineCode}
            </if>
        </where>
    </select>
    <select id="getInspectionTodayData" resultType="com.aiurt.boot.index.dto.InspectionDTO">
        select  distinct code,weeks,status from repair_pool rp
        left join repair_pool_org_rel rpor on rpor.repair_pool_code = rp.code
        <where>
            rp.del_flag = 0
            <if test="date!=null">
                and date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{date},'%Y-%m-%d')
                and date_format(rp.end_time ,'%Y-%m-%d') &gt;=date_format(#{date},'%Y-%m-%d')
            </if>
            <if test="codeList.size()>0">
                and rpor.org_code in
                <foreach collection="codeList" separator="," open="(" close=")" item="code">
                    #{code}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getNumByTimeAndOrgCode" resultType="com.aiurt.boot.index.dto.PlanIndexDTO">
    SELECT
	count( DISTINCT temp.id ) AS sum,
	sum( CASE WHEN temp.`status` = 8 THEN 1 ELSE 0 END ) AS finish,
	sum( CASE WHEN temp.`status` = 8 THEN 0 ELSE 1 END ) AS unfinish
    FROM
	(
	SELECT DISTINCT rp.id,rp.CODE,rp.`status` FROM repair_pool rp
	LEFT JOIN repair_pool_org_rel rpor ON rpor.repair_pool_code = rp.CODE
	<where>
        rp.del_flag = 0
        <if test="orgCode!=null and orgCode != ''">
            and  rpor.org_code  = #{orgCode}
        </if>
        <if test="beginDate!=null and endDate!=null">
            and date_format(rp.start_time ,'%Y-%m-%d') &gt;= date_format(#{beginDate} ,'%Y-%m-%d')
            and date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{endDate} ,'%Y-%m-%d')
        </if>
    </where>
	) temp
    </select>
    <select id="getInspectionDataNoPage" resultType="com.aiurt.boot.index.dto.InspectionDTO">
        select distinct code,weeks,status from repair_pool rp
        left join repair_pool_org_rel rpor on rpor.repair_pool_code = rp.code
        <where>
            rp.del_flag = 0
            <if test="beginDate!=null and endDate!=null">
                and date_format(rp.start_time ,'%Y-%m-%d') &gt;= date_format(#{beginDate} ,'%Y-%m-%d')
                and date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{endDate} ,'%Y-%m-%d')
            </if>
            <if test="orgCodes.size()>0">
                and rpor.org_code in
                <foreach collection="orgCodes" separator="," open="(" close=")" item="code">
                    #{code}
                </foreach>
            </if>
            <if test="item!=null and item==2">
                and status = 8
            </if>
        </where>
    </select>
    <select id="getInspectionTodayDataNoPage" resultType="com.aiurt.boot.index.dto.InspectionDTO">
        select  distinct code,weeks,status from repair_pool rp
        left join repair_pool_org_rel rpor on rpor.repair_pool_code = rp.code
        <where>
            rp.del_flag = 0
            <if test="date!=null">
                and date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{date},'%Y-%m-%d')
                and date_format(rp.end_time ,'%Y-%m-%d') &gt;=date_format(#{date},'%Y-%m-%d')
            </if>
            <if test="orgCodes.size()>0">
                and rpor.org_code in
                <foreach collection="orgCodes" separator="," open="(" close=")" item="code">
                    #{code}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectOrgByCodes" parameterType="list" resultMap="codemap">
     select  org_code as list,repair_pool_code as code from  repair_pool_org_rel where del_flag = 0
     <if test="taskCodes.size()>0">
         and repair_pool_code in
         <foreach collection="taskCodes" item="code" open="(" close=")" separator=",">
             #{code}
         </foreach>
     </if>
    </select>
    <select id="selectStationList"  resultMap="stacode">
    select repair_pool_code as code,station_code as stationCode,position_code as positionCode,line_code  as lineCode from repair_pool_station_rel
    where del_flag = 0
        <if test="taskCodes.size()>0">
            and repair_pool_code in
            <foreach collection="taskCodes" item="code" open="(" close=")" separator=",">
                #{code}
            </foreach>
        </if>
    </select>

    <select id="getList" resultType="com.aiurt.boot.plan.entity.RepairPool">
        select rt.year,rt.code,rt.type,rt.weeks,rt.start_time,rt.end_time,rt.status from repair_task rt
        left join repair_pool rp on rt.repair_pool_id = rp.id
        left join repair_pool_org_rel t2 on rp.code = t2.repair_pool_code
        left join repair_pool_station_rel t3 on rp.code = t3.repair_pool_code
        left join repair_pool_rel t4 on rp.code = t4.repair_pool_code
        left join repair_pool_code t5 on t4.repair_pool_sta_id = t4.id
        where rt.del_flag = 0
        and date_format(rt.start_time ,'%Y-%m-%d') &gt;=date_format(#{startDate} ,'%Y-%m-%d')
        and date_format(rt.start_time ,'%Y-%m-%d') &lt;=date_format(#{endDate} ,'%Y-%m-%d')
    </select>
    <select id="getOverviewInfo" resultType="com.aiurt.boot.plan.entity.RepairPool">
        SELECT
        DISTINCT rp.id,rp.`status`
        FROM
        repair_pool AS rp
        LEFT JOIN repair_pool_station_rel AS rpsr ON rpsr.repair_pool_code = rp.`code`
        LEFT JOIN repair_pool_org_rel AS rpor ON rpor.repair_pool_code = rp.code
        LEFT JOIN repair_pool_rel AS rpr ON rpr.repair_pool_code = rp.code
        LEFT JOIN repair_pool_code AS rpc ON rpc.id = rpr.repair_pool_sta_id
        <where>
            rp.start_time IS NOT NULL
            <if test="startDate!=null and endDate!=null">
                AND date_format(rp.start_time ,'%Y-%m-%d') &gt;= date_format(#{startDate},'%Y-%m-%d')
                AND date_format(rp.start_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
        </where>
    </select>
    <select id="selectRepairPool" resultType="com.aiurt.boot.plan.entity.RepairPool">
        SELECT
        rp.id,
        rp.`status`,
        rp.`name`,
        rp.`code`,
        rp.weeks,
        rp.type,
        rp.inspection_str_code,
        rp.start_time,
        rp.end_time
        FROM
            repair_pool rp
        LEFT JOIN repair_pool_rel AS rpr ON rpr.repair_pool_code = rp.`code`
        LEFT JOIN repair_pool_code AS rpc ON rpc.id = rpr.repair_pool_sta_id
        LEFT JOIN repair_pool_station_rel AS rpsr ON rpsr.repair_pool_code = rp.`code`
        LEFT JOIN repair_pool_org_rel AS rpor ON rpor.repair_pool_code = rp.`code`
        <where>
            rp.del_flag = 0
            <if test="selectPlanReq.startTime != null and selectPlanReq.endTime != null">
                AND rp.start_time &gt;= #{selectPlanReq.startTime}
                AND rp.start_time &lt;= #{selectPlanReq.endTime}
            </if>
            <if test="selectPlanReq.code != null and selectPlanReq.code != null">
                AND rp.code =#{selectPlanReq.code}
            </if>
            <if test="selectPlanReq.type != null">
                AND rp.type =#{selectPlanReq.type}
            </if>
            <if test="selectPlanReq.isManual != null">
                AND rp.is_manual = #{selectPlanReq.isManual}
            </if>
            <if test="selectPlanReq.status != null">
                AND rp.status = #{selectPlanReq.status}
            </if>
            <if test="selectPlanReq.workType != null">
                AND rp.work_type = #{selectPlanReq.workType}
            </if>
            <if test="selectPlanReq.statusList != null and !selectPlanReq.statusList.isEmpty()">
                AND rp.status IN
                <foreach item="statusItem" collection="selectPlanReq.statusList" separator="," open="(" close=")">
                    #{statusItem}
                </foreach>
            </if>
            <if test="selectPlanReq.orgCodeList != null and !selectPlanReq.orgCodeList.isEmpty()">
                AND rpor.org_code IN
                <foreach item="item" collection="selectPlanReq.orgCodeList" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
            <if test="selectPlanReq.stationCodeList != null and !selectPlanReq.stationCodeList.isEmpty()">
                AND rpsr.station_code IN
                <foreach item="item" collection="selectPlanReq.stationCodeList" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        GROUP BY rp.id
        ORDER BY rp.start_time ASC, rp.type ASC, rp.create_time DESC
    </select>
</mapper>
