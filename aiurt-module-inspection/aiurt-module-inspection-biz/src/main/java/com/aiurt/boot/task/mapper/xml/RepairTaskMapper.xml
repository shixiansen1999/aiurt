<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.RepairTaskMapper">
    <select id="selectables" resultType="com.aiurt.boot.task.entity.RepairTask">
        SELECT
        t1.*,
        t8.start_time as startOverhaulTime,
        t8.end_time as endOverhaulTime,
        t8.device_code as equipmentCode,
        t8.code as overhaulCode,
        rp.inspection_str_code,
        rp.is_manual
        FROM
        repair_task t1
        LEFT JOIN repair_task_org_rel t2 ON t1.`code` = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t4 ON t1.`code` = t4.repair_task_code
        LEFT JOIN repair_task_standard_rel t6 ON t1.id=t6.repair_task_id
        LEFT JOIN repair_task_device_rel t8 ON t1.id = t8.repair_task_id
        LEFT JOIN repair_pool rp ON t1.repair_pool_id=rp.id
        <where>
            t1.del_flag =0
            <if test="condition.id!=null ">
                and t1.id = #{condition.id}
            </if>
            <if test="condition.code!=null ">
                and t1.code LIKE CONCAT ('%', #{condition.code}, '%')
            </if>
            <if test="condition.type!=null ">
                and t1.type = #{condition.type}
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
            <if test="condition.orgCode!=null ">
                and t2.org_code = #{condition.orgCode}
            </if>
            <if test="condition.siteCode!=null and condition.siteCode!='' ">
                and t4.station_code = #{condition.siteCode}
            </if>
            <if test="condition.workType!=null ">
                and t1.work_type = #{condition.workType}
            </if>
            <if test="condition.time1!=null and condition.time2!=null ">
                and DATE_FORMAT(t1.start_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.time1}, '%Y-%m-%d')
                and DATE_FORMAT(t1.end_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.time2}, '%Y-%m-%d')
            </if>
            <if test="condition.weekStartTime!=null and condition.weekEndTime!=null ">
                and DATE_FORMAT(t1.start_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.weekStartTime}, '%Y-%m-%d')
                and DATE_FORMAT(t1.start_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.weekEndTime}, '%Y-%m-%d')
            </if>
            <if test="condition.codeList!=null and condition.codeList.size()>0">
                and t1.code in
                <foreach collection="condition.codeList" open="(" close=")" separator="," item="code">
                    #{code}
                </foreach>
            </if>
        </where>
        group by t1.id
        order by t1.create_time desc,t1.start_time desc
    </select>

    <select id="selectablesByIds" resultType="com.aiurt.boot.task.entity.RepairTask">
        SELECT
        t1.*,
        ( SELECT group_concat( t2.org_code ) FROM repair_task_org_rel AS t2 WHERE t1.`code` = t2.repair_task_code ) AS orgCode,
        ( SELECT group_concat( t4.station_code ) FROM repair_task_station_rel AS t4 WHERE t1.`code` = t4.repair_task_code ) AS siteCode,
        ( SELECT group_concat( t6.major_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS majorCode,
        ( SELECT group_concat( t6.subsystem_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS systemCode,
        t8.start_time as startOverhaulTime,
        t8.end_time as endOverhaulTime,
        t8.device_code as equipmentCode,
        t8.code as overhaulCode,
        rp.inspection_str_code,
        rp.is_manual
        FROM
        repair_task t1
        LEFT JOIN repair_task_org_rel t2 ON t1.`code` = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t4 ON t1.`code` = t4.repair_task_code
        LEFT JOIN repair_task_standard_rel t6 ON t1.id=t6.repair_task_id
        LEFT JOIN repair_task_device_rel t8 ON t1.id = t8.repair_task_id
        LEFT JOIN repair_pool rp ON t1.repair_pool_id=rp.id
        <where>
            t1.del_flag =0
            <if test="collection != null and collection.size() != 0">
                and t1.id in
                <foreach collection="collection" open="(" close=")" separator="," item="item">
                    #{item}
                </foreach>
            </if>
        </where>
        group by t1.id
        order by t1.create_time desc,t1.start_time desc
    </select>

    <select id="selectTasklet" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
           SELECT
	           t1.id as taskId,
               t1.code as taskCode,
               t2.id as deviceId,
               t3.id as standardId,
               t2.code as overhaulCode,
               t3.major_code as majorCode,
               t3.code as standardCode,
               t3.subsystem_code as systemCode,
               t3.device_type_code as deviceTypeCode,
               t2.device_code as equipmentCode,
               t2.submit_time as submitTime,
               t2.start_time as startTime,
               t2.is_submit as isSubmit,
               t2.staff_id as overhaulId,
               t2.station_code as stationCode,
               t2.line_code as lineCode,
               t2.position_code as positionCode,
               t2.specific_location as specificLocation,
               t3.title as overhaulStandardName,
               t3.is_appoint_device as isAppointDevice,
               t1.status as maintenanceTaskStatus
           FROM
	          repair_task t1
	          LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
	          LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
        <where>
	           t1.del_flag = 0
               AND t2.del_flag = 0
               <if test="condition.taskId !=null ">
                   AND t1.id = #{condition.taskId}
               </if>
               <if test="condition.equipmentName !=null ">
                   AND ( SELECT NAME FROM device WHERE CODE = t2.device_code ) LIKE CONCAT ('%', #{condition.equipmentName}, '%')
               </if>
               <if test="condition.search !=null ">
                 AND (
                   (( SELECT NAME FROM device WHERE CODE = t2.device_code ) LIKE CONCAT ('%', #{condition.search}, '%'))
                   or (t2.device_code LIKE CONCAT  ('%', #{condition.search}, '%'))
                   or (t2.code LIKE CONCAT ('%', #{condition.search}, '%'))
                   )
               </if>
               <if test="condition.equipmentCode !=null ">
                   AND t2.device_code = #{condition.equipmentCode}
               </if>
               <if test="condition.majorCode!=null ">
                   AND t3.major_code  = #{condition.majorCode}
               </if>
               <if test="condition.systemCode!=null ">
                   AND t3.subsystem_code  = #{condition.systemCode}
              </if>
               <if test="condition.overhaulCode!=null ">
                   AND t2.code  = #{condition.overhaulCode}
               </if>
               <if test="condition.overhaulStandardName!=null ">
                   AND t3.title  = #{condition.overhaulStandardName}
               </if>
               <if test="condition.standardId!=null ">
                   AND t3.id  = #{condition.standardId}
              </if>
        </where>
        order by t2.update_time desc,t2.create_time desc
    </select>

    <select id="repairTaskStationList" resultType="com.aiurt.boot.task.dto.RepairTaskStationDTO">
        SELECT
            distinct t1.station_code,
            t3.station_name
        FROM
            repair_task_station_rel t1
                LEFT JOIN repair_task t2 ON t1.repair_task_code = t2.CODE
                LEFT JOIN cs_station t3 ON t3.station_code = t1.station_code
        <where>
            <if test="taskId !=null ">
                AND t2.id = #{taskId}
            </if>
        </where>
    </select>

    <select id="selectTaskList" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
        SELECT
        t1.id as taskId,
        t1.code as taskCode,
        t2.id as deviceId,
        t3.id as standardId,
        t2.code as overhaulCode,
        t2.duration as duration,
        t3.major_code as majorCode,
        t3.subsystem_code as systemCode,
        t3.code ,
        t3.device_type_code as deviceTypeCode,
        t2.device_code as equipmentCode,
        t2.submit_time as submitTime,
        t2.start_time as startTime,
        t2.is_submit as isSubmit,
        t2.staff_id as overhaulId,
        t3.title as overhaulStandardName,
        t3.is_appoint_device as isAppointDevice,
        t1.status as maintenanceTaskStatus
        FROM
        repair_task t1
        LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
        LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
        LEFT JOIN repair_task_station_rel t4 ON t4.repair_task_code = t1.code
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0
            <if test="taskId !=null ">
                AND t1.id = #{taskId}
            </if>
            <if test="stationCode !=null ">
                AND t2.station_code = #{stationCode}
            </if>
        </where>
        group by t2.id
        order by t2.update_time desc,t2.create_time desc
    </select>

    <select id="selectDeviceTaskList" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
        SELECT
        t1.id as taskId,
        t1.code as taskCode,
        t2.id as deviceId,
        t3.id as standardId,
        t2.code as overhaulCode,
        t2.duration as duration,
        t3.major_code as majorCode,
        t3.subsystem_code as systemCode,
        t3.device_type_code as deviceTypeCode,
        t2.device_code as equipmentCode,
        t2.submit_time as submitTime,
        t2.start_time as startTime,
        t2.is_submit as isSubmit,
        t2.staff_id as overhaulId,
        t3.title as overhaulStandardName,
        t3.is_appoint_device as isAppointDevice,
        t1.status as maintenanceTaskStatus
        FROM
        repair_task t1
        LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
        LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
        LEFT JOIN repair_task_station_rel t4 ON t4.repair_task_code = t1.code
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0
            <if test="taskId !=null ">
                AND t1.id = #{taskId}
            </if>
        </where>
        group by t2.id
        order by t2.update_time desc,t2.create_time desc
    </select>

    <select id="selectRepairTaskInfo" resultType="com.aiurt.boot.task.dto.CheckListDTO">
        SELECT
        rtdr.id as deviceId,
        rtdr.duration as duration,
        rtdr.device_code as equipmentCode,
        rtdr.start_time as startTime,
        rtdr.end_time as endTime,
        rtdr.line_code as lineCode,
        rtdr.position_code as positionCode,
        rtdr.specific_location as specificLocation,
        rtdr.staff_id as overhaulId,
        rtdr.code as resultCode,
        rtdr.fault_code as faultCode,
        rtdr.repair_task_id as taskId,
        rts.station_code as stationCode,
        rtdr.CODE as resultCode,
        rtsr.id as standardId,
        rtsr.major_code as majorCode,
        rtsr.subsystem_code as systemCode,
        rtsr.device_type_code as deviceTypeCode,
        rtdr.submit_time as submitTime,
        rtr.status as statusCode,
        rtsr.code as standardCode,
        rtdr.sampling_sign_url
        FROM
            repair_task_device_rel rtdr
                LEFT JOIN repair_task rt ON rt.id = rtdr.repair_task_id
                LEFT JOIN repair_task_standard_rel rtsr on rtsr.id = rtdr.task_standard_rel_id
                 LEFT JOIN repair_task_result rtr on rtr.task_device_rel_id = rtdr.id
                 LEFT JOIN repair_task_station_rel  rts on rts.repair_task_code = rt.code
        <where>
            rtdr.del_flag = 0
            AND rt.del_flag = 0
            <if test="taskId !=null ">
                AND rtdr.repair_task_id = #{taskId}
            </if>
            <if test="stationCode !=null ">
                AND rts.station_code = #{stationCode}
            </if>
            <if test="deviceId !=null ">
                AND rtdr.id = #{deviceId}
            </if>
        </where>
        group by rtdr.id

    </select>

    <select id="selectTaskletForDevice" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
        SELECT
        t1.id as taskId,
        t1.code as taskCode,
        t1.status as taskStatus,
        t2.id as deviceId,
        t3.id as standardId,
        t2.code as overhaulCode,
        t3.major_code as majorCode,
        t3.subsystem_code as systemCode,
        t3.device_type_code as deviceTypeCode,
        t2.device_code as equipmentCode,
        t2.submit_time as submitTime,
        t2.staff_id as overhaulId,
        t3.title as overhaulStandardName,
        t2.start_time,
        t2.duration,
        t2.is_submit as isSubmit,
        su.realname as overhaulName
        FROM
        repair_task t1
        LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
        LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
        LEFT JOIN inspection_code_device_type t4 ON t3.code = t4.inspection_code
        left join sys_user su on su.id = t2.staff_id
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0 and t1.status = 8
            <if test="condition.equipmentCode !=null ">
                AND t2.device_code = #{condition.equipmentCode}
            </if>
            <if test="condition.taskId !=null ">
                AND t1.id = #{condition.taskId}
            </if>
            <if test="condition.majorCode!=null ">
                AND t3.major_code  = #{condition.majorCode}
            </if>
            <if test="condition.systemCode!=null ">
                AND t3.subsystem_code  = #{condition.systemCode}
            </if>
            <if test="condition.overhaulCode!=null ">
                AND t2.code  like concat('%',#{condition.overhaulCode},'%')
            </if>
            <if test="condition.overhaulStandardName!=null ">
                AND t3.title  like concat('%',#{condition.overhaulStandardName},'%')
            </if>
            <if test="condition.overhaulName!=null ">
                AND su.realname  like concat('%',#{condition.overhaulName},'%')
            </if>
            <if test="condition.startTimeBegin!=null and condition.startTimeEnd!=null ">
                and DATE_FORMAT(t2.start_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startTimeBegin}, '%Y-%m-%d')
                and DATE_FORMAT(t2.end_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.startTimeEnd}, '%Y-%m-%d')
            </if>
            <if test="multipleDeviceTypes eq '1'.toString() ">
                and t4.device_type_code = #{condition.deviceTypeCode}
            </if>
        </where>
        order by t1.start_time desc
    </select>


    <select id="selectStationList" resultType="com.aiurt.boot.plan.dto.StationDTO">
        select station_code,position_code,line_code from repair_task_station_rel where repair_task_code = #{planCode}
    </select>

    <select id="selectStationLists" resultType="com.aiurt.boot.plan.dto.StationDTO">
        select station_code,position_code,line_code from device where code = #{code}
    </select>

    <select id="selectCodeList" resultType="com.aiurt.boot.task.dto.RepairTaskDTO" parameterType="String">
        SELECT
	      t1.id as taskId,
	      t2.id as standardId,
	      t2.title as overhaulStandardName,
	      t2.major_code as majorCode,
	      t2.subsystem_code as systemCode,
	      t2.device_type_code as deviceTypeCode
        FROM
	       repair_task t1
	       LEFT JOIN repair_task_standard_rel t2 ON t1.id = t2.repair_task_id
        <where>
            t1.del_flag = 0
            and  t1.id = #{id}
            <if test="majorCode!=null">
                and  t2.major_code = #{majorCode}
            </if>
            <if test="subsystemCode!=null ">
                and  t2.subsystem_code = #{subsystemCode}
            </if>
        </where>
    </select>

    <select id="translateMajor" resultType="com.aiurt.boot.manager.dto.MajorDTO" parameterType="list">
        select
        major_name as majorName,
        major_code as majorCode
        from cs_major
        <where>
            del_flag = 0
            <if test="list.size()>0">
                and major_code in
                <foreach item="item" collection="list" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>


    <select id="translateSubsystem" resultType="com.aiurt.boot.manager.dto.SubsystemDTO" >
        select
        system_name  as systemName,
        system_code as systemCode
        from cs_subsystem
        where
            del_flag = 0
            and major_code = #{majorCode}
            and system_code = #{systemCode}
    </select>

    <select id="queryNameByCode" resultType="com.aiurt.boot.manager.dto.EquipmentDTO">
        select
        name as deviceTypeName,
        code as deviceTypeCode
        from device_type
        <where>
            del_flag = 0
            <if test="list.size()>0">
                and code in
                <foreach item="item" collection="list" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="selectCheckList" resultType="com.aiurt.boot.task.dto.CheckListDTO" >
       SELECT
	     t1.id as deviceId,
	     t4.id as standardId,
	     t1.duration as duration,
	     t4.major_code as majorCode,
	     t4.subsystem_code as systemCode,
	     t4.device_type_code as deviceTypeCode,
	     t1.device_code as equipmentCode,
	     t1.start_time as startTime,
	     t1.end_time as endTime,
         t1.station_code as stationCode,
         t1.line_code as lineCode,
         t1.position_code as positionCode,
         t1.specific_location as specificLocation,
         t1.staff_id as overhaulId,
         t1.code as resultCode,
         t1.fault_code as faultCode
       FROM
	    	repair_task_device_rel t1
	        LEFT JOIN repair_task_standard_rel t4  ON t4.id = t1.task_standard_rel_id
    WHERE
	      t1.id = #{id}
    </select>

    <select id="selectSingle" resultType="com.aiurt.boot.task.entity.RepairTaskResult">
        SELECT
	       t1.*,
        t2.proc_methods
        FROM
	    repair_task_result t1
        left join inspection_code_content t2 on t1.code = t2.code
        <where>
	      task_device_rel_id = #{id}
            <if test="status!=null">
                and status = #{status}
            </if>
        </where>
        GROUP BY t1.id
        order by sort_no ASC
    </select>

    <select id="selectEnclosure" resultType="com.aiurt.boot.task.entity.RepairTaskEnclosure">
      SELECT
	     *
       FROM
	   repair_task_enclosure
       WHERE
	   repair_task_result_id =#{resultId}
    </select>
    <select id="selectRepairPoolList" resultType="com.aiurt.boot.index.dto.RepairTaskNum">
        SELECT
            DATE_FORMAT(rt.submit_time, '%Y/%m/%d') AS currDateStr,
            COUNT(DISTINCT rt.id) AS num
        FROM
            repair_task rt
        LEFT JOIN repair_task_org_rel t2 ON rt.code = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t3 ON rt.code = t3.repair_task_code
        LEFT JOIN repair_task_standard_rel t4 ON rt.id = t4.repair_task_id
        WHERE
            rt.status = 8
        AND
            DATE_FORMAT(rt.submit_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{startDate}, '%Y-%m-%d')
        AND
            DATE_FORMAT(rt.submit_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        GROUP BY
            DATE(rt.submit_time)
    </select>
    <select id="selectOrgByCode" resultType="com.aiurt.boot.index.dto.MapDTO">
       select
            rtor.repair_task_code as  `value`,
            GROUP_CONCAT(rtor.org_code) as `text`
       from
            repair_task_org_rel rtor
       <where>
        rtor.del_flag = 0
        <if test="planCodes!=null and planCodes.size()>0">
            and rtor.repair_task_code in
            <foreach collection="planCodes" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
       </where>
        group by rtor.repair_task_code
    </select>
    <select id="inspectionNumByDay" resultType="com.aiurt.boot.plan.dto.RepairPoolDetailsDTO">
        select rt.year,rt.code,rt.type,rt.weeks,rt.start_time,rt.end_time,rt.status from repair_task rt
        where rt.status = 8 and rt.is_confirm = 0 and date_format(rt.submit_time ,'%Y-%m-%d') =date_format(#{dateTime} ,'%Y-%m-%d')
        <if test="repairTaskOrgRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskOrgRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="repairTaskStationRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskStationRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="poolCodeList.size()>0">
            and rt.code in
            <foreach collection="poolCodeList" item="item" open="(" close=")" separator=",">
                #{item.repairTaskId}
            </foreach>
        </if>
        union
        select rt.year,rt.code,rt.type,rt.weeks,rt.start_time,rt.end_time,rt.status from repair_task rt
        where rt.status = 8 and rt.is_confirm = 1 and rt.is_receipt =0 and date_format(rt.confirm_time ,'%Y-%m-%d') =date_format(#{dateTime} ,'%Y-%m-%d')
        <if test="repairTaskOrgRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskOrgRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="repairTaskStationRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskStationRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="poolCodeList.size()>0">
            and rt.code in
            <foreach collection="poolCodeList" item="item" open="(" close=")" separator=",">
                #{item.repairTaskId}
            </foreach>
        </if>
        union
        select rt.year,rt.code,rt.type,rt.weeks,rt.start_time,rt.end_time,rt.status from repair_task rt
        where rt.status = 8 and rt.is_confirm = 1 and rt.is_receipt =1 and date_format(rt.receipt_time ,'%Y-%m-%d') =date_format(#{dateTime} ,'%Y-%m-%d')
        <if test="repairTaskOrgRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskOrgRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="repairTaskStationRels.size()>0">
            and rt.code in
            <foreach collection="repairTaskStationRels" item="item" open="(" close=")" separator=",">
                #{item.repairTaskCode}
            </foreach>
        </if>
        <if test="poolCodeList.size()>0">
            and rt.code in
            <foreach collection="poolCodeList" item="item" open="(" close=")" separator=",">
                #{item.repairTaskId}
            </foreach>
        </if>
    </select>
    <select id="getTaskExceptionItem" resultType="java.lang.Integer">
    select COUNT(DISTINCT rt.id) from repair_task rt
    left join repair_task_device_rel rtdr on rtdr.repair_task_id = rt.id
    left join repair_task_result rtr on rtr.task_device_rel_id = rtdr.repair_task_id
    where rtr.status =2 and rt.`status` = 8
    <if test="code!=null and code !=''">
        and rt.code = #{code}
    </if>
    </select>
    <select id="getTaskInspectionTime" resultType="date">
        select rt.submit_time as inspectionTime from repair_task rt
        where  rt.is_receipt = 0 and rt.is_confirm =0 and rt.code = #{code}
        union all
        select rt.confirm_time as inspectionTime from repair_task rt
        where  rt.is_receipt = 0 and rt.is_confirm =1 and rt.code = #{code}
        union all
        select rt.receipt_time as inspectionTime from repair_task rt
        where  rt.is_receipt = 1 and rt.is_confirm =1 and rt.code = #{code}
    </select>

    <select id="readTeamList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
	    SELECT
           t1.id as taskId,
           t3.id as id,
           t1.code as taskCode,
           ifnull( Round(sum(
            TIMESTAMPDIFF(
            SECOND,
            t1.begin_time,
            IF
             ( 1 = t1.is_receipt, t1.receipt_time, IF ( 1 = t1.is_confirm, t1.confirm_time, t1.submit_time ) )
           ))/3600,2),0)as maintenanceDuration,
           t1.start_time as startDate,
           t1.end_time as endDate,
		   t3.org_code as orgCode,
           count(*)AS taskTotal
        FROM
           repair_pool t6
           LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
	       LEFT JOIN repair_task_user t2 ON t1.`code`= t2.repair_task_code
	       LEFT JOIN repair_task_org_rel t3 ON t1.`code`= t3.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            and t3.del_flag = 0
            <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0">
                and t3.org_code in
                <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="condition.orgCode!=null ">
                and t3.org_code = #{condition.orgCode}
            </if>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
        </where>
        GROUP BY t3.org_code
    </select>


    <select id="readTeamLists" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
        SELECT
        t1.id as taskId,
        t2.id as id,
        t1.code as taskCode
        FROM
        repair_pool t6
        LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
        LEFT JOIN repair_task_org_rel t2 ON t1.`code`= t2.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            <if test="condition.orgCode!=null ">
                and t2.org_code = #{condition.orgCode}
            </if>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
        </where>
    </select>

    <select id="readNameList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTO">
         SELECT
            t1.id as taskId,
            t2.id as id,
            t1.code as taskCode,
            ifnull( Round(sum(
            TIMESTAMPDIFF(
            SECOND,
            t1.begin_time,
            IF
            ( 1 = t1.is_receipt, t1.receipt_time, IF ( 1 = t1.is_confirm, t1.confirm_time, t1.submit_time ) )
            ))/3600,2),0)as maintenanceDuration,
            t1.start_time as startDate,
            t1.end_time as endDate,
            t2.user_id as userId,
            t2.name AS userName,
            count(*)AS taskTotal
          FROM
           repair_pool t6
           LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
	       LEFT JOIN repair_task_user t2 ON t1.`code`= t2.repair_task_code
	       LEFT JOIN repair_task_org_rel t3 ON t1.`code`= t3.repair_task_code
           LEFT JOIN repair_task_station_rel t4 ON t1.`code`= t4.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            and t3.del_flag = 0

            <if test="condition.lineCode!=null ">
                and t4.line_code = #{condition.lineCode}
            </if>
            <if test="condition.taskId!=null ">
                and t1.id = #{condition.taskId}
            </if>
            <if test="condition.stationCode!=null ">
                and t4.station_code = #{condition.stationCode}
            </if>
            <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0">
                and t3.org_code in
                <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="condition.orgCode!=null ">
                and t3.org_code = #{condition.orgCode}
            </if>
<!--            <if test="condition.subsystemCode!=null ">-->
<!--                and t5.subsystem_code = #{condition.subsystemCode}-->
<!--            </if>-->
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')

            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
        </where>
        GROUP BY t2.user_id
    </select>

    <select id="readNameLists" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTO">
        SELECT
        t1.id as taskId,
        t2.id as id,
        t2.user_id as userId
        FROM
        repair_pool t6
        LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
        LEFT JOIN repair_task_user t2 ON t1.`code`= t2.repair_task_code
        LEFT JOIN repair_task_org_rel t3 ON t1.`code`= t3.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            and t3.del_flag = 0
            <if test="condition.taskId!=null ">
                and t1.id = #{condition.taskId}
            </if>
            <if test="condition.orgCode!=null ">
                and t3.org_code = #{condition.orgCode}
            </if>
            <if test="condition.userId!=null ">
                and t2.user_id = #{condition.userId}
            </if>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
                and DATE_FORMAT(t6.end_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
        </where>
    </select>
    <select id="getStatus" resultType="java.lang.Integer">
        SELECT
	      t3.status
        FROM
	      repair_task t1
	    LEFT JOIN repair_task_device_rel t2 ON t2.repair_task_id = t1.id
	    LEFT JOIN repair_task_result t3 ON t3.task_device_rel_id = t2.id
	    where
	        t1.del_flag =0
            and t2.del_flag = 0
            and t3.del_flag = 0
            and t1.id = #{id}
    </select>

    <select id="getOrgCode" resultType="java.lang.String">
        select org_code from sys_user where id = #{id}
    </select>

    <select id="getRealName" resultType="java.lang.String">
        select realname from sys_user where id = #{id}
    </select>

    <select id="realNameList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTO">
        select
        id as userId,
        realname as userName
        from sys_user
        <where>
            1=1
            and del_flag = 0 and status = 1
            <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0" >
                and  org_code in
                <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
--             and del_flag=0
        </where>
    </select>

    <select id="selectDepart" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
        select
        a.id as orgId,
        a.org_code as orgCode,
        a.depart_name as orgName,
        a.org_category as orgCategory
        from
        sys_depart a
        where
        a.manager_id = #{id}
    </select>
    <select id="getUserOrgCategory" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
        select
        a.id as orgId,
        a.org_code as orgCode,
        a.depart_name as orgName
        from
        sys_depart a
        <!--只获取班组，不获取类型为组织机构和公司的-->
        INNER JOIN sys_param sp ON find_in_set(a.org_category, sp.`value`) AND sp.`code`= #{workLogOrgCategory}
        where a.parent_id=#{id}
    </select>

    <select id="getRepairTaskStation" resultType="java.lang.String">
        select
              t4.station_code
        FROM
                repair_task t1
                        LEFT JOIN repair_task_station_rel t4 ON t1.`code` = t4.repair_task_code
        where t1.id = #{id} and t4.del_flag = 0
    </select>


    <select id="getSystemInformation" resultType="com.aiurt.boot.task.dto.SystemInformationDTO">
         select line_code as lineCode,line_name as line  FROM cs_line where  del_flag = 0
    </select>

    <select id="getMaintenanceQuantity" resultType="java.lang.Long">
        SELECT
        COUNT(*)
        FROM
        repair_task t1
        LEFT JOIN repair_task_station_rel t2 ON t1.`code` = t2.repair_task_code
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0
            <if test="stationCode!=null ">
                AND t2.station_code in
                <foreach  item="item" collection="stationCode" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="status != null">
                and t1.STATUS = #{status}
            </if>
        </where>
    </select>
    <select id="getInspection" resultType="java.lang.Long">
        select
        COUNT(*)
        from
        patrol_task t1
        LEFT JOIN patrol_task_station t2 ON t1.`code` = t2.task_code
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0
            <if test="stationCode!=null ">
                AND t2.station_code in
                <foreach  item="item" collection="stationCode" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="status != null">
                and t1.status = #{status}
            </if>
        </where>
    </select>

    <select id="getFaultCodeList" resultType="java.lang.String">
        select code from fault
        <where>
            <if test="stationCode != null">
                station_code in
                <foreach  item="item" collection="stationCode" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
            <if test="status != null">
                and status = #{status}
            </if>
        </where>
    </select>

    <select id="getFaultQuantity" resultType="java.lang.Long">
        select COUNT(*) from fault_analysis_report
        <where>
            del_flag = 0
            and status = 1
            <if test="faultCode != null">
                and fault_code in
                <foreach  item="item" collection="faultCode" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="selectTask" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
        SELECT
        t2.code as overhaulCode
        FROM
        repair_task t1
        LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
        LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
        <where>
            t1.del_flag = 0
            AND t2.del_flag = 0
            <if test="taskId !=null ">
                AND t1.id = #{taskId}
            </if>
        </where>
        order by t2.update_time desc,t2.create_time desc
    </select>

    <select id="readTaskList" resultType="java.lang.Long">
        SELECT
        count(*)AS taskTotal
        FROM
        repair_pool t6
        LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
        LEFT JOIN repair_task_org_rel t2 ON t1.`code`= t2.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0">
                and t2.org_code in
                <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
            <if test="condition.orgCode!=null ">
                and t2.org_code = #{condition.orgCode}
            </if>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
        </where>
    </select>

    <select id="selectRepairPoolList2" resultType="com.aiurt.boot.plan.dto.RepairPoolDetailsDTO">
        select rt.year,rt.code,rt.type,rt.weeks,rt.start_time,rt.end_time,rt.status from repair_task rt
        left join repair_pool rp on rt.repair_pool_id = rp.id
        left join repair_pool_org_rel t2 on rp.code = t2.repair_pool_code
        left join repair_pool_station_rel t3 on rp.code = t3.repair_pool_code
        left join repair_pool_rel t4 on rp.code = t4.repair_pool_code
        left join repair_pool_code t5 on t4.repair_pool_sta_id = t4.id
        where rt.status = 8  and date_format(rt.submit_time ,'%Y-%m-%d') =date_format(#{startDate} ,'%Y-%m-%d')
    </select>
    <select id="getMaintenanceSituation" resultType="com.aiurt.boot.plan.dto.RepairPoolDetailsDTO">
        SELECT DISTINCT
            rt.year,
            rt.code,
            rt.type,
            rt.weeks,
            rt.start_time,
            rt.end_time,
            rt.status
        FROM
            repair_task rt
                LEFT JOIN repair_task_station_rel rtsr ON rtsr.repair_task_code = rt.code
                LEFT JOIN repair_task_org_rel rtor ON rtor.repair_task_code = rt.code
                LEFT JOIN repair_task_standard_rel rtsrl ON rtsrl.repair_task_id = rt.id
       <where>
            rt.status = 8
           <if test="flag != null and flag != ''and flag == 1">
               AND DATE_FORMAT(rt.begin_time, '%Y-%m-%d') = DATE_FORMAT(#{startDate}, '%Y-%m-%d')
           </if>
           <if test="flag != null and flag != ''and flag == 0">
               AND DATE_FORMAT(rt.submit_time, '%Y-%m-%d') = DATE_FORMAT(#{startDate}, '%Y-%m-%d')
           </if>
          <if test="stationCode!=null and stationCode!=''">
              AND rtsr.station_code = #{stationCode}
          </if>
       </where>
    </select>

    <select id="selectRepairPoolListSpecial" resultType="com.aiurt.boot.index.dto.RepairTaskNum">
        SELECT
        DATE_FORMAT(rt.begin_time, '%Y/%m/%d') AS currDateStr,
        COUNT(DISTINCT rt.id) AS num
        FROM
        repair_task rt
        LEFT JOIN repair_task_org_rel t2 ON rt.code = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t3 ON rt.code = t3.repair_task_code
        LEFT JOIN repair_task_standard_rel t4 ON rt.id = t4.repair_task_id
        LEFT JOIN repair_task_device_rel t5 ON rt.id = t5.repair_task_id
        WHERE
        rt.status = 8
        AND
        DATE_FORMAT(rt.begin_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{startDate}, '%Y-%m-%d')
        AND
        DATE_FORMAT(rt.begin_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{endDate}, '%Y-%m-%d')
        GROUP BY
        DATE(rt.begin_time)
    </select>

    <select id="getAllTaskList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
        select org_code,id as orgId,depart_name as orgName
        from sys_depart where del_flag = 0
        and org_code in
        <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
        order by sort
    </select>

    <select id="countCompletedNumber" resultType="java.lang.Long">
        SELECT
        count(t6.id)
        FROM
        repair_pool t6
        LEFT JOIN repair_task t1 ON t6.id = t1.repair_pool_id
        LEFT JOIN repair_task_user t2 ON t1.`code`= t2.repair_task_code
        LEFT JOIN repair_task_org_rel t3 ON t1.`code`= t3.repair_task_code
        <where>
            t1.del_flag =0
            and t2.del_flag = 0
            and t3.del_flag = 0
            <if test="condition.taskId!=null ">
                and t1.id = #{condition.taskId}
            </if>
            <if test="condition.orgCode!=null ">
                and t3.org_code = #{condition.orgCode}
            </if>
            <if test="condition.userId!=null ">
                and t2.user_id = #{condition.userId}
            </if>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
                and DATE_FORMAT(t6.end_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t6.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
        </where>
    </select>

    <sql id="countRepairTask">
        SELECT
        t1.id ,
        t1.code ,
        ifnull(sum(
        TIMESTAMPDIFF(
        SECOND,
        t1.begin_time,
        IF
        ( 1 = t1.is_receipt, t1.receipt_time, IF ( 1 = t1.is_confirm, t1.confirm_time, t1.submit_time ) )
        )),0)as maintenanceDuration,
        t1.start_time as startDate,
        t1.end_time as endDate,
        t1.status,
        IFNULL(count(t5.id), 0)  as abnormalNumber
        FROM
        repair_task t1
        LEFT JOIN repair_task_station_rel t2 ON t1.`code`= t2.repair_task_code and t2.del_flag = 0
        LEFT JOIN repair_task_device_rel t3 ON t1.id = t3.repair_task_id and t3.del_flag = 0
        LEFT JOIN repair_task_standard_rel t4 ON t3.task_standard_rel_id = t4.id
        LEFT JOIN repair_task_result t5 ON t5.task_device_rel_id = t3.id and t5.`status` = 2
        <where>
            <if test="condition.startDate!=null and condition.endDate!=null ">
                and DATE_FORMAT(t1.start_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.startDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.endDate!=null ">
                and DATE_FORMAT(t1.start_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.endDate} ,'%Y-%m-%d')
            </if>
            <if test="condition.subsystemCode!=null and condition.subsystemCode!=''">
                AND t4.subsystem_code  = #{condition.subsystemCode}
            </if>
        </where>
        group by t1.id
    </sql>

    <select id="countTeamList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTOS">
        select
        t1.org_code,
        IFNULL(COUNT( 1 ), 0) `taskTotal`,
        IFNULL(SUM( #{condition.repairTaskStatus} = statistics.`status` ), 0) `completedNumber`,
        IFNULL( SUM( statistics.abnormalNumber > 0 ), 0 ) AS `abnormalNumber`
        from
        (<include refid="countRepairTask"/>
        ) statistics
        LEFT JOIN repair_task_org_rel t1 ON statistics.`code`= t1.repair_task_code and t1.del_flag = 0
        <where>
        <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0">
            and t1.org_code in
            <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
        </where>
        group by t1.org_code
    </select>

    <select id="countUserList" resultType="com.aiurt.boot.task.dto.OverhaulStatisticsDTO">
        select
        t2.user_id,
        t3.org_code,
        IFNULL(COUNT( 1 ), 0) `taskTotal`,
        IFNULL(SUM( #{condition.repairTaskStatus} = statistics.`status` ), 0) `completedNumber`,
        IFNULL(SUM( statistics.abnormalNumber > 0 ), 0) as `abnormalNumber`,
        IFNULL(SUM( statistics.maintenanceDuration), 0) as `maintenanceDuration`
        from
        (<include refid="countRepairTask"/>
        ) statistics
        LEFT JOIN repair_task_user t2 ON statistics.`code`= t2.repair_task_code and t2.del_flag = 0
        LEFT JOIN sys_user t3 ON t3.id = t2.user_id
        <where>
            <if test="condition.orgCodeList!=null and condition.orgCodeList.size()!=0">
                and t3.org_code in
                <foreach collection="condition.orgCodeList" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
        group by t2.user_id
    </select>

    <select id="getAllCodes" resultType="com.aiurt.boot.task.entity.RepairTask">
        SELECT
        t1.id,
        ( SELECT group_concat( t2.org_code ) FROM repair_task_org_rel AS t2 WHERE t1.`code` = t2.repair_task_code ) AS orgCode,
        ( SELECT group_concat( t4.station_code ) FROM repair_task_station_rel AS t4 WHERE t1.`code` = t4.repair_task_code ) AS siteCode,
        ( SELECT group_concat( t6.major_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS majorCode,
        ( SELECT group_concat( t6.subsystem_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS systemCode
        FROM
        repair_task t1
        LEFT JOIN repair_task_org_rel t2 ON t1.`code` = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t4 ON t1.`code` = t4.repair_task_code
        LEFT JOIN repair_task_standard_rel t6 ON t1.id=t6.repair_task_id
        <where>
            t1.del_flag =0
            <if test="collection != null and collection.size() != 0">
                and t1.id in
                <foreach collection="collection" open="(" close=")" separator="," item="item">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
</mapper>
