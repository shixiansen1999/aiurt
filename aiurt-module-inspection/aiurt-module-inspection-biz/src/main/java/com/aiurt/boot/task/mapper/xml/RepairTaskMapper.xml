<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.task.mapper.RepairTaskMapper">
    <select id="selectables" resultType="com.aiurt.boot.task.entity.RepairTask">
        SELECT
        t1.*,
        ( SELECT group_concat( t2.org_code ) FROM repair_task_org_rel AS t2 WHERE t1.`code` = t2.repair_task_code ) AS orgCode,
        ( SELECT group_concat( t4.station_code ) FROM repair_task_station_rel AS t4 WHERE t1.`code` = t4.repair_task_code ) AS siteCode,
        ( SELECT group_concat( t6.major_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS majorCode,
        ( SELECT group_concat( t6.subsystem_code ) FROM repair_task_standard_rel AS t6 WHERE t1.id = t6.repair_task_id ) AS systemCode,
        t8.start_time as startOverhaulTime,
        t8.end_time as endOverhaulTime
        FROM
        repair_task t1
        LEFT JOIN repair_task_org_rel t2 ON t1.`code` = t2.repair_task_code
        LEFT JOIN repair_task_station_rel t4 ON t1.`code` = t4.repair_task_code
        LEFT JOIN repair_task_standard_rel t6 ON t1.id=t6.repair_task_id
        LEFT JOIN repair_task_device_rel t8 ON t1.id = t8.repair_task_id
        <where>
            t1.del_flag =0
            <if test="condition.id!=null ">
                and t1.id = #{condition.id}
            </if>
            <if test="condition.code!=null ">
                and t1.code = #{condition.code}
            </if>
            <if test="condition.type!=null ">
                and t1.type = #{condition.type}
            </if>
            <if test="condition.weeks!=null ">
                and t1.weeks = #{condition.weeks}
            </if>
            <if test="condition.status!=null ">
                and t1.status = #{condition.status}
            </if>
            <if test="condition.orgCode!=null ">
                and t2.org_code = #{condition.orgCode}
            </if>
            <if test="condition.siteCode!=null ">
                and t4.station_code = #{condition.siteCode}
            </if>
            <if test="condition.time1!=null and condition.time2!=null ">
                and DATE_FORMAT(t1.start_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.time1}, '%Y-%m-%d')
                and DATE_FORMAT(t1.start_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.time2}, '%Y-%m-%d')
            </if>
        </where>
        group by t1.id
        order by t1.start_time desc
    </select>

    <select id="selectTasklet" resultType="com.aiurt.boot.task.dto.RepairTaskDTO">
           SELECT
	           t1.id as taskId,
               t2.id as deviceId,
               t3.id as standardId,
               t4.id as resultId,
               t4.status as maintenanceResults,
               t2.code as overhaulCode,
               t3.major_code as majorCode,
               t3.subsystem_code as systemCode,
               t3.device_type_code as deviceTypeCode,
               t2.device_code as equipmentCode,
               t2.submit_time as submitTime,
               t2.staff_id as overhaulId
           FROM
	          repair_task t1
	          LEFT JOIN repair_task_device_rel t2 ON t1.id = t2.repair_task_id
	          LEFT JOIN repair_task_standard_rel t3 ON t2.task_standard_rel_id = t3.id
	          LEFT JOIN repair_task_result t4 ON t2.id = t4.task_device_rel_id
        <where>
	           t1.del_flag = 0
               <if test="condition.equipmentCode !=null ">
                   AND ( SELECT NAME FROM device WHERE CODE = t3.device_type_code ) LIKE CONCAT ('%', #{condition.equipmentName}, '%')
               </if>
	           AND t1.id = #{condition.taskId}
               <if test="condition.majorCode!=null ">
                AND t3.major_code  = #{condition.majorCode}
               </if>
               <if test="condition.systemCode!=null ">
                   AND t3.subsystem_code  = #{condition.systemCode}
              </if>
               <if test="condition.maintenanceResults!=null ">
                   AND t4.status  = #{condition.maintenanceResults}
               </if>
               <if test="condition.overhaulCode!=null ">
                   AND t2.code  = #{condition.overhaulCode}
               </if>
               <if test="condition.overhaulStandardName!=null ">
                   AND t3.title  = #{condition.overhaulStandardName}
               </if>
        </where>
        order by t1.start_time desc
    </select>


    <select id="selectStationList" resultType="com.aiurt.boot.plan.dto.StationDTO">
        select station_code,position_code,line_code from repair_task_station_rel where repair_task_code = #{planCode}
    </select>

    <select id="selectCodeList" resultType="com.aiurt.boot.task.dto.RepairTaskDTO" parameterType="String">
        SELECT
	      t1.id as taskId,
	      t2.id as standardId,
	      t2.title as overhaulName,
	      t2.major_code as majorCode,
	      t2.subsystem_code as systemCode,
	      t2.device_type_code as deviceTypeCode
        FROM
	       repair_task t1
	       LEFT JOIN repair_task_standard_rel t2 ON t1.id = t2.repair_task_id
        <where>
            t1.del_flag = 0
            and  t1.id = #{id}
        </where>
    </select>

    <select id="translateMajor" resultType="com.aiurt.boot.manager.dto.MajorDTO" parameterType="list">
        select
        major_name as majorName,
        major_code as majorCode
        from cs_major
        <where>
            del_flag = 0
            <if test="list.size()>0">
                and major_code in
                <foreach item="item" collection="list" separator="," open="(" close=")" index="">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>


    <select id="translateSubsystem" resultType="com.aiurt.boot.manager.dto.SubsystemDTO" >
        select
        system_name  as systemName,
        system_code as systemCode
        from cs_subsystem
        where
            del_flag = 0
            and major_code = #{code}
    </select>
</mapper>