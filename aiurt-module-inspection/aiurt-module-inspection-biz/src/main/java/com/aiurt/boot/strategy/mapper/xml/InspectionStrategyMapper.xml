<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.strategy.mapper.InspectionStrategyMapper">
    <update id="removeId">
        UPDATE ( inspection_strategy  a
            LEFT JOIN inspection_str_sta_rel b on a.`code`=b.inspection_str_code
            LEFT JOIN inspection_str_rel c on a.`code`=c.inspection_str_code
            LEFT JOIN inspection_str_org_rel d ON a.id=d.inspection_str_code
            LEFT JOIN inspection_str_device_rel e ON a.id =e.inspection_str_rel_id
            )
        SET a.del_flag = 1 ,b.del_flag=1,c.del_flag=1,d.del_flag=1
        where a.id= #{id}
    </update>
    <delete id="deleteIdOrCode">
        DELETE  a.*,b.*,c.*,d.*,e.*
        from
            inspection_strategy AS a
                LEFT JOIN inspection_str_sta_rel b on a.`code`=b.inspection_str_code
                LEFT JOIN inspection_str_rel c on a.`code`=c.inspection_str_code
                LEFT JOIN inspection_str_org_rel d ON a.id=d.inspection_str_code
                LEFT JOIN inspection_str_device_rel e ON a.id =e.inspection_str_rel_id
        WHERE
            a.id=#{id} AND a.`code`=#{code}
    </delete>


    <select id="selectPageList" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
        SELECT * FROM
            ( SELECT isy.*,
                     ( SELECT
                           GROUP_CONCAT(e.depart_name)
                       FROM inspection_str_org_rel inor
                                LEFT JOIN sys_depart e ON inor.org_code = e.org_code
                       WHERE
                           isy.`code` = inor.inspection_str_code
                         AND inor.del_flag = 0) AS mechanismName,
                     (SELECT
                          GROUP_CONCAT(e.org_code)
                      FROM inspection_str_org_rel inor
                               LEFT JOIN sys_depart e ON inor.org_code = e.org_code
                      WHERE
                          isy.`code` = inor.inspection_str_code
                        AND inor.del_flag = 0) AS mechanismCode,
                     (SELECT
                          GROUP_CONCAT(f.station_name)
                      FROM
                          inspection_str_sta_rel inssr
                              LEFT JOIN cs_station f ON inssr.station_code = f.station_code
                      WHERE
                          isy.`code` = inssr.inspection_str_code and f.del_flag = 0
                        AND inssr.del_flag = 0) AS siteName,
                     (SELECT
                          GROUP_CONCAT(f.station_code)
                      FROM
                          inspection_str_sta_rel inssr
                              LEFT JOIN cs_station f ON inssr.station_code = f.station_code
                      WHERE
                          isy.`code` = inssr.inspection_str_code and f.del_flag = 0
                        AND inssr.del_flag = 0) AS siteCode,
                     (SELECT
                          GROUP_CONCAT(DISTINCT ic.major_code)
                      FROM
                          inspection_str_rel insr
                              LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                              LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
                      WHERE
                          insr.inspection_str_code = isy.`code`
                          and ic.del_flag = 0 and csm.del_flag = 0 ) AS professionCode,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT csm.major_name)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
                       WHERE
                           insr.inspection_str_code = isy.`code`
                         and ic.del_flag = 0 and csm.del_flag = 0) AS professionName,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT ic.subsystem_code)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
                       WHERE
                           insr.inspection_str_code = isy.`code`
                          and ic.del_flag = 0 and css.del_flag = 0) AS subsystemCode,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT css.system_name)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
                       WHERE
                           insr.inspection_str_code = isy.`code`
                        and ic.del_flag = 0 and css.del_flag = 0) AS subsystemName
                    FROM inspection_strategy isy
                    LEFT JOIN inspection_str_org_rel ss on isy.`code` =ss.inspection_str_code and ss.del_flag = 0
                    LEFT JOIN  inspection_str_rel ii on isy.`code` = ii.inspection_str_code and ii.del_flag =0
                    LEFT JOIN inspection_code icu on icu.`code`= ii.inspection_sta_code and icu.del_flag =0
                    WHERE isy.del_flag = 0
               <if test="orgCodes.size()>0">
                       and ss.org_code in
                    <foreach item="orgCodes" collection="orgCodes" separator="," open="(" close=")" index="">
                       #{orgCodes}
                   </foreach>
               </if>
                <if test="majorCodes.size()>0">
                    AND  icu.major_code in
                    <foreach item="majorCodes" collection="majorCodes" separator="," open="(" close=")" index="">
                        #{majorCodes}
                    </foreach>
                </if>
             GROUP BY isy.id
            ) AS abc
        WHERE
            1 = 1
        <if test="inspectionStrategyDTO.name !=null ">
            AND name LIKE CONCAT ('%', #{inspectionStrategyDTO.name}, '%')
        </if>
        <if test="inspectionStrategyDTO.professionCode !=null ">
            AND professionCode  LIKE CONCAT ('%', #{inspectionStrategyDTO.professionCode}, '%')
        </if>
        <if test="inspectionStrategyDTO.subsystemCode !=null ">
            AND subsystemCode  LIKE CONCAT ('%', #{inspectionStrategyDTO.subsystemCode}, '%')
        </if>
        <if test="inspectionStrategyDTO.code !=null ">
            AND code LIKE CONCAT ('%', #{inspectionStrategyDTO.code}, '%')
        </if>
        <if test="inspectionStrategyDTO.status !=null ">
            AND status = #{inspectionStrategyDTO.status}
        </if>
        <if test="inspectionStrategyDTO.year !=null ">
            AND year = #{inspectionStrategyDTO.year}
        </if>
        <if test="inspectionStrategyDTO.type !=null ">
            AND type = #{inspectionStrategyDTO.type}
        </if>
        <if test="inspectionStrategyDTO.tactics !=null ">
            AND tactics = #{inspectionStrategyDTO.tactics}
        </if>
        <if test="inspectionStrategyDTO.mechanismCode !=null ">
            AND mechanismCode LIKE CONCAT ('%', #{inspectionStrategyDTO.mechanismCode}, '%')
        </if>
        <if test="inspectionStrategyDTO.siteCode!=null ">
            and siteCode REGEXP #{inspectionStrategyDTO.siteCode}
        </if>
        ORDER BY create_time DESC
    </select>
    <select id="getId" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
        SELECT insy.*,( SELECT GROUP_CONCAT(e.depart_name) FROM inspection_str_org_rel isor
        LEFT JOIN sys_depart e ON isor.org_code = e.org_code  WHERE  isor.inspection_str_code= insy.`code`
        AND isor.del_flag = 0   ) AS mechanismName,
               ( SELECT GROUP_CONCAT(f.station_name) FROM  inspection_str_sta_rel issr
                 LEFT JOIN cs_station f ON issr.station_code = f.station_code
                 WHERE issr.inspection_str_code=insy.`code` AND issr.del_flag = 0 ) AS siteName,
               ( SELECT GROUP_CONCAT(e.org_code) FROM inspection_str_org_rel isor
                 LEFT JOIN sys_depart e ON isor.org_code = e.org_code  WHERE  isor.inspection_str_code= insy.`code`
                AND isor.del_flag = 0) AS mechanismCode,
               ( SELECT GROUP_CONCAT(f.station_code) FROM  inspection_str_sta_rel issr
                 LEFT JOIN cs_station f ON issr.station_code = f.station_code
                 WHERE issr.inspection_str_code=insy.`code` AND issr.del_flag = 0 ) AS siteCode,
               ( SELECT GROUP_CONCAT(isr.inspection_sta_code) FROM  inspection_code ic
                 LEFT JOIN inspection_str_rel isr on ic.`code` =isr.inspection_sta_code
                 WHERE isr.inspection_str_code = insy.`code`  AND isr.del_flag = 0 ) AS codes
        FROM inspection_strategy insy
        WHERE
            insy.del_flag=0
          and insy.id = #{id}
    </select>
    <select id="selectbyCodes" resultType="com.aiurt.boot.manager.dto.InspectionCodeDTO">
        select a.*,b.major_name as professionName, c.system_name as subsystemName ,d.name as deviceTypeName
        from inspection_code  a
        left join cs_major b on a.major_code =b.major_code
        left join cs_subsystem c on a.subsystem_code =c.system_code
        left join device_type d on a.device_type_code =d.code
        where a.del_flag =0 and a.`code` in
        <foreach collection="codes" open="(" close=")"  index="index"   separator="," item="codes">
            #{codes}
        </foreach>
    </select>
    <select id="viewDetail" resultType="com.aiurt.modules.device.entity.Device">
        SELECT a.* FROM device a
             LEFT JOIN inspection_str_device_rel b on a.`code`=b.device_code
         WHERE b.id= #{id}
    </select>
    <select id="viewDetails" resultType="com.aiurt.modules.device.entity.Device">
        SELECT a.* FROM device a
         LEFT JOIN inspection_str_device_rel b on a.`code`=b.device_code
         WHERE b.inspection_str_rel_id= #{id}
    </select>

    <select id="selectCodeList" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
         SELECT
	       t3.major_code as professionCode,
	       t3.subsystem_code as subsystemCode,
           t3.id as standardId,
           t3.title as standardName
         FROM
	       inspection_strategy t1
	     LEFT JOIN inspection_str_rel t2 ON t1.`code` = t2.inspection_str_code
	     LEFT JOIN inspection_code t3 ON t2.inspection_sta_code = t3.`code`
        <where>
                t1.id = #{strategyId}
            <if test="majorCode!=null">
                and t3.major_code= #{majorCode}
            </if>
            <if test="subsystemCode!=null">
                and t3.subsystem_code = #{subsystemCode}
            </if>
        </where>
    GROUP BY t2.inspection_sta_code
    </select>
    <select id="translateMajor" resultType="java.lang.String">
        select
        major_name as majorName
        from cs_major
        where
        del_flag = 0
        and major_code=#{majorCode}
    </select>
    <select id="translateSubsystem" resultType="com.aiurt.boot.manager.dto.SubsystemDTO">
        select
        system_name  as systemName,
        system_code as systemCode
        from cs_subsystem
        where
        del_flag = 0
        and major_code = #{majorCode}
        <if test="systemCode.size()>0">
            and system_code in
            <foreach item="systemCode" collection="systemCode" separator="," open="(" close=")" index="">
                #{systemCode}
            </foreach>
        </if>
    </select>
    <select id="selectBySite" resultType="java.lang.String">
     select station_code from cs_station  where del_flag =0 and  line_code =#{siteCode}
    </select>
    <select id="systemCodeName" resultType="java.lang.String">
        select system_name from cs_subsystem where del_flag = 0 and system_code =#{subsystemCode}
    </select>
    <select id="deviceTypeCodeName" resultType="java.lang.String">
        select  name from device_type where  del_flag =0  and  code =#{deviceTypeCode}
    </select>
    <select id="statusDesc" resultType="java.lang.String">
        select item_text from sys_dict_item c left join sys_dict a on a.id =c.dict_id
        where  a.del_flag=0 and a.dict_code = 'device_status' and c.item_value = #{status}
    </select>
    <select id="temporaryName" resultType="java.lang.String">
        select item_text from sys_dict_item c left join sys_dict a on a.id =c.dict_id
        where  a.del_flag=0 and a.dict_code = 'device_temporary' and c.item_value = #{temporary}
    </select>
    <select id="selectListNoPage" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyExcelDTO">
        SELECT
        *
        FROM
        (
        SELECT
        isy.*,
        (
        SELECT
        GROUP_CONCAT( e.depart_name)
        FROM
        inspection_str_org_rel inor
        LEFT JOIN sys_depart e ON inor.org_code = e.org_code
        WHERE
        isy.`code` = inor.inspection_str_code
        AND inor.del_flag = 0
        ) AS orgName,
        (
        SELECT
        GROUP_CONCAT( e.org_code )
        FROM
        inspection_str_org_rel inor
        LEFT JOIN sys_depart e ON inor.org_code = e.org_code
        WHERE
        isy.`code` = inor.inspection_str_code
        AND inor.del_flag = 0
        ) AS mechanismCode,
        (
        SELECT
        GROUP_CONCAT( f.station_name )
        FROM
        inspection_str_sta_rel inssr
        LEFT JOIN cs_station f ON inssr.station_code = f.station_code
        WHERE
        isy.`code` = inssr.inspection_str_code
        AND f.del_flag = 0
        AND inssr.del_flag = 0
        ) AS stationName,
        (
        SELECT
        GROUP_CONCAT( f.station_code )
        FROM
        inspection_str_sta_rel inssr
        LEFT JOIN cs_station f ON inssr.station_code = f.station_code
        WHERE
        isy.`code` = inssr.inspection_str_code
        AND f.del_flag = 0
        AND inssr.del_flag = 0
        ) AS sationCode,
        (
        SELECT
        GROUP_CONCAT( DISTINCT ic.major_code )
        FROM
        inspection_str_rel insr
        LEFT JOIN inspection_code ic ON ic.`code` = insr.inspection_sta_code
        LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
        WHERE
        insr.inspection_str_code = isy.`code`
        AND ic.del_flag = 0
        AND csm.del_flag = 0
        ) AS professionCode,
        (
        SELECT
        GROUP_CONCAT( DISTINCT csm.major_name )
        FROM
        inspection_str_rel insr
        LEFT JOIN inspection_code ic ON ic.`code` = insr.inspection_sta_code
        LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
        WHERE
        insr.inspection_str_code = isy.`code`
        AND ic.del_flag = 0
        AND csm.del_flag = 0
        ) AS professionName,
        (
        SELECT
        GROUP_CONCAT( DISTINCT ic.subsystem_code )
        FROM
        inspection_str_rel insr
        LEFT JOIN inspection_code ic ON ic.`code` = insr.inspection_sta_code
        LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
        WHERE
        insr.inspection_str_code = isy.`code`
        AND ic.del_flag = 0
        AND css.del_flag = 0
        ) AS subsystemCode,
        (
        SELECT
        GROUP_CONCAT( DISTINCT css.system_name )
        FROM
        inspection_str_rel insr
        LEFT JOIN inspection_code ic ON ic.`code` = insr.inspection_sta_code
        LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
        WHERE
        insr.inspection_str_code = isy.`code`
        AND ic.del_flag = 0
        AND css.del_flag = 0
        ) AS subsystemName
        FROM
        inspection_strategy isy
        WHERE
        isy.del_flag = 0
        ) AS abc
        WHERE
        1 = 1
        <if test="inspectionStrategyDTO.name !=null ">
            AND name LIKE CONCAT ('%', #{inspectionStrategyDTO.name}, '%')
        </if>
        <if test="inspectionStrategyDTO.professionCode !=null ">
            and FIND_IN_SET(#{inspectionStrategyDTO.professionCode},professionCode)>0
        </if>
        <if test="inspectionStrategyDTO.subsystemCode !=null ">
        and FIND_IN_SET(#{inspectionStrategyDTO.subsystemCode},subsystemCode)>0
        </if>
        <if test="inspectionStrategyDTO.code !=null ">
            AND code LIKE CONCAT ('%', #{inspectionStrategyDTO.code}, '%')
        </if>
        <if test="inspectionStrategyDTO.status !=null ">
            AND status = #{inspectionStrategyDTO.status}
        </if>
        <if test="inspectionStrategyDTO.year !=null ">
            AND year = #{inspectionStrategyDTO.year}
        </if>
        <if test="inspectionStrategyDTO.type !=null ">
            AND type = #{inspectionStrategyDTO.type}
        </if>
        <if test="inspectionStrategyDTO.tactics !=null ">
            AND tactics = #{inspectionStrategyDTO.tactics}
        </if>
        <if test="inspectionStrategyDTO.mechanismCode !=null ">
            AND  FIND_IN_SET(#{inspectionStrategyDTO.mechanismCode},mechanismCode)>0
        </if>
        <if test="inspectionStrategyDTO.siteCode!=null ">
            and siteCode REGEXP #{inspectionStrategyDTO.siteCode}
        </if>
        ORDER BY create_time DESC
    </select>
    <select id="selectInspectionCode" resultType="com.aiurt.boot.strategy.dto.InspectionExcelDTO">
    SELECT
    ins.id,inc.code,inc.title
    FROM
	inspection_str_rel ins
	left join inspection_code  inc on inc.code = ins.inspection_sta_code
	where ins.inspection_str_code =#{code} and ins.del_flag = 0 and inc.del_flag = 0
    </select>
    <select id="selectDevice" resultType="com.aiurt.boot.strategy.dto.DeviceExcelDTO">
    SELECT d.code,d.name
    FROM inspection_str_device_rel isdr
	left join device  d on d.code = isdr.device_code
	where isdr.inspection_str_rel_id = #{id}
    </select>
    <select id="getStation" resultType="com.aiurt.boot.plan.dto.StationDTO">
        select cs.station_code,cs.line_code from cs_station cs
        left join cs_line cl on cl.line_code = cs.line_code
        where cs.del_flag = 0 and cl.del_flag = 0 and cs.station_name = #{stationName} and cl.line_name = #{lineName}
    </select>
    <select id="getOrgs" resultType="java.lang.String">
        select org_code from sys_depart where depart_name =#{org} and del_flag = 0
    </select>
    <select id="getIsExistDevice" resultType="com.aiurt.modules.device.entity.Device">
        select * from device where code=#{device} and del_flag = 0
    </select>
</mapper>
