<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.boot.strategy.mapper.InspectionStrategyMapper">
    <update id="removeId">
        UPDATE ( inspection_strategy  a
            LEFT JOIN inspection_str_sta_rel b on a.`code`=b.inspection_str_code
            LEFT JOIN inspection_str_rel c on a.`code`=c.inspection_str_code
            LEFT JOIN inspection_str_org_rel d ON a.id=d.inspection_str_code
            LEFT JOIN inspection_str_device_rel e ON a.id =e.inspection_str_rel_id
            )
        SET a.del_flag = 1 ,b.del_flag=1,c.del_flag=1,d.del_flag=1
        where a.id= #{id}
    </update>
    <delete id="deleteIDorCode">
        DELETE  a.*,b.*,c.*,d.*,e.*
        from
            inspection_strategy AS a
                LEFT JOIN inspection_str_sta_rel b on a.`code`=b.inspection_str_code
                LEFT JOIN inspection_str_rel c on a.`code`=c.inspection_str_code
                LEFT JOIN inspection_str_org_rel d ON a.id=d.inspection_str_code
                LEFT JOIN inspection_str_device_rel e ON a.id =e.inspection_str_rel_id
        WHERE
            a.id=#{id} AND a.`code`=#{code}
    </delete>


    <select id="selectPageList" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
        SELECT * FROM
            ( SELECT isy.*,
                     ( SELECT
                           GROUP_CONCAT(e.depart_name)
                       FROM inspection_str_org_rel inor
                                LEFT JOIN sys_depart e ON inor.org_code = e.org_code
                       WHERE
                           isy.`code` = inor.inspection_str_code
                         AND inor.del_flag = 0) AS mechanismName,
                     (SELECT
                          GROUP_CONCAT(e.org_code)
                      FROM inspection_str_org_rel inor
                               LEFT JOIN sys_depart e ON inor.org_code = e.org_code
                      WHERE
                          isy.`code` = inor.inspection_str_code
                        AND inor.del_flag = 0) AS mechanismCode,
                     (SELECT
                          GROUP_CONCAT(f.station_name)
                      FROM
                          inspection_str_sta_rel inssr
                              LEFT JOIN cs_station f ON inssr.station_code = f.station_code
                      WHERE
                          isy.`code` = inssr.inspection_str_code
                        AND inssr.del_flag = 0) AS siteName,
                     (SELECT
                          GROUP_CONCAT(f.station_code)
                      FROM
                          inspection_str_sta_rel inssr
                              LEFT JOIN cs_station f ON inssr.station_code = f.station_code
                      WHERE
                          isy.`code` = inssr.inspection_str_code
                        AND inssr.del_flag = 0) AS siteCode,
                     (SELECT
                          GROUP_CONCAT(DISTINCT ic.major_code)
                      FROM
                          inspection_str_rel insr
                              LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                              LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
                      WHERE
                          insr.inspection_str_code = isy.`code`) AS professionCode,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT csm.major_name)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_major csm ON ic.major_code = csm.major_code
                       WHERE
                           insr.inspection_str_code = isy.`code` ) AS professionName,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT ic.subsystem_code)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
                       WHERE
                           insr.inspection_str_code = isy.`code`) AS subsystemCode,
                     ( SELECT
                           GROUP_CONCAT(DISTINCT css.system_name)
                       FROM
                           inspection_str_rel insr
                               LEFT JOIN inspection_code ic on ic.`code`= insr.inspection_sta_code
                               LEFT JOIN cs_subsystem css ON ic.subsystem_code = css.system_code
                       WHERE
                           insr.inspection_str_code = isy.`code` ) AS subsystemName
              FROM inspection_strategy isy
              WHERE isy.del_flag = 0
            ) AS abc
        WHERE
            1 = 1
    </select>
    <select id="getId" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
        SELECT insy.*,( SELECT GROUP_CONCAT(e.depart_name) FROM inspection_str_org_rel isor
        LEFT JOIN sys_depart e ON isor.org_code = e.org_code  WHERE  isor.inspection_str_code= insy.`code`
        AND isor.del_flag = 0   ) AS mechanismName,
               ( SELECT GROUP_CONCAT(f.station_name) FROM  inspection_str_sta_rel issr
                 LEFT JOIN cs_station f ON issr.station_code = f.station_code
                 WHERE issr.inspection_str_code=insy.`code` AND issr.del_flag = 0 ) AS siteName,
               ( SELECT GROUP_CONCAT(e.org_code) FROM inspection_str_org_rel isor
                 LEFT JOIN sys_depart e ON isor.org_code = e.org_code  WHERE  isor.inspection_str_code= insy.`code`
                AND isor.del_flag = 0) AS mechanismCode,
               ( SELECT GROUP_CONCAT(f.station_code) FROM  inspection_str_sta_rel issr
                 LEFT JOIN cs_station f ON issr.station_code = f.station_code
                 WHERE issr.inspection_str_code=insy.`code` AND issr.del_flag = 0 ) AS siteCode,
               ( SELECT GROUP_CONCAT(isr.inspection_sta_code) FROM  inspection_code ic
                 LEFT JOIN inspection_str_rel isr on ic.`code` =isr.inspection_sta_code
                 WHERE isr.inspection_str_code = insy.`code`  AND isr.del_flag = 0 ) AS codes
        FROM inspection_strategy insy
        WHERE
            insy.del_flag=0
          and insy.id = #{id}
    </select>
    <select id="selectbyCodes" resultType="com.aiurt.boot.manager.dto.InspectionCodeDTO">
        select a.*,b.major_name as professionName, c.system_name as subsystemName ,d.name as deviceTypeName
        from inspection_code  a
        left join cs_major b on a.major_code =b.major_code
        left join cs_subsystem c on a.subsystem_code =c.system_code
        left join device_type d on a.device_type_code =d.code
        where a.del_flag =0 and a.`code` in
        <foreach collection="codes" open="(" close=")"  index="index"   separator="," item="codes">
            #{codes}
        </foreach>
    </select>
    <select id="viewDetails" resultType="com.aiurt.modules.device.entity.Device">
        SELECT a.* FROM device a
         LEFT JOIN inspection_str_device_rel b on a.`code`=b.device_code
         WHERE b.inspection_str_rel_id= #{id}
    </select>

    <select id="selectCodeList" resultType="com.aiurt.boot.strategy.dto.InspectionStrategyDTO">
         SELECT
	       t3.major_code as professionCode,
	       t3.subsystem_code as subsystemCode,
           t3.id as standardId,
           t3.title as standardName
         FROM
	       inspection_strategy t1
	     LEFT JOIN inspection_str_rel t2 ON t1.`code` = t2.inspection_str_code
	     LEFT JOIN inspection_code t3 ON t2.inspection_sta_code = t3.`code`
        <where>
                t1.id = #{strategyId}
            <if test="majorCode!=null">
                and t3.major_code= #{majorCode}
            </if>
            <if test="subsystemCode!=null">
                and t3.subsystem_code = #{subsystemCode}
            </if>
        </where>
    GROUP BY t2.inspection_sta_code
    </select>
</mapper>
