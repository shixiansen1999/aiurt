<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.fault.mapper.FaultRepairRecordMapper">
    <select id="queryRecordByFaultCode" resultType="com.aiurt.modules.fault.dto.RepairRecordDetailDTO" parameterType="java.lang.String">
        select
            a.id,
            a.processing,
            a.appoint_user_name,
            su.realname as appoint_real_name,
            a.work_type,
            a.plan_order_code,
            a.solve_status,
            if(a.solve_status =1,'已解决','未解决') as solve_status_name,
            if(a.recevice_time is null, a.assign_time, a.recevice_time) as recevice_time,
            a.start_time,
            a.end_time,
            a.arrive_time,
            a.file_path,
            a.fault_analysis,
            a.fault_phenomenon,
            a.maintenance_measures,
            a.sign_path,
            a.work_ticket_code,
            a.work_tick_path,
            a.symptoms
        from
        fault_repair_record a
        LEFT JOIN sys_user su on a.appoint_user_name = su.username
        where a.fault_code = #{faultCode} order by a.create_time desc
    </select>

    <select id="getRecordByFaultCode" resultType="com.aiurt.modules.fault.dto.RepairRecordDetailDTO">
        select
        a.maintenance_measures,
        su.realname as appoint_real_name
        from
        fault_repair_record a
        LEFT JOIN sys_user su on a.appoint_user_name = su.username
        where a.fault_code = #{faultCode} and a.solve_status = 1 order by a.create_time desc
    </select>

    <select id="getTodayRecord" resultType="com.aiurt.modules.fault.entity.FaultRepairRecord">
        SELECT frr.symptoms,frr.appoint_user_name,frr.fault_code,frr.solve_status
        FROM
        fault_repair_record frr
        LEFT JOIN fault_repair_participants frp ON frr.id = frp.fault_repair_record_id
        <where>
        frr.del_flag = 0
        AND  DATE_FORMAT(frr.arrive_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
        AND  DATE_FORMAT(frr.arrive_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
        <if test="userNames != null and userNames.size() != 0">
            and ( frr.appoint_user_name or frp.user_name in
                <foreach collection="userNames" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>)
        </if>
        </where>
        group by frr.fault_code
    </select>

    <select id="getTodayFault" resultType="com.aiurt.modules.fault.entity.Fault">
        select result.*
        from
            (
                select
                f.code,f.line_code,f.station_code,f.symptoms,f.appoint_user_name,f.status
                from fault f
                LEFT JOIN fault_repair_record frr on f.code = frr.fault_code and frr.del_flag = 0
                <where>
                    f.status = 12
                    AND  DATE_FORMAT(f.end_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
                    AND  DATE_FORMAT(f.end_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
                    <if test="userNames != null and userNames.size() != 0">
                        and frr.appoint_user_name  in
                        <foreach collection="userNames" item="item" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if>
                </where>
                union all
                select
                f.code,f.line_code,f.station_code,f.symptoms,f.appoint_user_name,f.status
                from fault f
                LEFT JOIN fault_repair_record frr on f.code = frr.fault_code and frr.del_flag = 0
                <where>
                    f.status != 12 and f.status != 0
                    <if test="userNames != null and userNames.size() != 0">
                        and frr.appoint_user_name  in
                        <foreach collection="userNames" item="item" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if>
                </where>
                    ) as result
        group by result.code
    </select>
</mapper>
