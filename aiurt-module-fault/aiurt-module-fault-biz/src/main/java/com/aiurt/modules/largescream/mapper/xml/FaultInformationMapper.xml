<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aiurt.modules.largescream.mapper.FaultInformationMapper">
<insert id="insertSystemReliability">
INSERT INTO reliability_work_time(`id`, `line_code`, `system_code`, `should_work_time`) VALUES (null, #{workTime.lineCode}, #{workTime.systemCode}, null);
</insert>
    <select id="queryLargeFaultInformation" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
             status > 2
            <if test="startDate!=null and endDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode !=''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryLargeFaultInformationUnSo" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
            status != 12 and status > 2
            <if test="startDate!=null and endDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode != ''">
                and line_code  = #{lineCode}
            </if>
        </where>
    </select>

    <select id="queryLargeFaultInformationTodaySolve" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
            status = 12
            <if test="todayStartDate!=null and todayEndDate!=null">
                and date_format(end_time ,'%Y-%m-%d') &gt;=  date_format(#{todayStartDate},'%Y-%m-%d')
                and date_format(end_time ,'%Y-%m-%d') &lt;= date_format(#{todayEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode !=''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryFaultDataInformationWeekSolve" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
            status = 12
            <if test="weekStartDate!=null and weekEndDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{weekStartDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{weekEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode !=''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryLargeFaultInformationTodayAdd" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
            status > 2
            <if test="todayStartDate!=null and todayEndDate!=null">
                and date_format(happen_time ,'%Y-%m-%d') &gt;=  date_format(#{todayStartDate},'%Y-%m-%d')
                and date_format(happen_time ,'%Y-%m-%d') &lt;= date_format(#{todayEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode !=''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryFaultDataInformationWeekAdd" resultType="com.aiurt.modules.fault.entity.Fault">
        select id from fault
        <where>
            status > 2
            <if test="weekStartDate!=null and weekEndDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{weekStartDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{weekEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode !=''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getLargeFaultDatails" resultType="com.aiurt.modules.fault.dto.FaultLargeInfoDTO">
        select *,f.fault_phenomenon from fault f
        left join cs_subsystem cs on cs.system_code = f.sub_system_code
        left join  cs_line cl on cl.line_code = f.line_code
        left join cs_station ct on ct.station_code = f.station_code and ct.del_flag = 0
        left join sys_user s on s.username = f.appoint_user_name
        <where>
            f.status > 2
            <if test="condition.startDate!=null and condition.endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{condition.endDate},'%Y-%m-%d')
            </if>
            <if test="condition.lineCode != null and condition.lineCode != ''">
                and f.line_code  = #{condition.lineCode}
            </if>
            <if test="condition.majors != null and condition.majors.size>0 ">
                and f.major_code in
                <foreach collection="condition.majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="condition.unSo !=null and condition.unSo !=''">
                and f.status != 12
            </if>
            <if test="condition.unSo !=null and condition.unSo !=''">
                and f.status > 2
            </if>
            <if test="condition.todayAdd != null and condition.todayAdd !=''">
                and date_format(f.happen_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.todayStartDate},'%Y-%m-%d')
                and date_format(f.happen_time ,'%Y-%m-%d') &lt;= date_format(#{condition.todayEndDate},'%Y-%m-%d')
            </if>
            <if test="condition.todayAdd != null and condition.todayAdd !=''">
                and f.status > 2
            </if>
            <if test="condition.todaySolve != null and condition.todaySolve !=''">
                and f.status = 12
            </if>
            <if test=" condition.todaySolve != null and condition.todaySolve !=''">
                and date_format(f.end_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.todayStartDate},'%Y-%m-%d')
                and date_format(f.end_time ,'%Y-%m-%d') &lt;= date_format(#{condition.todayEndDate},'%Y-%m-%d')
            </if>
        </where>
         group by f.id
    </select>

    <select id="getLargeFaultDataDatails" resultType="com.aiurt.modules.fault.dto.FaultLargeInfoDTO">
        select f.id, f.sub_system_code, cs.system_name, f.fault_mode_code, f.station_code, ct.station_name,
        f.happen_time, f.appoint_user_name, s.realname as real_name, f.status, f.fault_phenomenon, f.line_code
        from fault f
        left join cs_subsystem cs on cs.system_code = f.sub_system_code
        left join  cs_line cl on cl.line_code = f.line_code
        left join cs_station ct on ct.station_code = f.station_code
        left join sys_user s on s.username = f.appoint_user_name
        <where>
            f.status > 2
            <if test="condition.lineCode != null and condition.lineCode != ''">
                and f.line_code  = #{condition.lineCode}
            </if>
            <if test="condition.majors != null and condition.majors.size>0 ">
                and f.major_code in
                <foreach collection="condition.majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="condition.unSo !=null and condition.unSo !=''">
                and f.status != 12
            </if>
            <if test="condition.unSo !=null and condition.unSo !=''">
                and f.status > 2
            </if>
            <if test="condition.weekAdd != null and condition.weekAdd !=''">
                and date_format(f.happen_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.startDate},'%Y-%m-%d')
                and date_format(f.happen_time ,'%Y-%m-%d') &lt;= date_format(#{condition.endDate},'%Y-%m-%d')
            </if>
            <if test="condition.moonSolve != null and condition.moonSolve !=''">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{condition.endDate},'%Y-%m-%d')
            </if>
            <if test="condition.weekAdd != null and condition.weekAdd !=''">
                and f.status > 2
            </if>
            <if test="condition.weekSolve != null and condition.weekSolve !=''">
                and f.status = 12
            </if>
            <if test=" condition.weekSolve != null and condition.weekSolve !=''">
                and date_format(f.end_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.startDate},'%Y-%m-%d')
                and date_format(f.end_time ,'%Y-%m-%d') &lt;= date_format(#{condition.endDate},'%Y-%m-%d')
            </if>
            <if test="condition.todayAdd != null and condition.todayAdd !=''">
                and date_format(f.happen_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.todayStartDate},'%Y-%m-%d')
                and date_format(f.happen_time ,'%Y-%m-%d') &lt;= date_format(#{condition.todayEndDate},'%Y-%m-%d')
            </if>
            <if test="condition.todayAdd != null and condition.todayAdd !=''">
                and f.status > 2
            </if>
            <if test="condition.todaySolve != null and condition.todaySolve !=''">
                and f.status = 12
            </if>
            <if test=" condition.todaySolve != null and condition.todaySolve !=''">
                and date_format(f.end_time ,'%Y-%m-%d') &gt;=  date_format(#{condition.todayStartDate},'%Y-%m-%d')
                and date_format(f.end_time ,'%Y-%m-%d') &lt;= date_format(#{condition.todayEndDate},'%Y-%m-%d')
            </if>
        </where>
        group by f.id
    </select>

    <select id="getLargeFaultInfo" resultType="com.aiurt.modules.fault.dto.FaultLargeInfoDTO">
        select * from fault f
            left join cs_subsystem cs on cs.system_code = f.sub_system_code
            left join  cs_line cl on cl.line_code = f.line_code
            left join cs_station ct on ct.station_code = f.station_code
            left join sys_user s on s.username = f.appoint_user_name
        <where>
            f.status > 2
            <if test="startDate!=null and endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        group by f.id
    </select>

    <select id="getLargeFaultDataInfo" resultType="com.aiurt.modules.fault.dto.FaultDataAnalysisInfoDTO">
        select * from fault f
        left join cs_subsystem cs on cs.system_code = f.sub_system_code
        left join  cs_line cl on cl.line_code = f.line_code
        left join cs_station ct on ct.station_code = f.station_code
        left join sys_user s on s.username = f.appoint_user_name
        <where>
            f.status > 2
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
            <if test="startDate!=null and endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        group by f.id
    </select>

    <select id="getLargeLineFaultInfo" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault f
        <where>
            f.status > 2
            <if test="startDate!=null and endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
        </where>
    </select>

    <select id="getYearFault" resultType="java.lang.Integer">
        select count(*) from fault where 1=1 and approval_pass_time  is not null
        <if test="condition.firstDay != null and condition.firstDay != ''">
            and DATE_FORMAT(approval_pass_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{condition.firstDay},'%Y-%m-%d')
        </if>
        <if test="condition.lastDay != null and condition.lastDay != ''">
            and DATE_FORMAT(approval_pass_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{condition.lastDay},'%Y-%m-%d')
        </if>
        <if test="condition.lineCode != null and condition.lineCode != ''">
            and line_code  = #{condition.lineCode}
        </if>
        <if test="condition.subSystemCode != null and condition.subSystemCode != ''">
            and sub_system_code  = #{condition.subSystemCode}
        </if>
        <if test="condition.faultModeCode != null and condition.faultModeCode != ''">
            and fault_mode_code  = #{condition.faultModeCode}
        </if>
        <if test="condition.status != null">
            and status  = #{condition.status}
        </if>
        <if test="condition.majorCodes != null and condition.majorCodes.size() != 0">
            and major_code in
            <foreach collection="condition.majorCodes" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="getAllSystemCode" resultType="com.aiurt.modules.fault.dto.FaultDataStatisticsDTO">
        SELECT
                system_code AS subSystemCode,
                system_name AS subSystemName,
                shortened_form AS shortenedForm
        FROM
                cs_subsystem
        WHERE
                del_flag = 0
        <if test="majorCodes != null and majorCodes.size() != 0">
            and major_code in
            <foreach collection="majorCodes" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </if>
    </select>


    <select id="getLargeFaultTime" resultType="com.aiurt.modules.fault.dto.FaultSystemTimeDTO">
        select cs.system_name, f.sub_system_code,f.line_code,
        sum(TIMESTAMPDIFF(minute,f.happen_time,f.approval_pass_time)) as repairTime  from fault f
        left join cs_subSystem cs on f.sub_system_code = cs.system_code
        <where>
            f.status > 2
            <if test="month!=null">
                and DATE_FORMAT(f.approval_pass_time,'%Y-%m') = #{month}
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        group by f.sub_system_code,f.line_Code
    </select>

    <select id="getLargeFaultMonthCount" resultType="com.aiurt.modules.fault.dto.FaultSystemMonthCountDTO">
        SELECT cs.system_name, f.sub_system_code,f.line_code,count(*) as frequency
        FROM fault f
            LEFT JOIN cs_subsystem cs ON f.sub_system_code = cs.system_code
        <where>
            f.status > 2
            <if test="month != null">
                and DATE_FORMAT(f.approval_pass_time,'%Y-%m') = #{month}
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        group by f.sub_system_code,f.line_Code
    </select>

    <select id="getSystemFaultSum" resultType="com.aiurt.modules.fault.dto.FaultSystemTimesDTO">
        select cs.system_name,f.sub_system_code,f.line_code,f.happen_time,f.end_time,
        sum(TIMESTAMPDIFF(minute,f.happen_time,f.end_time)) as repairTime  from fault f
        left join cs_subSystem cs on f.sub_system_code = cs.system_code
        <where>
            f.status > 2
            <if test="startDate!=null and endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code =#{lineCode}
            </if>
        </where>
        group by f.sub_system_code
    </select>

    <select id="getSystemDeviceSum" resultType="com.aiurt.modules.fault.dto.FaultSystemDeviceSumDTO">
        select cs.system_name,d.system_code,d.code,d.major_code,d.name,count(code) as deviceNumber
        from device d
        left join cs_subSystem cs on d.system_code = cs.system_code
        <where>
            d.scrap_flag = 0
            <if test="majors != null and majors.size>0 ">
                and d.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        group by d.system_code
    </select>

    <select id="getLineSystem" resultType="com.aiurt.modules.fault.dto.FaultSystemDeviceSumDTO">
        select
            rwt.line_code as lineCode,
            rwt.system_code as systemCode,
            cs.system_name as systemName,
            cs.shortened_form as shortenedForm,
            rwt.should_work_time as shouldWorkTime
         from reliability_work_time rwt
         left join cs_subSystem cs  on rwt.system_code = cs.system_code
        <where>
            cs.del_flag = 0
            <if test="systemCode != null and systemCode.size>0 ">
                and rwt.system_code in
                <foreach collection="systemCode" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="lineCode != null and lineCode != ''">
                and rwt.line_code  = #{lineCode}
            </if>
        </where>
        group by rwt.system_code
    </select>

    <select id="queryFaultDataInformation" resultType="com.aiurt.modules.fault.entity.Fault">
        select * from fault
        <where>
            status > 2
            <if test="weekStartDate!=null and weekEndDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{weekStartDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{weekEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode != ''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getFaultData" resultType="com.aiurt.modules.fault.dto.FaultTimeoutLevelDTO">
        select f.*,fk.name as faultPhenomenonTypeName
        from fault f
        left join fault_knowledge_base_type fk on f.fault_phenomenon = fk.code
        <where>
            <if test="level == 1">
                AND f.status &lt;&gt; 12
                and TIMESTAMPDIFF(HOUR,f.happen_time,now()) &gt;=#{lv1hours}
            </if>
            <if test="level == 2">
                AND f.status &lt;&gt; 12
                and TIMESTAMPDIFF(HOUR,f.happen_time,now()) &gt;=#{lv2hours}
                and TIMESTAMPDIFF(HOUR,f.happen_time,now()) &lt; #{lv1hours}
            </if>
            <if test="level == 3">
                AND f.status &lt;&gt; 12
                and TIMESTAMPDIFF(HOUR,f.happen_time,now()) &gt;=#{lv3hours}
                and TIMESTAMPDIFF(HOUR,f.happen_time,now()) &lt; #{lv2hours}
            </if>
            <if test="lineCode != null and lineCode != ''">
                and f.line_code  = #{lineCode}
            </if>
            <if test="startDate!=null and endDate!=null">
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{startDate},'%Y-%m-%d')
                and date_format(f.approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{endDate},'%Y-%m-%d')
            </if>
            <if test="majors != null and majors.size>0 ">
                and f.major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getFaultParticipantsDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
        select s.id as userId,
               s.realname,
               frp.user_name,
               f.approval_pass_time,
               fr.recevice_time,
               fr.end_time,
               fr.assign_time,
        IFNUll(sum(fr.repair_duration),0) as duration
        FROM
        fault_repair_participants frp
        LEFT JOIN sys_user s ON s.username = frp.user_name
        LEFT JOIN fault f ON f.CODE = frp.fault_code
        left join fault_repair_record fr  on fr.id = frp.fault_repair_record_id
        <where>
           fr.del_flag = 0
        <if test="startTime != null and endTime != null">
            AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
        </if>
        </where>
        group by s.id
    </select>

    <select id="getFaultUserDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
        select
        s.id as userId,
        s.realname,
        fr.appoint_user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        IFNUll(sum(fr.repair_duration),0) as duration
        from  fault_repair_record  fr
        left join sys_user s on s.username = fr.appoint_user_name
        left join  fault f on f.code = fr.fault_code
        <where>
            fr.del_flag = 0
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
        group by s.id
    </select>

    <select id="getFaultByIdDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
        select
        s.id as userId,
        s.realname,
        fr.id as taskId,
        fr.appoint_user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        IFNULL(sum(fr.repair_duration),0) AS duration
        from  fault_repair_record  fr
        left join sys_user s on s.username = fr.appoint_user_name
        left join  fault f on f.code = fr.fault_code
        <where>
            fr.del_flag = 0
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="userList != null and userList.size() != 0">
                and s.id in
                <foreach collection="userList" item="item" open="(" separator="," close=")">
                    #{item.id}
                </foreach>
            </if>
        </where>
        group by fr.id
    </select>

    <select id="getParticipantsDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
        select
        f.STATUS,
        fr.id as taskId,
        s.id as userid,
        s.realname,
        frp.user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        IFNULL(sum(fr.repair_duration),0) AS duration
        FROM
        fault_repair_participants frp
        LEFT JOIN sys_user s ON s.username = frp.user_name
        LEFT JOIN fault f ON f.CODE = frp.fault_code
        left join fault_repair_record fr  on fr.id = frp.fault_repair_record_id
        <where>
            fr.del_flag = 0
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="userList != null and userList.size() != 0">
                and s.id in
                <foreach collection="userList" item="item" open="(" separator="," close=")">
                    #{item.id}
                </foreach>
            </if>
        </where>
        group by fr.id
    </select>

    <select id="getFaultOrgReport" resultType="com.aiurt.modules.fault.dto.FaultReportDTO">
        select
        IFNULL( sum( f.repair_duration), 0 ) AS num,
        count(f.id) as num1
        from
        fault f
        left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
        where 1=1
        and f.status > 2
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
        AND  sd.id = #{orgId}
    </select>
    <select id="getConstructionHours" resultType="java.lang.String">
        select  assort_time from t_work_log
        where del_flag = 0
        and assort_time is not null
         and assort_time != " "
        and confirm_status=1
        and org_id = #{orgId}
        and date_format(submit_time ,'%Y-%m-%d')  BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
    </select>
    <select id="getFaultUserReport" resultType="com.aiurt.modules.fault.dto.FaultReportDTO">
        select
        s.id as userId,
        IFNULL(sum(fr.repair_duration),0) as duration,
        count(f.id) as num1
        from
        fault f
        left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
        left join fault_repair_record  fr on f.code = fr.fault_code
        left join sys_user s on s.username = fr.appoint_user_name and s.org_code = f.sys_org_code
        where 1=1
        and f.status > 2
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
        AND  s.id = #{userId}
    </select>
    <select id="getUserConstructionHours" resultType="java.lang.String">
        select  assort_time
        from t_work_log
        where del_flag = 0
          and confirm_status = 1
          and assort_time is not null
          and assort_time != " "
          and assort_ids LIKE concat('%', #{userId}, '%')
          and date_format(submit_time ,'%Y-%m-%d')  BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
    </select>
    <select id="getUserConstructorsNum" resultType="com.aiurt.modules.fault.dto.FaultReportDTO">
        select
        IFNULL(count(id),0) as constructorsNum,
        IFNULL(count(id),0) as num1
        from t_work_log
        where del_flag = 0
          and confirm_status = 1
          and assort_ids LIKE concat('%', #{userId}, '%')
          and date_format(submit_time ,'%Y-%m-%d')  BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
    </select>
    <select id="getUserTime" resultType="com.aiurt.modules.fault.dto.UserTimeDTO">
        select s.id as userId, fr.id as frrId
        from  sys_user s
                 left join fault_repair_record  fr on  s.username = fr.appoint_user_name and fr.del_flag = 0
                 left join  fault f on f.code = fr.fault_code
        where
           s.del_flag = 0 and s.org_id = #{orgId}
          AND date_format(f.approval_pass_time ,'%Y-%m-%d') BETWEEN date_format(#{startTime} ,'%Y-%m-%d') AND date_format(#{endTime} ,'%Y-%m-%d')
        group by s.id,fr.id
    </select>
    <select id="getAccompanyTime" resultType="com.aiurt.modules.fault.dto.UserTimeDTO">
        select
        s.id as userId,
        IFNULL(sum(fr.repair_duration),0) as duration
        from
        fault f
        left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
        left join fault_repair_record  fr on f.code = fr.fault_code
        left join fault_repair_participants frp on frp.fault_repair_record_id = fr.id and frp.user_name != fr.appoint_user_name
        left join sys_user s on s.username = frp.user_name and s.org_code = f.sys_org_code
        where 1=1
        and f.status > 2
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
        AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
        AND  sd.id = #{orgId}
        group by s.id
    </select>
    <select id="getUserTimes" resultType="java.lang.Integer">
        select
            IFNULL(sum(fr.repair_duration),0) as duration
        from  sys_user s
                  left join fault_repair_participants frp on s.username = frp.user_name
                  left join fault_repair_record  fr on frp.fault_repair_record_id = fr.id  and fr.del_flag = 0 and s.username != fr.appoint_user_name
                  left join  fault f on f.code = fr.fault_code
        where
            s.del_flag = 0 and s.id = #{userId}
          AND date_format(f.happen_time ,'%Y-%m-%d') BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
    </select>
    <select id="getConstructorsNum" resultType="java.lang.Integer">
        SELECT
            COUNT(twl.id) as constructorsNum
        from sys_depart sd
                 left join  sys_user s on  s.org_code = sd.org_code
                 left join t_work_log twl on  s.id in (twl.assort_ids)  and twl.del_flag = 0 and twl.confirm_status=1
        where
            sd.del_flag =0
          and sd.id =#{orgId}
          and date_format(twl.submit_time ,'%Y-%m-%d')  BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
    </select>

    <select id="getSumWorkTime" resultType="java.lang.String">
			SELECT SUM(should_work_time) from reliability_work_time rwt WHERE system_code = #{systemCode}
    </select>

    <select id="countFaultDataInformation" resultType="com.aiurt.modules.fault.dto.FaultDataAnalysisCountDTO">
        SELECT count(*) as sum ,COUNT( CASE WHEN `status` !=12 and `status` >2 THEN 1 ELSE NULL END ) AS `un_solve` from fault
        <where>
            status > 2
            <if test="weekStartDate!=null and weekEndDate!=null">
                and date_format(approval_pass_time ,'%Y-%m-%d') &gt;=  date_format(#{weekStartDate},'%Y-%m-%d')
                and date_format(approval_pass_time ,'%Y-%m-%d') &lt;= date_format(#{weekEndDate},'%Y-%m-%d')
            </if>
            <if test="lineCode != null and lineCode != ''">
                and line_code  = #{lineCode}
            </if>
            <if test="majors != null and majors.size>0 ">
                and major_code in
                <foreach collection="majors" item="item" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
    <select id="getFilterFaultUserDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
  select
        s.id as userId,
        s.realname,
        fr.appoint_user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        IFNUll(sum(fr.repair_duration),0)as duration
        from  fault_repair_record  fr
        left join sys_user s on s.username = fr.appoint_user_name
        left join  fault f on f.code = fr.fault_code and f.hang_up_time is null
        <where>
            <!--not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
        </where>
        group by s.id
</select>
<select id="getFilterFaultParticipantsDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
    select s.id as userId,
               s.realname,
               frp.user_name,
               f.approval_pass_time,
               fr.recevice_time,
               fr.end_time,
               fr.assign_time,
        IFNUll(sum(fr.repair_duration) ,0)as duration
        FROM
        fault_repair_participants frp
        LEFT JOIN sys_user s ON s.username = frp.user_name
        LEFT JOIN fault f ON f.CODE = frp.fault_code and f.hang_up_time is null
        left join fault_repair_record fr  on fr.id = frp.fault_repair_record_id
        <where>
         <!--not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
        <if test="startTime != null and endTime != null">
            AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
        </if>
        </where>
        group by s.id
</select>
<select id="getFilterFaultByIdDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
  select
        s.id as userId,
        s.realname,
        fr.id as taskId,
        fr.appoint_user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        f.hang_up_time,
        IFNULL(TIMESTAMPDIFF( SECOND, IFNULL( IFNULL( fr.recevice_time, fr.assign_time ),fr.start_time), fr.end_time ),'0') AS duration
        from  fault_repair_record  fr
        left join sys_user s on s.username = fr.appoint_user_name
        left join  fault f on f.code = fr.fault_code and f.hang_up_time is null
       <!-- LEFT JOIN operation_process op ON op.fault_code = fr.fault_code-->
        <where>
          <!-- not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="userList != null and userList.size() != 0">
                and s.id in
                <foreach collection="userList" item="item" open="(" separator="," close=")">
                    #{item.id}
                </foreach>
            </if>
        </where>
        group by fr.id
</select>
<select id="getFilterParticipantsDuration" resultType="com.aiurt.modules.largescream.model.FaultDurationTask">
  select
        f.STATUS,
        fr.id as taskId,
        s.id as userid,
        s.realname,
        frp.user_name,
        f.approval_pass_time,
        fr.recevice_time,
        fr.end_time,
        fr.assign_time,
        f.hang_up_time,
        IFNULL(TIMESTAMPDIFF( SECOND, IFNULL( IFNULL( fr.recevice_time, fr.assign_time ),fr.start_time), fr.end_time ),'0') AS duration
        FROM
        fault_repair_participants frp
        LEFT JOIN sys_user s ON s.username = frp.user_name
        LEFT JOIN fault f ON f.CODE = frp.fault_code and f.hang_up_time is null
  <!--      LEFT JOIN operation_process op ON op.fault_code = frp.fault_code-->
        left join fault_repair_record fr  on fr.id = frp.fault_repair_record_id
        <where>
     <!--        not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
            <if test="startTime != null and endTime != null">
                AND f.approval_pass_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="userList != null and userList.size() != 0">
                and s.id in
                <foreach collection="userList" item="item" open="(" separator="," close=")">
                    #{item.id}
                </foreach>
            </if>
        </where>
        group by fr.id
</select>
<select id="getFilterFaultOrgReport" resultType="com.aiurt.modules.fault.dto.FaultReportDTO">
    select
    IFNULL( sum( f.repair_duration), 0 ) AS num,
    IFNULL(count(f.id),0) as num1
    from
    fault f
    left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
    where 1=1
    and f.hang_up_time is null
    and f.status > 2
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
    AND  sd.id = #{orgId}
</select>
<select id="getFilterUserTime" resultType="com.aiurt.modules.fault.dto.UserTimeDTO">
  select s.id as userId, fr.id as frrId,
          IFNULL(sum(fr.repair_duration),0) as duration
        from  sys_user s
                 left join fault_repair_record  fr on  s.username = fr.appoint_user_name
                 left join  fault f on f.code = fr.fault_code and f.hang_up_time is null
        where
           s.del_flag = 0 and s.org_id = #{orgId}
           <!--and not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
          AND date_format(f.approval_pass_time ,'%Y-%m-%d') BETWEEN date_format(#{startTime} ,'%Y-%m-%d') AND date_format(#{endTime} ,'%Y-%m-%d')
        group by s.id,fr.id
</select>
<select id="getFilterAccompanyTime" resultType="com.aiurt.modules.fault.dto.UserTimeDTO">
    select
    s.id as userId,
    IFNULL(sum(fr.repair_duration),0) as duration
    from
    fault f
    left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
    left join fault_repair_record  fr on f.code = fr.fault_code
    left join fault_repair_participants frp on frp.fault_repair_record_id = fr.id and frp.user_name != fr.appoint_user_name
    left join sys_user s on s.username = frp.user_name and s.org_code = f.sys_org_code
    where 1=1
    and f.hang_up_time is null
    and f.status > 2
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
    AND  sd.id = #{orgId}
    group by s.id
</select>
<select id="getFilterFaultUserReport" resultType="com.aiurt.modules.fault.dto.FaultReportDTO">
    select
    s.id as userId,
    IFNULL(sum(fr.repair_duration),0) as duration,
    IFNULL(count(f.id),0) as num1
    from
    fault f
    left join sys_depart sd on f.sys_org_code = sd.org_code and sd.del_flag = 0
    left join fault_repair_record  fr on f.code = fr.fault_code
    left join sys_user s on s.username = fr.appoint_user_name and s.org_code = f.sys_org_code
    where 1=1
    and f.hang_up_time is null
    and f.status > 2
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &gt;= DATE_FORMAT(#{startTime},'%Y-%m-%d')
    AND  DATE_FORMAT(f.happen_time ,'%Y-%m-%d') &lt;= DATE_FORMAT(#{endTime},'%Y-%m-%d')
    AND  s.id = #{userId}
</select>

<select id="getFilterUserTimes" resultType="java.lang.Integer">
        select
         IFNULL(sum(fr.repair_duration),0) as duration
        from  sys_user s
                  left join fault_repair_participants frp on s.username = frp.user_name
                  left join fault_repair_record  fr on frp.fault_repair_record_id = fr.id and s.username != fr.appoint_user_name
                  left join  fault f on f.code = fr.fault_code and f.hang_up_time is null
        where
            s.del_flag = 0 and s.id = #{userId}
       <!--    and not EXISTS (select 1 from operation_process where fault_code = f.code and  process_code = 10)-->
          AND date_format(f.happen_time ,'%Y-%m-%d') BETWEEN date_format( #{startTime} ,'%Y-%m-%d') AND date_format( #{endTime} ,'%Y-%m-%d')
</select>
</mapper>
